/*
 Handling of GLU and CLR non slider form submits - apart from slider all types of form integration submit is handled
 in this file .
 Service  to collect the XML from the form fields and parse the same to convert to JSON.
 Post the Json to the service
 Handle the success and failure responses
 */
/* constants file referenced in all other files */
var submissionReturn = "";
var GLOBAL = {
    returnStatus: "",
    formStart: false,
    formComplete: false,
    /* default false before formStart */
    formAbandon: false,
    iFrameLoad: true
};
var CONSTANTS = {
    // Message options
    newPage: "New page",
    samePageFixed: "Same page-fixed",
    samePageFadeOut: "Same page-fadeout",
    sameTab: "Same Tab",
    newTab: "New Tab",
    // Slider message options
    samePagefadeOutSite: "samePage-fadeOut",
    samePagefixedSite: "samePage-fixed",
    samePageTab: "samePage",
    newPageTab: "newPage",
    newPageSite: "newPage",
    openIn: "openIn",
    // Slider site input
    contactSliderOuterCon: "contactSliderOuterCon",
    contactSideThankyou: "contactSideThankyou",
    msgDisplayType: "msgDisplayType",
    thankYouMsgUrl: "thankYouMsgUrl",
    errorMsgUrl: "errorMsgUrl",
    fadeOutTimer: "fadeOutTimer",
    // Service constants
    clr: "CLR",
    glu: "GLU",
    glucrmnext: "GLU-CRMNext",
    gluemail: "GLU-EMAIL",
    marketo: "MARKETO",
    gluemailServlet:"/bin/MLApp/FormSubmissionServlet",
    marketoServlet:"/bin/MLApp/MarketoSubmission",
    gluServlet:"/bin/MLApp/FormSubmissionServletGLU",
    emailServlet:"/bin/MLApp/FormSubmissionEmailServlet",
    campaign: "CAMPAIGN",
    // Response types
    success: "success",
    fail: "fail",
    error: "error",
    failure: "failure",
    Error: "Error",
    //General constants
    aemFormFrame: "aemFormFrame",
    no: "no",
    yes: "yes",
    formPath: "formPath",
    emptyString: "",
    firstItem: 'firstItem',
    newLine: "\n",
    form: "form",
    enctype: "enctype",
    multipart: "multipart/form-data",
    input: "input",
    ToEmailId: "ToEmailId",
    name: "name",
    value: "value",
    id: "id",
    submit: "submitButton",
    comma: ",",
    acsCommonsUrl: "/etc/acs-commons/lists",
    listJson: "jcr:content.list.json",
    vendorAppName: "vendorAppName",
    sliderTimeOut: 5000
};
var metLifeFunctions = {
    submitProcessAsyncCall: function(userInputPanel, thankYouErrorMsgPanel, guideRootPanel, aemFormID) {
        window.top.$(".gated-overlay-close-cta").addClass("hidden");
        window.top.$(".nhcalc-form-popup").addClass("thank-you-config");
        window.top.$(".form-popup").addClass("thank-you-config");
        /* Handling scroll bar for thank you or error panel	*/
        if (parent.document.getElementById(CONSTANTS.AEMFORMNAME) != null) {
            parent.document.getElementById(CONSTANTS.AEMFORMNAME).scrolling = CONSTANTS.no;
        }

        var selectedMessageOption = thankYouErrorMsgPanel.messageOptionDropDown.value;

        if (selectedMessageOption !== CONSTANTS.newPage) {
            $("#guideContainer-rootPanel-formTitlePanel___guide-item-container").hide();
            $("#guideContainer-rootPanel-userInputPanel___guide-item").fadeOut(500);
            $("#guideContainer-rootPanel-thankYouErrorMsgPanel___guide-item").fadeIn(500);
        }



        var fieldNames = customFunctions.getPanelFieldNames(userInputPanel, fieldNames, false, false);

        var uniqueID = metLifeFunctions.uniqueID();


        setTimeout(function() {
            guideBridge.getDataXML({
                success: function(guideResultObject) {

                    /* variable declaration and handling of GLU and CLR data submitted in xml */
                    var finaljsonObj = customFunctions.getJsonObjFromResultObj(guideResultObject, guideRootPanel);
                    var urlRef = CONSTANTS.emptyString;
                    var nameOfTheTemplate = guideRootPanel.hiddenPanel.nameOfTheTemplate.value;
                    finaljsonObj["nameOfTheTemplate"] = nameOfTheTemplate;
                    if (nameOfTheTemplate === CONSTANTS.clr) {
                        // Update json to truncate the zip code to 5 digit , get prod interest value in array.
                        finaljsonObj.prodInterest = finaljsonObj.prodInterest.split(CONSTANTS.comma);
                        finaljsonObj.zip = finaljsonObj.zip.substr(0, 5);
                        if ($(".quote-results-form", window.parent.document).length > 0) {
                            if (window.sessionStorage.length > 0) {
                                var string = JSON.stringify(window.sessionStorage);
                                string = string.replace(/[{()}]/g, '');
                                finaljsonObj.health = string;
                            }
                        }
                    } else if (nameOfTheTemplate === CONSTANTS.glu) {

                        if (finaljsonObj.BirthDate != undefined) {
                            var format = guideRootPanel.authorInputPanel.dateFormat.value;

                            switch (format) {
                                case "yyyy/mm/dd":
                                case "yyyy-mm-dd":
                                    var str = finaljsonObj.BirthDate;
                                    str = str.trim();
                                    var year = str.substring(0, 4);
                                    var month = str.substring(5, 7);
                                    var day = str.substring(8, 10);
                                    finaljsonObj.BirthDate = year + "-" + month + "-" + day;
                                    break;
                                case "mm/dd/yyyy":
                                case "mm-dd-yyyy":
                                    var str = finaljsonObj.BirthDate;
                                    str = str.trim();
                                    var year = str.substring(6, 10);
                                    var month = str.substring(0, 2);
                                    var day = str.substring(3, 5);
                                    finaljsonObj.BirthDate = year + "-" + month + "-" + day;
                                    break;
                                case "dd/mm/yyyy":
                                case "dd-mm-yyyy":
                                    var str = finaljsonObj.BirthDate;
                                    str = str.trim();
                                    var year = str.substring(6, 10);
                                    var month = str.substring(3, 5);
                                    var day = str.substring(0, 2);
                                    finaljsonObj.BirthDate = year + "-" + month + "-" + day;
                                    break;


                            }

                        }
                        var vendorAppName = fieldNames.search(CONSTANTS.vendorAppName);
                        if (vendorAppName > -1) {
                            var vendorAppNameValue = userInputPanel.vendorAppName.value;
                            if (vendorAppNameValue == 'CRMNext') {
                                nameOfTheTemplate = CONSTANTS.glucrmnext;
                            }
                        }
                        finaljsonObj.LanguageValue = CONSTANTS.emptyString;
                        if ($(".quote-results-form", window.parent.document).length > 0) {
                            if (window.sessionStorage.length > 0) {
                                var string = JSON.stringify(window.sessionStorage);
                                string = string.replace(/[{()}]/g, '');
                                finaljsonObj.QuoteInfo = string;
                            }
                        }
                    } else if (nameOfTheTemplate === CONSTANTS.gluemail) {

                        if (finaljsonObj.request == undefined) {
                            finaljsonObj.UniqueReferenceNumber = customFunctions.guid();
                        } else if (finaljsonObj.request != undefined) {
                            var thisId = customFunctions.guid();
                            var requestValue = finaljsonObj.request;
                            switch (requestValue) {
                                case "general":
                                    thisId = "G" + thisId;
                                    finaljsonObj.UniqueReferenceNumber = thisId;
                                    break;
                                case "feedback":
                                    thisId = "F" + thisId;
                                    finaljsonObj.UniqueReferenceNumber = thisId;
                                    break;
                                case "complaint":
                                    thisId = "C" + thisId;
                                    finaljsonObj.UniqueReferenceNumber = thisId;
                                    break;
                            }
                        }

                        if (finaljsonObj.attachmentInfo != undefined) {
                            finaljsonObj.attachmentInfo = JSON.parse(finaljsonObj.attachmentInfo);
                            guideRootPanel.systemGeneratedPanel.attachmentInfo.value = finaljsonObj.attachmentInfo;
                        }
                    }
                    if(nameOfTheTemplate == "GLU"){
                        urlRef = CONSTANTS.gluServlet;
                    }else{
                        urlRef = customFunctions.getProxyUrl("proxyConfigurations", nameOfTheTemplate);

                    }
                     var selectedMessageOption = thankYouErrorMsgPanel.messageOptionDropDown.value;

                    var targetName = thankYouErrorMsgPanel.optionThreePanel.pageTargetDropDown.value;
                    if (selectedMessageOption === CONSTANTS.samePageFadeOut || selectedMessageOption === CONSTANTS.samePageFixed) {
                        userInputPanel.visible = false;
                        thankYouErrorMsgPanel.messageOptionDropDown.visible = false;
                        thankYouErrorMsgPanel.visible = true;

                    }
                    if(nameOfTheTemplate === CONSTANTS.gluemail){
                        $.ajax({
                            url: CONSTANTS.gluemailServlet,
                            dataType: 'json',
                            data: JSON.stringify(finaljsonObj), // Error when data is empty
                            async: true,
                            type: 'POST',
                            headers: {
                                "x-csrf-token": uniqueID
                            },
                            contentType: "application/json; charset=utf-8",

                            /* handling of success in ajax response */
                            success: function(data) {
                                var response = data.result;
                                GLOBAL.returnStatus = data.result;

                                if (response === undefined) {
                                    response = data.Result;
                                    GLOBAL.returnStatus = data.Result;
                                }
                                switch (response.toLowerCase()) {
                                    case CONSTANTS.success:
                                        submissionReturn = "failure";
                                        metLifeFunctions.ajaxSucces(aemFormID, selectedMessageOption, userInputPanel, thankYouErrorMsgPanel, guideRootPanel, finaljsonObj, targetName);
                                        break;
                                    case CONSTANTS.fail:
                                    case CONSTANTS.error:
                                    case CONSTANTS.failure:
                                        // Handle Failure Thank you, Error panel configurations based on failure response
                                        //analytics function call
                                        submissionReturn = "failure";
                                        metLifeFunctions.ajaxError(aemFormID, selectedMessageOption, userInputPanel, thankYouErrorMsgPanel, guideRootPanel);

                                        break;
                                    default:
                                } // switch closed


                            }, // success closed

                            /* handling of error in ajax response */
                            error: function() {
                                GLOBAL.returnStatus = "error";
                                submissionReturn = "failure";
                                metLifeFunctions.ajaxError(aemFormID, selectedMessageOption, userInputPanel, thankYouErrorMsgPanel, guideRootPanel);
                            } //error closed
                        }); // Ajax ended
                    }else if(nameOfTheTemplate === CONSTANTS.marketo){
                        $.ajax({
                            url: CONSTANTS.marketoServlet,
                            dataType: 'json',
                            data: customFunctions.createMarketoPayload(finaljsonObj, guideRootPanel), // Error when data is empty
                            async: true,
                            type: 'POST',
                            headers: {
                                "x-csrf-token": uniqueID
                            },
                            contentType: "application/json; charset=utf-8",

                            /* handling of success in ajax response */
                            success: function(data) {
                                var response = data.result;



                                switch (response.toLowerCase()) {
                                    case CONSTANTS.success:
                                        submissionReturn = "failure";

                                        metLifeFunctions.ajaxSucces(aemFormID, selectedMessageOption, userInputPanel, thankYouErrorMsgPanel, guideRootPanel, finaljsonObj, targetName);
                                        break;
                                    case CONSTANTS.error:
                                        console.log(data.isDupe);
                                        if(data.isDupe !== undefined){
                                            if(data.isDupe=="true"){
                                                metLifeFunctions.marketoDuplicate(aemFormID, selectedMessageOption, userInputPanel, thankYouErrorMsgPanel, guideRootPanel, finaljsonObj, targetName);
                                            }
                                        }
                                        break;
                                    case "skipped":
                                        // Handle Failure Thank you, Error panel configurations based on failure response
                                       //analytics function call
                                       submissionReturn = "failure";
                                       metLifeFunctions.ajaxError(aemFormID, selectedMessageOption, userInputPanel, thankYouErrorMsgPanel, guideRootPanel);

                                       break;
                                    case CONSTANTS.failure:
                                        // Handle Failure Thank you, Error panel configurations based on failure response
                                        //analytics function call
                                        submissionReturn = "failure";
                                        metLifeFunctions.ajaxError(aemFormID, selectedMessageOption, userInputPanel, thankYouErrorMsgPanel, guideRootPanel);

                                        break;
                                    default:
                                } // switch closed

                            }, // success closed

                            /* handling of error in ajax response */
                            error: function() {
                                GLOBAL.returnStatus = "error";
                                submissionReturn = "failure";
                                metLifeFunctions.ajaxError(aemFormID, selectedMessageOption, userInputPanel, thankYouErrorMsgPanel, guideRootPanel);
                            } //error closed
                        });
                    }else{
                        $.ajax({
                            url: urlRef,
                            dataType: 'json',
                            data: JSON.stringify(finaljsonObj), // Error when data is empty
                            async: true,
                            type: 'POST',
                            headers: {
                                "x-csrf-token": uniqueID
                            },
                            contentType: "application/json; charset=utf-8",

                            /* handling of success in ajax response */
                            success: function(data) {
                                var response = data.result;
                                GLOBAL.returnStatus = data.result;

                                if (response === undefined) {
                                    response = data.Result;
                                    GLOBAL.returnStatus = data.Result;
                                }
                                switch (response.toLowerCase()) {
                                    case CONSTANTS.success:
                                        submissionReturn = "failure";
                                        metLifeFunctions.ajaxSucces(aemFormID, selectedMessageOption, userInputPanel, thankYouErrorMsgPanel, guideRootPanel, finaljsonObj, targetName);
                                        break;
                                    case CONSTANTS.fail:
                                    case CONSTANTS.error:
                                    case CONSTANTS.failure:
                                        // Handle Failure Thank you, Error panel configurations based on failure response
                                        //analytics function call
                                        submissionReturn = "failure";
                                        metLifeFunctions.ajaxError(aemFormID, selectedMessageOption, userInputPanel, thankYouErrorMsgPanel, guideRootPanel);

                                        break;
                                    default:
                                }


                            }, // success closed

                            /* handling of error in ajax response */
                            error: function() {
                                GLOBAL.returnStatus = "error";
                                submissionReturn = "failure";
                                metLifeFunctions.ajaxError(aemFormID, selectedMessageOption, userInputPanel, thankYouErrorMsgPanel, guideRootPanel);
                            } //error closed
                        }); // Ajax ended
                    }

                }, // Success guidebridge ended

                error: function(guideResultObject) {
                    if (guideResultObject.errors) {
                        thankYouErrorMsgPanel.messageOptionDropDown.visible = false;
                        thankYouErrorMsgPanel.visible = true;
                        thankYouErrorMsgPanel.optionOneTwoPanel.visible = true;
                        thankYouErrorMsgPanel.optionOneTwoPanel.errorMessage.visible = true;
                        thankYouErrorMsgPanel.optionOneTwoPanel.errorMessageText.visible = true;
                        submissionReturn = "failure";

                        setTimeout(function() {
                            $("#guideContainer-rootPanel-formTitlePanel___guide-item-container").show();
                            $("#guideContainer-rootPanel-userInputPanel___guide-item").fadeIn(500);
                            $("#guideContainer-rootPanel-thankYouErrorMsgPanel___guide-item").fadeOut(500);
                        }, 3000);
                    }
                    guideBridge._guide.logger().log("guideResultObject Logger" + guideResultObject);
                } // error guideBridge ended
            }); //Closing guideBridge.getDataXML
        }, 500); //Closing setTimeOut

    }, //Closing submitProcessAsyncCall function

    /* resetting of all the form field values on submit */
    resetForm: function(userInputPanel) {
        $('form .container').addClass("custom-web-screen-width"); //Add the custom width class to the container for page contianer
        customFunctions.resetInput(userInputPanel);
        customFunctions.resetFields(userInputPanel);
        customFunctions.resetMultiPanel(userInputPanel);
        if($('.userInputPanel select').length > 0){
            $('.userInputPanel select').trigger("change");
        }
        $(".validation-failure").removeClass("validation-failure");
        $('.guideFieldError').css('display', 'none');
        metLifeFunctions.contactFormCardSubmit();
    }, // Closing resetForm function

    /* handling of error messages and UI display on submit for same page / fixed and fade out  option */
    samePageErrorOption: function(thankYouErrorMsgPanel, userInputPanel) {
        thankYouErrorMsgPanel.optionOneTwoPanel.visible = true;
        thankYouErrorMsgPanel.optionOneTwoPanel.errorMessage.visible = true;
        thankYouErrorMsgPanel.optionOneTwoPanel.errorMessageText.visible = true;
        window.guideBridge.setFocus(thankYouErrorMsgPanel.optionOneTwoPanel.errorMessage.somExpression, CONSTANTS.firstItem, false);
        metLifeFunctions.resetForm(userInputPanel);
    },

    /* handling of success messages and UI display on submit for same page / fixed and fade out  option */
    samePageSuccessOption: function(thankYouErrorMsgPanel, userInputPanel, aemFormID) {
        thankYouErrorMsgPanel.optionOneTwoPanel.visible = true;
        thankYouErrorMsgPanel.optionOneTwoPanel.thankYouMessage.visible = true;
        thankYouErrorMsgPanel.optionOneTwoPanel.thankYouMessageText.visible = true;
        window.guideBridge.setFocus(thankYouErrorMsgPanel.optionOneTwoPanel.thankYouMessage.somExpression, CONSTANTS.firstItem, false);
        var element = parent.document.getElementById(aemFormID);
        if ($(element).closest(".gated-overlay__container", window.parent.document).length > 0) {
            var sessionStorageVariable = sessionStorage.getItem('gatedForm');
            if (sessionStorageVariable == null || sessionStorageVariable != "completed") {
                metLifeFunctions.resetForm(userInputPanel);
            }
        } else {
            metLifeFunctions.resetForm(userInputPanel);
        }


    },

    uniqueID: function() {
        function _0x59a531() {
            return Math['random']()['toString'](0x10)['slice'](-0x4);
        }

        return _0x59a531() + _0x59a531() + '-' + _0x59a531() + '-' + _0x59a531() + '-' + _0x59a531() + '-' + _0x59a531() + _0x59a531() + _0x59a531();
    },

    ajaxSucces: function(aemFormID, selectedMessageOption, userInputPanel, thankYouErrorMsgPanel, guideRootPanel, finaljsonObj, targetName){
        var redirectPage = CONSTANTS.emptyString;
        metlife_analytics_functions.onFormCompleteEvent(guideRootPanel);

        // Handle Success Thank you, Error panel configurations based on successful response
        if (selectedMessageOption === CONSTANTS.newPage) {
            $("#guideContainer-rootPanel-userInputPanel___guide-item").fadeIn(500);
            redirectPage = thankYouErrorMsgPanel.optionThreePanel.thankYouPageTextBox.value;
            metLifeFunctions.openIn(redirectPage, targetName);
            if (typeof aemFormID == 'undefined') {
                aemFormID = "aemFormFrame";
            }
            var element = parent.document.getElementById(aemFormID);
            $(element).attr('src', $(element).attr('src'));
        } else {
            var element = parent.document.getElementById(aemFormID);
            if ($(element).closest(".contactCard").find(".thank-you-overlay-parsys").length > 0) {
                $(element).closest(".contactCard").find(".thank-you-overlay-parsys").removeClass("hidden");
            }
            if ($(element).closest(".gated-overlay__container").find(".thank-you-overlay-parsys").length > 0) {
                var element = parent.document.getElementById(aemFormID);
                var aemFormElementID = $(element).closest(".gated-overlay__container").attr("id");

                var aemForms = "";
                if (sessionStorage.getItem("gatedFormSubmittedID") != null) {
                    aemForms = sessionStorage.getItem("gatedFormSubmittedID") + aemFormElementID + ",";
                } else {
                    aemForms = aemFormElementID + ",";
                }
                sessionStorage.setItem("gatedFormSubmittedID", aemForms);
                if ($(element).closest(".lead-gen-breaker").length == 0) {
                    sessionStorage.setItem("gatedForm", "completed");
                    sessionStorage.setItem("gatedFormContent", JSON.stringify(finaljsonObj));
                } else {
                    sessionStorage.setItem("leadGenBreaker", "completed");
                }
                $(element).closest(".gated-overlay__container").find(".thank-you-overlay-parsys").removeClass("hidden");
                window.top.$(".gated-overlay-close-cta").removeClass("hidden");
            }
            if($(element).closest(".component.hero-progressive-form").length > 0){
                window.top.$(element, window.parent.document).closest(".component.hero-progressive-form").find(".hero-progressive-form__rightsection .hero-progressive-form__formcontainer .hero-progressive-form__progresscontainer .hero-progressive-form__progressfields .hero-progressive-form__progressfielditem:last-child").removeClass("in-progress").addClass('completed');
            }
            if (window.top.$(".results-form__wrapper .results-form__text", window.parent.document).length > 0) {
                window.top.$(".results-form__wrapper .results-form__text", window.parent.document).hide();
                window.top.$(".results-form__wrapper .results-form__inputs", window.parent.document).addClass("full-width");
            }

            metLifeFunctions.emailSubscriptionSubmit();
            metLifeFunctions.embeddedLeadSubmit();
            metLifeFunctions.samePageSuccessOption(thankYouErrorMsgPanel, userInputPanel, aemFormID);
            if ($(element).closest(".nhcalc-form-popup").length > 0) {
                thankYouErrorMsgPanel.optionOneTwoPanel.nhpfmlthankyoupanel.visible = true;
                $(".nh-pfml-quote-restart").closest(".row > div").removeClass("hidden");
            }
            if ($(element).closest(".form-popup").length > 0) {
                console.log("in form sucess");
                thankYouErrorMsgPanel.optionOneTwoPanel.genericLoanthankyoupanel.visible = true;
                $(".generic-loan-quote-restart").closest(".row > div").removeClass("hidden");
            }
        }
    },

    marketoDuplicate: function(aemFormID, selectedMessageOption, userInputPanel, thankYouErrorMsgPanel, guideRootPanel, finaljsonObj, targetName){

        metlife_analytics_functions.onFormCompleteEvent(guideRootPanel);
        thankYouErrorMsgPanel.optionOneTwoPanel.visible = true;
        thankYouErrorMsgPanel.optionOneTwoPanel.duplicateMessage.visible = true;
        thankYouErrorMsgPanel.optionOneTwoPanel.duplicateMessageText.visible = true;
        window.guideBridge.setFocus(thankYouErrorMsgPanel.optionOneTwoPanel.duplicateMessage.somExpression, CONSTANTS.firstItem, false);
        var element = parent.document.getElementById(aemFormID);
       metLifeFunctions.resetForm(userInputPanel);
    },

    ajaxError: function(aemFormID, selectedMessageOption, userInputPanel, thankYouErrorMsgPanel, guideRootPanel){
        var redirectPage = CONSTANTS.emptyString;
        metlife_analytics_functions.onFormErrorEvent(guideRootPanel);
        if (selectedMessageOption === CONSTANTS.newPage) {
            $("#guideContainer-rootPanel-userInputPanel___guide-item").fadeIn(500);
            redirectPage = thankYouErrorMsgPanel.optionThreePanel.errorPageTextBox.value;
            metLifeFunctions.openIn(redirectPage, targetName);
        } else {
            if (window.top.$(".results-form__wrapper .results-form__text", window.parent.document).length > 0) {
                window.top.$(".results-form__wrapper .results-form__text", window.parent.document).hide();
                window.top.$(".results-form__wrapper .results-form__inputs", window.parent.document).addClass("full-width");
            }
            thankYouErrorMsgPanel.optionOneTwoPanel.visible = true;
            thankYouErrorMsgPanel.optionOneTwoPanel.errorMessage.visible = true;
            thankYouErrorMsgPanel.optionOneTwoPanel.errorMessageText.visible = true;
            window.guideBridge.setFocus(thankYouErrorMsgPanel.optionOneTwoPanel.errorMessage.somExpression, CONSTANTS.firstItem, false);
            metLifeFunctions.contactFormCardSubmit();
            metLifeFunctions.emailSubscriptionSubmit();
            if (selectedMessageOption == CONSTANTS.samePageFixed) {
                setTimeout(function() {
                    metLifeFunctions.removeErrorClass(userInputPanel, thankYouErrorMsgPanel, aemFormID);
                }, 3000);
            }
            var element = parent.document.getElementById(aemFormID);
            if ($(element).closest(".nhcalc-form-popup").length > 0) {
                window.top.$(".nhcalc-form-popup").removeClass("thank-you-config");
                 $(document, window.parent.document).scrollTop(0);
            }
            if ($(element).closest(".form-popup").length > 0) {
                window.top.$(".form-popup").removeClass("thank-you-config");
                 $(document, window.parent.document).scrollTop(0);
            }
        }
    },

    /* function to handle the window open on new page options */
    openIn: function(redirectPage, targetName) {
        var target = CONSTANTS.emptyString;

        if (targetName === CONSTANTS.sameTab) {
            target = "_parent";
        } else if (targetName === CONSTANTS.newTab) {
            target = "_blank";
        }
        window.open(redirectPage, target);
    },

    /* removes the error or sucess submit message function post time out */
    removeErrorClass: function(userInputPanel, thankYouErrorMsgPanel, aemFormID) {
        $('form .container').addClass("custom-web-screen-width");
        $("#guideContainer-rootPanel-thankYouErrorMsgPanel___guide-item").fadeOut(500);
        setTimeout(function() {
            thankYouErrorMsgPanel.optionOneTwoPanel.visible = false;
            thankYouErrorMsgPanel.optionOneTwoPanel.thankYouMessage.visible = false;
            thankYouErrorMsgPanel.optionOneTwoPanel.thankYouMessageText.visible = false;
            thankYouErrorMsgPanel.optionOneTwoPanel.errorMessage.visible = false;
            thankYouErrorMsgPanel.optionOneTwoPanel.errorMessageText.visible = false;
            if (typeof aemFormID == 'undefined') {
                aemFormID = "aemFormFrame";
            }
            var element = parent.document.getElementById(aemFormID);
            if ($(element).closest(".contactCard").find(".thank-you-overlay-parsys").length > 0) {
                $(element).closest(".contactCard").find(".thank-you-overlay-parsys").addClass("hidden");
            }
            if ($(element).closest(".gated-overlay__container").find(".thank-you-overlay-parsys").length > 0) {
                $(element).closest(".gated-overlay__container").find(".thank-you-overlay-parsys").removeClass("hidden");
            }
            if($(element).closest(".component.hero-progressive-form").length > 0){
                window.top.$(element, window.parent.document).closest(".component.hero-progressive-form").find(".hero-progressive-form__rightsection .hero-progressive-form__formcontainer .hero-progressive-form__progresscontainer .hero-progressive-form__progressfields .hero-progressive-form__progressfielditem").removeClass('completed');
            }
            metLifeFunctions.emailSubscriptionSubmit();
            metLifeFunctions.embeddedLeadSubmit();

            if (GLOBAL.returnStatus.toLowerCase() == CONSTANTS.success) {
                //reloading the iframe as the need purpose.

                var element = parent.document.getElementById(aemFormID);
                $(element).attr('src', $(element).attr('src'));
                metLifeFunctions.emailSubscriptionSubmitReset();
                metLifeFunctions.embeddedLeadSubmitReset();
            }
            if (window.top.$(".results-form__wrapper .results-form__text", window.parent.document).length > 0) {
                window.top.$(".results-form__wrapper .results-form__text", window.parent.document).show();
                window.top.$(".results-form__wrapper .results-form__inputs", window.parent.document).removeClass("full-width");
            }
        }, 500);
        if (GLOBAL.returnStatus.toLowerCase() == CONSTANTS.failure || GLOBAL.returnStatus.toLowerCase() == "error" || GLOBAL.returnStatus.toLowerCase() == CONSTANTS.fail) {
            setTimeout(function() {
                userInputPanel.visible = true;
                $("#guideContainer-rootPanel-formTitlePanel___guide-item-container").show();
                $("#guideContainer-rootPanel-userInputPanel___guide-item").fadeIn(500);
                if (window.top.$('.contact-container--form-card').length > 0) {
                    $(".contactCard .aemform-minimize", window.parent.document).removeClass("hidden-field");
                }
                if (window.top.$(".results-form__wrapper .results-form__text", window.parent.document).length > 0) {
                    window.top.$(".results-form__wrapper .results-form__text", window.parent.document).show();
                    window.top.$(".results-form__wrapper .results-form__inputs", window.parent.document).removeClass("full-width");
                }
                metLifeFunctions.emailSubscriptionSubmitReset();
            }, 500);
        }

        $(".validation-failure").removeClass("validation-failure");
        $('.guideFieldError').css('display', 'none');
        $('.guideFieldError').css('display', 'none');
    },

    contactFormCardSubmit: function() {
        if (window.top.$('.contact-container--form-card').length > 0) {
            $(".contactCard .aemform-minimize", window.parent.document).addClass("hidden-field");
            if (window.top.window.UtilityModule.getViewport() == "mobile") {
                window.top.$('.contact-container--form-card').css('min-height', 20 + 'px');
            }
            window.top.$('html, body').animate({
                scrollTop: window.top.$('.contact-container--form-card').offset().top - 150
            }, 'fast');
        }
    },
    emailSubscriptionSubmitReset: function() {
        if (window.top.$('.email-subscription').length > 0) {
            window.top.$('.email-subscription').find(".email-subscription-container--content").removeClass("d-none");
			window.top.$(".email-subscription").find(".email-subscription-container--form").removeClass("full-width");
            window.top.$('.email-subscription').find(".email-subscription-container--form").addClass("col-md-5");
            window.top.$('.email-subscription').find(".email-subscription-container--form").addClass("col-lg-4");
            window.top.$('.email-subscription').find(".email-subscription-container--form").removeClass("offset-md-1");
        }
    },
    emailSubscriptionSubmit: function() {
        if (window.top.$('.email-subscription').length > 0) {
            window.top.$('.email-subscription').find(".email-subscription-container--content").addClass("d-none");
			window.top.$(".email-subscription").find(".email-subscription-container--form").addClass("full-width");
            window.top.$('.email-subscription').find(".email-subscription-container--form").removeClass("col-md-5");
            window.top.$('.email-subscription').find(".email-subscription-container--form").removeClass("col-lg-4");
            window.top.$('.email-subscription').find(".email-subscription-container--form").addClass("offset-md-1");
        }
    },
    embeddedLeadSubmit: function() {
        if (window.top.$('.embedded-lead-form').length > 0) {
            $(".aemformcontainer").addClass("form-complete");
            window.top.$('.embedded-lead-form').find(".embedded-title-container").addClass("d-none");
            window.top.$('.embedded-lead-form').find(".embedded-form-content-container").addClass("form-complete");
            if (window.top.$('.embedded-lead-form').find(".single-column-form").length > 0) {
                window.top.$('.embedded-lead-form').find(".single-column-form.col-12").removeClass("col-md-6");
                window.top.$('.embedded-lead-form').find(".single-column-form.col-12").addClass("col-md-9");
                window.top.$('.embedded-lead-form').find(".single-column-form.col-12").addClass("offset-md-2");
            }
            if (window.top.$('.embedded-lead-form').find(".embedded-form-container-complete").length > 0) {
                window.top.$('.embedded-lead-form').find(".embedded-form-container-complete").removeClass("d-none");
                $('form .container').addClass("embedded-form-container-extra-content");
            }
        }
    },
    embeddedLeadSubmitReset: function() {
        if (window.top.$('.embedded-lead-form').length > 0) {
            $(".aemformcontainer").removeClass("form-complete");
            window.top.$('.embedded-lead-form').find(".embedded-title-container").removeClass("d-none");
            window.top.$('.embedded-lead-form').find(".embedded-form-content-container").removeClass("form-complete");

            if (window.top.$('.embedded-lead-form').find(".single-column-form").length > 0) {
                window.top.$('.embedded-lead-form').find(".single-column-form.col-12").addClass("col-md-6");
                window.top.$('.embedded-lead-form').find(".single-column-form.col-12").removeClass("col-md-9");
                window.top.$('.embedded-lead-form').find(".single-column-form.col-12").removeClass("offset-md-2");
            }
            if (window.top.$('.embedded-lead-form').find(".embedded-form-container-complete").length > 0) {
                window.top.$('.embedded-lead-form').find(".embedded-form-container-complete").addClass("d-none");
                $('form .container').removeClass("embedded-form-container-extra-content");
            }
        }
    }
}; //Closing metLifeFunctions variable
// keyboard listener for tabbing
function keyboardListener(evt) {
    if (evt.keyCode === 9) {
        $("body").addClass("keyboard-active");
        $(document).off("keydown", keyboardListener);
        $(window.parent.document).off("keydown", keyboardListener);
        $(document).on("mousedown", mouseListener);
        $(window.parent.document).on("mousedown", mouseListener);
    }
}

// mouse listener for clicking
function mouseListener() {
    $("body").removeClass("keyboard-active");
    $(document).off("mousedown", mouseListener);
    $(window.parent.document).off("mousedown", mouseListener);
    $(document).on("keydown", keyboardListener);
    $(window.parent.document).on("keydown", keyboardListener);
}

function gmapsAutoCompleteInit(className, countryCode) {
    var googleautocomplete;
    var options = {};

    if (countryCode !== undefined) {
        var options = {
            types: ['address'],
            componentRestrictions: {
                country: countryCode
            }
        };
    }

    googleautocomplete = new google.maps.places.Autocomplete(document.getElementsByClassName(className)[0], options);

    google.maps.event.addListener(googleautocomplete, 'place_changed', function () {
        var place = googleautocomplete.getPlace();
        for (var i = 0; i < place.address_components.length; i++) {
            for (var j = 0; j < place.address_components[i].types.length; j++) {
                if (place.address_components[i].types[j] == "postal_code") {

                    var som = document.getElementsByClassName(className)[0].getAttribute("somexp");
                    var googleMapsTextField = window.guideBridge.resolveNode(som);
                    googleMapsTextField.value = place.formatted_address;
                }
            }
        }

    });


}

function heightAdjusterForRoundIconButton() {
	if($('.round-icon__button').length > 0) {
		var roundIconButtonComponent = $('.guideFieldNode.round-icon__button');
		roundIconButtonComponent.each(function() {
            $(this).find('.guideCheckBoxItem.round-icon__button, .guideRadioButtonItem.round-icon__button').removeAttr('tabindex');
			var titleHeight;
            $(this).find(".guideCheckBoxItem.round-icon__button, .guideRadioButtonItem.round-icon__button").each(function() {
                if($(this).find('.round-icon__button__title').length > 0) {
                    titleHeight = $(this).find('.round-icon__button__title').outerHeight();
                    $(this).css("margin-bottom", titleHeight + 30);
                } else {
                    $(this).css('margin-bottom', 30);
                }
            });
		});
	}
}

function nhpfmlCalcButtonSuccess(){
    $(".nhpfml-next-button.run-quote button").show();
    $(".ball-loader").hide();
}

function nhpmflCalculation(guideRootPanel){

     guideBridge.getDataXML({
             success: function(guideResultObject) {


                console.log($(".ball-loader").length)
                console.log("inside xml");
                 /* variable declaration and handling of GLU and CLR data submitted in xml */
                 var finaljsonObj = customFunctions.getJsonObjFromResultObj(guideResultObject, guideRootPanel);
                 var uniqueID = metLifeFunctions.uniqueID();
                 if (finaljsonObj.attachmentInfo != undefined) {
                     finaljsonObj.attachmentInfo = JSON.parse(finaljsonObj.attachmentInfo);

                 }

                $.ajax({
                        url: "/bin/MLApp/nhinsurancecalc",
                        data: JSON.stringify(finaljsonObj),
                        dataType: "json",
                        type: "POST",
                        headers: {
                            "x-csrf-token": uniqueID
                        },
                        contentType: "application/json; charset=utf-8",
                         beforeSend: function() {
                                // setting a timeout
                                $(".nhpfml-next-button.run-quote button").hide();
                                $(".ball-loader").show();
                                $(".quote-results").remove();
                                $(".bet-tax-credit-section").remove();
                            },
                        success: function (data) {
                            var response = data.status;
                            var censusPanel = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].userInputPanel[0].census_panel[0]");
                            var planPanel = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].userInputPanel[0].panel_plan[0]");
                            if (data.status == "success") {
                                console.log(data)
                                var sixWeekHtml = "<div class='quote-results'>";
                                sixWeekHtml+="<div class='quote-row premium-row'><div class='description'>Monthly Premium<sup>3</sup>: </div><div class='premium value'>$"+ Number(data['6-week-premium']).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0})+"</div></div>";
                                sixWeekHtml+="<div class='quote-row'><div class='description'>Employees covered: </div><div class=' value'>"+Number(data['totalEmployees']).toLocaleString()+"</div></div>";
                                sixWeekHtml+="<div class='quote-row'><div class='description'>Employer contribution: </div><div class=' value'>"+parseInt(data['employerContribution'])+"%</div></div>";
                                sixWeekHtml+="<div class='quote-row'><div class='description'>Estimated Annual net cost for employer<sup>4</sup>: </div><div class=' value'>$"+Number(data['6-week-annual-net-employer-cost']).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0})+"</div></div>";
                                sixWeekHtml+="<div class='quote-row'><div class='description'>Illustrative Rate<sup>5</sup>:</div><div class=' value'>$"+Number(data['nh-pfml-rate-6-week']).toFixed(2)+"<span> per 100$</span></div></div>";
                                sixWeekHtml+="<div class='quote-row tax-credit'><div class='description'>Estimated Potential business tax credit<sup>6</sup>: </div><div class=' value'>$"+Number(data['6-week-tax-credit']).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0})+"</div></div>";
                                sixWeekHtml += "</div>"


                                var twelveWeekHtml = "<div class='quote-results'>";
                                twelveWeekHtml+="<div class='quote-row premium-row'><div class='description'>Monthly Premium<sup>3</sup>: </div><div class='premium value'>$"+Number(data['12-week-premium']).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0})+"</div></div>";
                                twelveWeekHtml+="<div class='quote-row'><div class='description'>Employees covered: </div><div class=' value'>"+Number(data['totalEmployees']).toLocaleString()+"</div></div>";
                               twelveWeekHtml+="<div class='quote-row'><div class='description'>Employer contribution: </div><div class=' value'>"+parseInt(data['employerContribution'])+"%</div></div>";
                               twelveWeekHtml+="<div class='quote-row'><div class='description'>Estimated Annual net cost for employer<sup>4</sup>: </div><div class=' value'>$"+parseInt(data['12-week-annual-net-employer-cost']).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0})+"</div></div>";
                                twelveWeekHtml+="<div class='quote-row'><div class='description'>Illustrative rate<sup>5</sup>: </div><div class=' value'>$"+Number(data['nh-pfml-rate-12-week']).toFixed(2)+"<span> per 100$</span></div></div>";
                                twelveWeekHtml+="<div class='quote-row tax-credit'><div class='description'>Estimated Potential business tax credit<sup>6</sup>: </div><div class=' value'>$"+Number(data['12-week-tax-credit']).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0})+"</div></div>";
                                twelveWeekHtml += "</div>"



                                $(".guideRadioButtonItem.nh-pfml-plan-option:nth-child(1) .guideWidgetLabel").after(sixWeekHtml);
                                if($(".guideRadioButtonItem.nh-pfml-plan-option:nth-child(1) .guideWidgetLabel label sup").length == 0){
                                    var firstLabelHTML = "<span>"+$(".guideRadioButtonItem.nh-pfml-plan-option:nth-child(1) .guideWidgetLabel label").text()+"<sup>2</sup></span>";
                                    $(".guideRadioButtonItem.nh-pfml-plan-option:nth-child(1) .guideWidgetLabel label").html(firstLabelHTML);
                                }

                                $(".guideRadioButtonItem.nh-pfml-plan-option:nth-child(2) .guideWidgetLabel").after(twelveWeekHtml);
                                if($(".guideRadioButtonItem.nh-pfml-plan-option:nth-child(2) .guideWidgetLabel label sup").length == 0){
                                    var secondLabelHTML = "<span>"+$(".guideRadioButtonItem.nh-pfml-plan-option:nth-child(2) .guideWidgetLabel label").text()+"<sup>2</sup></span>";
                                    $(".guideRadioButtonItem.nh-pfml-plan-option:nth-child(2) .guideWidgetLabel label").html(secondLabelHTML);
                                }

                                var string = JSON.stringify(data);
                                string = string.replace(/[{()}]/g, '');
                                guideRootPanel.systemGeneratedPanel.QuoteInfo.value = string;
                                $(".nh-pfml-census-text.census-error").closest(".col-md-12").addClass("hidden");
                                censusPanel.visible=false;
                                planPanel.visible=true;


                                var ldo = {
                                eventName: 'formStep',
                                attributes: {
                                  form: customFunctions.getFormId(),
                                  stepName: "About Workforce"
                                }
                              };
                               parent.digitalData.eventTrack('formStep', ldo);

                            }else{
                                $(".nh-pfml-census-text.census-error").closest(".col-md-12").removeClass("hidden");
                                $(".nh-pfml-census-text.census-error p").text(data["errorMessage"]);
                                window.top.$(".current-page-count").text(parseInt(window.top.$(".current-page-count").text())-1);
                                  var percentage = 100*(parseInt(window.top.$(".current-page-count").text())/parseInt(window.top.$(".end-page-count").text()));
                                  window.top.$(".nhcal-form-popup_progressbar_total").css("width", percentage+"%");
                                  $('.nhcalc-form-popup', window.parent.document).animate({ scrollTop: 0 }, "slow");
                            }

                        },
                        error: function() {
                            GLOBAL.returnStatus = "error";
                            submissionReturn = "failure";
                            window.top.$(".current-page-count").text(parseInt(window.top.$(".current-page-count").text())-1);
                          var percentage = 100*(parseInt(window.top.$(".current-page-count").text())/parseInt(window.top.$(".end-page-count").text()));
                          window.top.$(".nhcal-form-popup_progressbar_total").css("width", percentage+"%");
                          $('.nhcalc-form-popup', window.parent.document).animate({ scrollTop: 0 }, "slow");
                        },
                        complete: function() {
                            nhpfmlCalcButtonSuccess();
                            $('.nhcalc-form-popup', window.parent.document).animate({ scrollTop: 0 }, "slow");
                        }
                    });



             }, // Success guidebridge ended

             error: function(guideResultObject) {

             } // error guideBridge ended
     }); //Closing guideBridge.getDataXML

}

function nhpmflCalculationIndividual(guideRootPanel){

     guideBridge.getDataXML({
             success: function(guideResultObject) {


                console.log($(".ball-loader").length)
                console.log("inside xml");
                 /* variable declaration and handling of GLU and CLR data submitted in xml */
                 var finaljsonObj = customFunctions.getJsonObjFromResultObj(guideResultObject, guideRootPanel);
                 var uniqueID = metLifeFunctions.uniqueID();

                $.ajax({
                        url: "/bin/MLApp/nhinsurancecalc",
                        data: JSON.stringify(finaljsonObj),
                        dataType: "json",
                        type: "POST",
                        headers: {
                            "x-csrf-token": uniqueID
                        },
                        contentType: "application/json; charset=utf-8",
                         beforeSend: function() {
                                // setting a timeout
                                $(".nhpfml-next-button.run-quote button").hide();
                                $(".ball-loader").show();
                                $(".quote-results").remove();
                            },
                        success: function (data) {
                            var response = data.status;
                            var censusPanel = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].userInputPanel[0].census_panel[0]");
                            var planPanel = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].userInputPanel[0].panel_plan[0]");
                            if (data.status == "success") {
                                console.log(data)
                                if($(".run-quote.individual.salary-check").length == 0 && Number(data['6-week-premium-weekly']).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2}) <= 3.00){
                                    $(".run-quote.individual").addClass("salary-check");
                                    $(".salary-check").closest(".col-md-12").removeClass("hidden");
                                    $(".run-quote.individual button").text("Proceed With My Quote");
                                    window.top.$(".current-page-count").text(parseInt(window.top.$(".current-page-count").text())-1);
                                    var percentage = 100*(parseInt(window.top.$(".current-page-count").text())/parseInt(window.top.$(".end-page-count").text()));
                                    window.top.$(".nhcal-form-popup_progressbar_total").css("width", percentage+"%");
                                }else{
                                    $(".salary-check").closest(".col-md-12").addClass("hidden");
                                    $(".run-quote.individual").removeClass("salary-check");
                                    $(".run-quote.individual button").text("Calculate");
                                    var sixWeekHtml = "<div class='quote-results individual'>";
                                    sixWeekHtml+="<div class='individual-header'>6 weeks of NH PFML coverage per year</div>";
                                    sixWeekHtml+="<div class='individual-premium-header'>Your weekly premium is</div>";
                                    sixWeekHtml+="<div class='individual-premium-value'>$"+ Number(data['6-week-premium-weekly']).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2})+"</div>";
                                    sixWeekHtml+="<div class='individual-premium-header'>If billed monthly, your payment is</div>";
                                    sixWeekHtml+="<div class='individual-premium-value'>$"+ Number(data['6-week-premium']).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2})+"</div>";

                                    sixWeekHtml += "</div>"



                                    $(".indiviual-plan-card").after(sixWeekHtml);

                                    guideRootPanel.authorInputPanel.PFLRate.value = Number(data['PFLRate']).toFixed(2);
                                    guideRootPanel.authorInputPanel.PMLRate.value = Number(data['PMLRate']).toFixed(2);
                                    var string = JSON.stringify(data);
                                    string = string.replace(/[{()}]/g, '');
                                    guideRootPanel.systemGeneratedPanel.QuoteInfo.value = string;
                                    $(".nh-pfml-census-text.census-error").closest(".col-md-12").addClass("hidden");
                                    censusPanel.visible=false;
                                    planPanel.visible=true;


                                    var ldo = {
                                    eventName: 'formStep',
                                    attributes: {
                                      form: customFunctions.getFormId(),
                                      stepName: "About Employer"
                                    }
                                  };
                                   parent.digitalData.eventTrack('formStep', ldo);
                                   $('.nhcalc-form-popup', window.parent.document).animate({ scrollTop: 0 }, "slow");
                                   $(".nhpfml-next-button.run-quote button").show();
                                   $(".nhpfml-next-button.run-quote button").closest(".col-md-12").removeClass("hidden");
                                }


                            }else{
                                $(".nh-pfml-census-text.census-error").closest(".col-md-12").removeClass("hidden");
                                $(".nh-pfml-census-text.census-error p").text(data["errorMessage"]);
                                window.top.$(".current-page-count").text(parseInt(window.top.$(".current-page-count").text())-1);
                                  var percentage = 100*(parseInt(window.top.$(".current-page-count").text())/parseInt(window.top.$(".end-page-count").text()));
                                  window.top.$(".nhcal-form-popup_progressbar_total").css("width", percentage+"%");
                                  $('.nhcalc-form-popup', window.parent.document).animate({ scrollTop: 0 }, "slow");
                            }

                        },
                        error: function() {
                            GLOBAL.returnStatus = "error";
                            submissionReturn = "failure";
                            window.top.$(".current-page-count").text(parseInt(window.top.$(".current-page-count").text())-1);
                          var percentage = 100*(parseInt(window.top.$(".current-page-count").text())/parseInt(window.top.$(".end-page-count").text()));
                          window.top.$(".nhcal-form-popup_progressbar_total").css("width", percentage+"%");
                          $('.nhcalc-form-popup', window.parent.document).animate({ scrollTop: 0 }, "slow");
                        },
                        complete: function() {
                            nhpfmlCalcButtonSuccess();
                        }
                    });



             }, // Success guidebridge ended

             error: function(guideResultObject) {

             } // error guideBridge ended
     }); //Closing guideBridge.getDataXML

}

$(document).ready(function () {
	$(document).on('keydown', function() {
        $(".keyboard-active .guideimagechoice .guideFieldNode.round-icon__button .guideCheckBoxGroupItems.guideFieldIcon-size__large .guideCheckBoxItem .guideFieldWidget input[type='checkbox'], .keyboard-active .guideimagechoice .guideFieldNode.round-icon__button .guideRadioButtonGroupItems.guideFieldIcon-size__large .guideRadioButtonItem .guideFieldWidget input[type='radio']").on('focusin', function() {
			$(this).closest('.guideCheckBoxItem, .guideRadioButtonItem').addClass('element-focused');
		}).on('focusout', function() {
			$(this).closest('.guideCheckBoxItem, .guideRadioButtonItem').removeClass('element-focused');
		});
    });
	/* Form Counter/Numeric Stepper JS Code Starts */
	if($(".numeric-stepper-counter").length>0){

        $(".numeric-stepper-counter").each(function() {
            var setMin = $(this).find(".ui-spinner-down");
            var setMax = $(this).find(".ui-spinner-up");
            var counterValue = $(this).find(".ui-spinner-input");
			var countername = $(this).find(".ui-spinner-input").attr("countername");
            var subcopy = $(this).find(".ui-spinner-input").attr("subcopy");
            var labelAfter = $(this).find(".ui-spinner-input").parent().parent().parent().find(".guideFieldLabel.top");
            var spinner = $(this).find("span.ui-spinner");
            $(setMin).prependTo(spinner);
			setMin.attr("tabindex",0);
            setMax.attr("tabindex",0);

            if(countername.length){
				var counterString = $('<span />').addClass('counter-name').html(countername);
                $(counterString).insertAfter(counterValue);
            }

            if(subcopy.length){
				var subCopy = $('<span />').addClass('counter-sub-copy').html(subcopy);
                $(subCopy).insertAfter(labelAfter);
            }

            setMin.on("click", function(){
                setMax.removeClass("disabled");
                if(parseInt(setMin.parent().find(".ui-spinner-input").attr("aria-valuenow")) <= setMin.parent().find(".ui-spinner-input").attr("min")){
                    setMin.addClass("disabled");
                }
                else {
                    setMin.removeClass("disabled");
                }
            });

            setMax.on("click", function(){
				setMin.removeClass("disabled");
                if(parseInt(setMax.parent().find(".ui-spinner-input").attr("aria-valuenow")) >= setMax.parent().find(".ui-spinner-input").attr("max")){
                    setMax.addClass("disabled");
                }else {
                    setMax.removeClass("disabled");
                }
            });

            counterValue.on('input',function(e){
                if(parseInt(counterValue.val()) > parseInt(counterValue.attr("min")) && parseInt(counterValue.val()) < parseInt(counterValue.attr("max"))){
					setMin.removeClass("disabled");
                    setMax.removeClass("disabled");
                }
                if(parseInt(counterValue.val()) <= parseInt(counterValue.attr("min"))) {
					setMin.addClass("disabled");
                    setMax.removeClass("disabled")
                }
                if(parseInt(counterValue.val()) >= parseInt(counterValue.attr("max"))) {
					setMax.addClass("disabled");
                    setMin.removeClass("disabled");
                }
            })

		})

        $(".numeric-stepper-counter").find(".ui-spinner-down").mousedown(function(event) {
            if (event.which == 3) {
                event.preventDefault();
                event.stopPropagation();
            }
        });

        $(".numeric-stepper-counter").find(".ui-spinner-up").mousedown(function(event) {
            if (event.which == 3) {
                event.preventDefault();
                event.stopPropagation();
            }
        });

        $(".numeric-stepper-counter").find(".ui-spinner-down").keydown(function(event) {
            if (event.which == 13) {
                if(parseInt($(this).parent().find(".ui-spinner-input").val())  > parseInt($(this).parent().find(".ui-spinner-input").attr("min"))) {
                    $(this).removeClass("disabled");
                    $(this).parent().find(".ui-spinner-up").removeClass("disabled");
                    var counterInputValue = parseInt($(this).parent().find(".ui-spinner-input").val()) - parseInt($(this).parent().find(".ui-spinner-input").attr("step"));
                    if(counterInputValue > parseInt($(this).parent().find(".ui-spinner-input").attr("min"))) {
						$(this).parent().find(".ui-spinner-input").val(counterInputValue);
                    }else {
						$(this).parent().find(".ui-spinner-input").val(parseInt($(this).parent().find(".ui-spinner-input").attr("min")));
                    }
                }
                if(parseInt($(this).parent().find(".ui-spinner-input").val()) <= parseInt($(this).parent().find(".ui-spinner-input").attr("min"))) {
                    $(this).addClass("disabled");
                }
            }

        });

        $(".numeric-stepper-counter").find(".ui-spinner-up").keydown(function(event) {
            if (event.which == 13) {
                if(parseInt($(this).parent().find(".ui-spinner-input").val()) < parseInt($(this).parent().find(".ui-spinner-input").attr("max"))){
					$(this).removeClass("disabled");
                    $(this).parent().find(".ui-spinner-down").removeClass("disabled");
                    var counterInputValue = parseInt($(this).parent().find(".ui-spinner-input").val()) + parseInt($(this).parent().find(".ui-spinner-input").attr("step"));
                    if(counterInputValue < parseInt($(this).parent().find(".ui-spinner-input").attr("max"))) {
						$(this).parent().find(".ui-spinner-input").val(counterInputValue);
                    }else {
						$(this).parent().find(".ui-spinner-input").val(parseInt($(this).parent().find(".ui-spinner-input").attr("max")));
                    }
                }
                if(parseInt($(this).parent().find(".ui-spinner-input").val()) >= parseInt($(this).parent().find(".ui-spinner-input").attr("max"))){
					$(this).addClass("disabled");
                }
            }
        });

    }
	/* Form Counter/Numeric Stepper JS Code Ends */

	/* Form Passowrd Code Starts */
    if($(".guidePasswordBox.masked-input-password").length>0){
        var showAriaLabel = $(".guidePasswordBox.masked-input-password").find("input").attr("showlabel");
        var hideAriaLabel = $(".guidePasswordBox.masked-input-password").find("input").attr("hidelabel");
        $(".guidePasswordBox.masked-input-password").each(function() {
            var eyeIcon = $('<a href="javascript:void(0);" tabindex="0" aria-live="polite" aria-hidden="true" aria-label="'+showAriaLabel+'"/>').addClass('not-visible').html("");
            var passWordInput = $(this).find("input").parent();
            $(eyeIcon).insertAfter(passWordInput);
        });

        $(".guidePasswordBox.masked-input-password").find(".not-visible").on("click", function() {
            $(this).toggleClass("visible");
            if($(this).hasClass("visible")) {
            	$(this).parent().find("input").attr("type","text");
                $(this).attr("aria-hidden","false");
                $(this).attr("aria-label",hideAriaLabel);
            }else {
				$(this).parent().find("input").attr("type","password");
                $(this).attr("aria-hidden","true");
                $(this).attr("aria-label",showAriaLabel);
             }
        });

    }
    /* Form Passowrd Code Ends */

    if ($(".guideHelpQuestionMark").length > 0) {
        $(".guideHelpQuestionMark").each(function () {
            var fieldContainer = $(this).siblings(".guideFieldWidget");
            $(this).appendTo(fieldContainer);
			$(this).attr("aria-expanded","false");
        });
    }

    $("body").on("click", ".masked-input.hide-icon", function (evt) {
        $(this).removeClass("hide-icon");
        $(this).addClass("show-icon");
        $(this).closest(".textField").find("input").attr("type", "password");

    });

    $("body").on("keyup", ".masked-input.hide-icon", function (evt) {
        if (evt.keyCode == 13 || evt.keyCode == 32) {
            $(this).removeClass("hide-icon");
            $(this).addClass("show-icon");
            $(this).closest(".textField").find("input").attr("type", "password");
        }

    });

    $("body").on("click", ".masked-input.show-icon", function (evt) {
        $(this).removeClass("show-icon");
        $(this).addClass("hide-icon");
        $(this).closest(".textField").find("input").attr("type", "text");

    });

    $("body").on("keyup", ".masked-input.show-icon", function (evt) {
        if (evt.keyCode == 13 || evt.keyCode == 32) {
            $(this).removeClass("show-icon");
            $(this).addClass("hide-icon");
            $(this).closest(".textField").find("input").attr("type", "text");
        }

    });

    $("input[type='radio']").focus(function () {
        var parent = $(this).closest(".guideRadioButtonItem");
        parent.find("label").addClass("in-focus");
    });
    $("input[type='radio']").blur(function () {
        var parent = $(this).closest(".guideRadioButtonItem");
        parent.find("label").removeClass("in-focus");
    });
    $("input[type='checkbox']").focus(function () {
        var parent = $(this).closest(".guideCheckBoxItem");
        parent.find("label").addClass("in-focus");
    });
    $("input[type='checkbox']").blur(function () {
        var parent = $(this).closest(".guideCheckBoxItem");
        parent.find("label").removeClass("in-focus");
    });

    $(document).on("keydown", keyboardListener);
    $(window.parent.document).on("keydown", keyboardListener);

    $(".js-input-googlemaps").each(function () {
        var countryCode = $(this).attr("data-country-code");
        gmapsAutoCompleteInit("js-input-googlemaps", countryCode);
        $(this).closest(".guidetextbox-google-maps ").addClass("guidetextbox");
    });

    if ($("#fdtheme-id-clientlibs link[href*='conversational-form-theme']").length > 0) {
        $(".aemformcontainer").addClass("convo-form-theme");
    }

    if ($("#fdtheme-id-clientlibs link[href*='nh-microsite-calculator-theme']").length > 0 || $("#fdtheme-id-clientlibs link[href*='generic-loan-calc']").length > 0) {
        $(".aemformcontainer").addClass("nh-pfml-calc-theme");
        $(".nh-pfml-state").each(function(){
            $(this).find("label").addClass("focus-state");
        });
        $(".SourceInfo").each(function(){
            $(this).find("label").addClass("focus-state");
        });

        $(".afRadioButtonItem.nh-pfml-plan-option").click(function(){
            $(this).find(".guideWidgetLabel.right").trigger("click")

        });

        $(".nhpfml-next-button.run-quote").append("<div class='ball-loader'><div class='ball-loader-ball ball1'></div><div class='ball-loader-ball ball2'></div><div class='ball-loader-ball ball3'></div></div>");
        $(".ball-loader").hide();
        $(".generic-loan-next button").on("click",function(){
            if($(".validation-failure").length == 0){
                window.top.$(".current-page-count").text(parseInt(window.top.$(".current-page-count").text())+1);
                window.top.$(".form-popup__container").addClass("convo-padding");
                window.top.$(".form-popup_error").addClass("hidden");
                var spacing = window.top.$(".form-popup_header").outerHeight();
                window.top.$(".form-popup ").css("padding-top", spacing + "px");
                var percentage = 100*(parseInt(window.top.$(".current-page-count").text())/parseInt(window.top.$(".end-page-count").text()));
                window.top.$(".form-popup_progressbar_total").css("width", percentage+"%");
                 var stepNameVariable = '';


                if(!$(this).closest(".nhpfml-next-button").hasClass("run-quote")){
                        var ldo = {
                        eventName: 'formStep',
                        attributes: {
                          form: customFunctions.getFormId(),
                          stepName: "next loan step"
                        }
                      };
                       parent.digitalData.eventTrack('formStep', ldo);
                       $('.form-popup', window.parent.document).animate({ scrollTop: 0 }, "slow");
                }

            }else{
                window.top.$(".form-popup_error").removeClass("hidden");
                var spacing = window.top.$(".form-popup_header").outerHeight();
                window.top.$(".form-popup").css("padding-top", spacing + "px");
            }

        });
        $(".nhpfml-next-button button").on("click",function(){
            if($(".validation-failure").length == 0){
                window.top.$(".current-page-count").text(parseInt(window.top.$(".current-page-count").text())+1);
                window.top.$(".nhcalc-form-popup__container").addClass("convo-padding");
                window.top.$(".nhcalc-form-popup_error").addClass("hidden");
                var spacing = window.top.$(".nhcalc-form-popup-header").outerHeight();
                window.top.$(".nhcalc-form-popup").css("padding-top", spacing + "px");
                var percentage = 100*(parseInt(window.top.$(".current-page-count").text())/parseInt(window.top.$(".end-page-count").text()));
                window.top.$(".nhcal-form-popup_progressbar_total").css("width", percentage+"%");
                 var stepNameVariable = '';
                 if($(this).closest(".nhpfml-next-button").hasClass("about-business")){
                    stepNameVariable="About Business"
                 }else if($(this).closest(".nhpfml-next-button").hasClass("about-yourself")){
                    stepNameVariable="About Yourself"
                 }else{
                    stepNameVariable="Review Quote"
                 }

                if(!$(this).closest(".nhpfml-next-button").hasClass("run-quote")){
                        var ldo = {
                        eventName: 'formStep',
                        attributes: {
                          form: customFunctions.getFormId(),
                          stepName: stepNameVariable
                        }
                      };
                       parent.digitalData.eventTrack('formStep', ldo);
                       $('.nhcalc-form-popup', window.parent.document).animate({ scrollTop: 0 }, "slow");
                }

            }else{
                window.top.$(".nhcalc-form-popup_error").removeClass("hidden");
                var spacing = window.top.$(".nhcalc-form-popup-header").outerHeight();
                window.top.$(".nhcalc-form-popup").css("padding-top", spacing + "px");
            }

        });

        $(".convo-back-button button").on("click",function(){
              if($(".validation-failure").length == 0){
                 if($('.nhcalc-form-popup', window.parent.document).length > 0){
                    window.top.$(".current-page-count").text(parseInt(window.top.$(".current-page-count").text())-1);
                      if(parseInt(window.top.$(".current-page-count").text()) == 1){
                        window.top.$(".form-popup__container").removeClass("convo-padding");

                      }
                      var percentage = 100*(parseInt(window.top.$(".current-page-count").text())/parseInt(window.top.$(".end-page-count").text()));
                      window.top.$(".nhcal-form-popup_progressbar_total").css("width", percentage+"%");
                      $('.nhcalc-form-popup', window.parent.document).animate({ scrollTop: 0 }, "slow");
                 }else{
                    window.top.$(".current-page-count").text(parseInt(window.top.$(".current-page-count").text())-1);
                    if(parseInt(window.top.$(".current-page-count").text()) == 1){
                      window.top.$(".nhcalc-form-popup__container").removeClass("convo-padding");

                    }
                    var percentage = 100*(parseInt(window.top.$(".current-page-count").text())/parseInt(window.top.$(".end-page-count").text()));
                    window.top.$(".form-popup_progressbar_total").css("width", percentage+"%");
                    $('.form-popup', window.parent.document).animate({ scrollTop: 0 }, "slow");
                 }

              }

          });

        $(".print-button-pfml button").on("click",function(){
           var ldo = {
             eventName: 'linkClick',
             attributes: {
               form: customFunctions.getFormId(),
               stepName: "Review Quote",
               linkName: "Print"
             }
           };
            parent.digitalData.eventTrack('linkClick', ldo);
           window.print();
           return false;



        });

        $(".nh-pfml-download-link").on("click",function(){
             var ldo = {
                eventName: 'linkClick',
                attributes: {
                  form: 'NH PFML Calculator',
                  stepName: "About Workforce",
                  linkName: "Download Census Form"
                }
              };
               parent.digitalData.eventTrack('linkClick', ldo);

        });

        $(".nh-pfml-quote-restart").on("click", function(){
            var src = window.top.$(".aemFormFrame").attr("src");
            window.top.$(".aemFormFrame").attr("src", src);
            window.top.$(".current-page-count").text('1');
            var percentage = 100*(parseInt(window.top.$(".current-page-count").text())/parseInt(window.top.$(".end-page-count").text()));
            window.top.$(".nhcal-form-popup_progressbar_total").css("width", percentage+"%");
            window.top.$(".nhcalc-form-popup").removeClass("thank-you-config");
            $('.nhcalc-form-popup', window.parent.document).animate({ scrollTop: 0 }, "slow");
        });

        $(".generic-loan-quote-restart").on("click", function(){
            var src = window.top.$(".aemFormFrame").attr("src");
            window.top.$(".aemFormFrame").attr("src", src);
            window.top.$(".current-page-count").text('1');
            var percentage = 100*(parseInt(window.top.$(".current-page-count").text())/parseInt(window.top.$(".end-page-count").text()));
            window.top.$(".form-popup_progressbar_total").css("width", percentage+"%");
            window.top.$(".form-popup").removeClass("thank-you-config");
            $('.form-popup', window.parent.document).animate({ scrollTop: 0 }, "slow");
        });

    }

    $(".progressive-form__button button").on("click",function(){

        var thisItem;
        var nextItem;
        var analyticsStage;
        var nextOrBack = "next";

        if($(this).closest(".guideButton").hasClass("progressiveFormFirstStageNextButton")){
            thisItem = 0;
            nextItem = 1;
            analyticsStage = window.top.$(".hero-progressive-form").find(".hero-progressive-form__progressfielditem").eq(1).find(".progress-label").text().trim();
        }
        if($(this).closest(".guideButton").hasClass("progressiveFormSecondStageNextButton")){
            thisItem = 1;
            nextItem = 2;
            analyticsStage = window.top.$(".hero-progressive-form").find(".hero-progressive-form__progressfielditem").eq(2).find(".progress-label").text().trim();
        }
        if($(this).closest(".guideButton").hasClass("progressiveFormSecondStageBackButton")){
            thisItem = 0;
            nextItem = 1;
            nextOrBack = "back";
            analyticsStage = window.top.$(".hero-progressive-form").find(".hero-progressive-form__progressfielditem").eq(0).find(".progress-label").text().trim();
        }
        if($(this).closest(".guideButton").hasClass("progressiveFormThirdStageNextButton")){
            thisItem = 2;
            nextItem = 3;
            analyticsStage = window.top.$(".hero-progressive-form").find(".hero-progressive-form__progressfielditem").eq(3).find(".progress-label").text().trim();
        }
        if($(this).closest(".guideButton").hasClass("progressiveFormThirdStageBackButton")){
            thisItem = 1;
            nextItem = 2;
            nextOrBack = "back";
            analyticsStage = window.top.$(".hero-progressive-form").find(".hero-progressive-form__progressfielditem").eq(1).find(".progress-label").text().trim();
        }
        if($(this).closest(".guideButton").hasClass("progressiveFormFourthStageBackButton")){
            thisItem = 2;
            nextItem = 3;
            nextOrBack = "back";
            analyticsStage = window.top.$(".hero-progressive-form").find(".hero-progressive-form__progressfielditem").eq(2).find(".progress-label").text().trim();
        }
        var digitalDataObj = null;

        if (typeof parent.digitalData != 'undefined') {
            digitalDataObj = parent.digitalData;
        } else if (typeof digitalData != 'undefined') {
            digitalDataObj = digitalData;

        }
        if(nextOrBack == "back"){
            if($(this).closest("form").find(".validation-failure").length !== 0){
                $(this).closest("form").find(".validation-failure").removeClass("validation-failure");
                $(this).closest("form").find('.guideFieldError').css('display', 'none');
            }

            window.top.$(".hero-progressive-form").find(".hero-progressive-form__progressfielditem").eq(thisItem).removeClass('completed').find('.progress-label').attr("aria-hidden", true);
            window.top.$(".hero-progressive-form").find(".hero-progressive-form__progressfielditem").eq(thisItem).addClass("in-progress").find('.progress-label').attr("aria-hidden", false);
            window.top.$(".hero-progressive-form").find(".hero-progressive-form__progressfielditem").eq(nextItem).removeClass("in-progress");
            if (digitalDataObj != null && (typeof digitalDataObj != 'undefined')) {
                digitalDataObj.formInfo.stepName = analyticsStage
            }
            parent.digitalData.eventTrack('formStep', JSON.parse(customFunctions.getFormFieldsJSON('formStep', null)));
        }
        if($(this).closest("form").find(".validation-failure").length === 0){
            if(nextOrBack == "next"){
                window.top.$(".hero-progressive-form").find(".hero-progressive-form__progressfielditem").eq(thisItem).removeClass("in-progress").addClass('completed').find('.progress-label').attr("aria-hidden", true);
                window.top.$(".hero-progressive-form").find(".hero-progressive-form__progressfielditem").eq(nextItem).addClass("in-progress").find('.progress-label').attr("aria-hidden", false);
                if (digitalDataObj != null && (typeof digitalDataObj != 'undefined')) {
                    digitalDataObj.formInfo.stepName = analyticsStage;
                }
                parent.digitalData.eventTrack('formStep', JSON.parse(customFunctions.getFormFieldsJSON('formStep', null)));

            }

            //SUBMIT
            if($(this).closest(".guideButton").hasClass("progressiveFormSecondStageSubmitButton")){
                window.top.$(".hero-progressive-form").find(".hero-progressive-form__progressfielditem").eq(1).removeClass("in-progress").addClass('completed');
                window.top.$(".hero-progressive-form").find(".hero-progressive-form__progresscontainer").slideUp('fast');
            }

            if($(this).closest(".guideButton").hasClass("progressiveFormThirdStageSubmitButton")){
                window.top.$(".hero-progressive-form").find(".hero-progressive-form__progressfielditem").eq(2).removeClass("in-progress").addClass('completed');
                window.top.$(".hero-progressive-form").find(".hero-progressive-form__progresscontainer").slideUp('fast');
            }


            if($(this).closest(".guideButton").hasClass("progressiveFormFourthStageSubmitButton")){
                window.top.$(".hero-progressive-form").find(".hero-progressive-form__progressfielditem").eq(3).removeClass("in-progress").addClass('completed');
                window.top.$(".hero-progressive-form").find(".hero-progressive-form__progresscontainer").slideUp('fast');
            }
        }
    });
});

$(window).on("load", function () {
    if ($(".minimizedPanel").length > 0) {
        var inputs = $(".minimizedPanel").closest(".aemformcontainer").find(".minimizedBottomPanel").find('select, input, textarea, button, a');
        var lastInput = inputs.last();
        /*redirect last tab to first input*/
        lastInput.on('keydown', function (e) {
           if ((e.which === 9 && !e.shiftKey)) {
               e.preventDefault();
               window.top.$('.gated-overlay-container-minimized').find(".gated-overlay-close").focus();
           }
        });
    }

    if($("div[dir='rtl']", window.parent.document).length  > 0){
        $(".aemformcontainer").attr("dir","rtl");
    }
});

$(window).on("load resize", function () {
    if ($(".minimizedPanel").length > 0) {
        var topPadding = $(".minimizedPanel").closest(".aemformcontainer").find(".formTitlePanel").outerHeight();
        var bottomPadding = $(".minimizedPanel").closest(".aemformcontainer").find(".minimizedBottomPanel").outerHeight();
        $(".minimizedPanel").css("margin-top", topPadding + "px");
        $(".minimizedPanel").closest(".aemformcontainer").addClass("gated-overlay-minimized");
        if (window.top.$('.flyout-form').length > 0) {
            $(".minimizedPanel").closest(".aemformcontainer").addClass("gated-overlay-minimized-flyout");
        }
        $(".minimizedPanel").css("margin-bottom", bottomPadding + "px");
        var total = topPadding + bottomPadding;

        $(".minimizedPanel").css("max-height", "calc(100vh - " +total+ "px)");
    }
	heightAdjusterForRoundIconButton();
});

//multicolumn theme selection.
var formStartTimeinMiliseconds = Date.now();
var forms = new Array();
var formCustomDropDownStart = false;

// function to trigger form start on element focus changed and element value change event(checkbox and radio)
// addEventListener will register the elementFocusChanged and elementValueChanged on bridgeInitializeStart
window.addEventListener("bridgeInitializeStart", function (evnt) {
    var digitalDataObj = null;

    if (typeof parent.digitalData != 'undefined') {
        digitalDataObj = parent.digitalData;
    } else if (typeof digitalData != 'undefined') {
        digitalDataObj = digitalData;

    }
    if (digitalDataObj != null && (typeof digitalDataObj != 'undefined')) {
        guideBridge.on("elementFocusChanged", function (event, payload) {

            var node = null;

            var isTargetNotNullInUserInputPanel = false;
            try {
                node = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].authorInputPanel[0].typeOfTheme[0]");

                if (node != null && node.value === 'contactCardForm') {

                    if ((typeof payload.target != 'undefined') && (typeof payload.target.parent != 'undefined'))  {
                        var notFixedUserPanel = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].userInputPanel[0].userInputNotFixedPanel[0]");
                        if (notFixedUserPanel.visible == false) {
                            notFixedUserPanel.visible = true;
                            customFunctions.initializeCheckBoxRadioToolTips();
                        }
                        $(".contactCard .aemform-minimize", window.parent.document).removeClass("hidden-field");
                        $(".MetLifeFormHeaderH2 p").show();
                        $(".aemformcontainer .DisclaimerSectionH3").removeClass("hidden");
                    }
                }
                if ((typeof payload.target != 'undefined') && (typeof payload.target.parent != 'undefined') && (payload.target.parent.templateId.indexOf("guideContainer-rootPanel-userInputPanel") == 0 || payload.target.parent.templateId.indexOf("guideContainer-rootPanel-panel") == 0) && (CONSTANTS.submit !== payload.target.name)) {
                    isTargetNotNullInUserInputPanel = true;
                    GLOBAL.formStart = true;
                }

                var index = forms.indexOf(customFunctions.getFormId());

                if (GLOBAL.formStart && index <= -1 && typeof formCustomDropDownStart != 'underfined' && !formCustomDropDownStart) {
                    forms.push(customFunctions.getFormId());
                    metlife_analytics_functions.onFormStartEvent();
                    GLOBAL.formStart == true;
					formCustomDropDownStart = true;
                    /* formAbandon could be triggered after formStart */
                    GLOBAL.formAbandon = true;
                }
                if (isTargetNotNullInUserInputPanel && (typeof digitalDataObj != 'undefined')) {
                    if (typeof digitalDataObj.formInfo == 'undefined') {
                        digitalDataObj.formInfo = {};
                    }
                    digitalDataObj.formInfo.formName = customFunctions.getFormId();
                    digitalDataObj.formInfo.lastAccessedField = payload.target.name;
                }
            } catch (err) {
                console.log("Error in loading" + err);
            }
        });
    }
    if (digitalDataObj != null && (typeof digitalDataObj != 'undefined')) {
        guideBridge.on("elementValueChanged", function (event, payload) {
            var node = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].authorInputPanel[0].typeOfTheme[0]");
            if (node != null && node.value === 'contactCardForm') {

                if ((typeof payload.target != 'undefined') && (typeof payload.target.parent != 'undefined'))  {
                    var notFixedUserPanel = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].userInputPanel[0].userInputNotFixedPanel[0]");
                    if (notFixedUserPanel.visible == false) {
                        window.guideBridge.setFocus(window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].userInputPanel[0].userInputFixedPanel[0]").somExpression, CONSTANTS.firstItem, false);
                        notFixedUserPanel.visible = true;
                    }
                    $(".contactCard .aemform-minimize", window.parent.document).removeClass("hidden-field");
                    $(".MetLifeFormHeaderH2 p").show();
                    $(".aemformcontainer .DisclaimerSectionH3").removeClass("hidden");
                }
            }
            var isTargetNotNullInUserInputPanel = false;
            try {
                if ((typeof payload.target != 'undefined') && (typeof payload.target.parent != 'undefined') && (payload.target.parent.templateId.indexOf("guideContainer-rootPanel-userInputPanel") ==  0 || payload.target.parent.templateId.indexOf("guideContainer-rootPanel-panel") == 0 ) && (CONSTANTS.submit !== payload.target.name) && (!payload.target.isEmpty()) && (typeof payload.target.value !== 'undefined') && (typeof payload.target.value !== null) && ((payload.target.className === 'guideRadioButton') || (payload.target.className === 'guideCheckBox')) && (payload.target.value !== 'none')) {
                    isTargetNotNullInUserInputPanel = true;
                }
                var index = forms.indexOf(customFunctions.getFormId());

                if (isTargetNotNullInUserInputPanel && (index <= -1) && typeof formCustomDropDownStart != 'underfined' && !formCustomDropDownStart) {
                    //formStarted = true;
                    forms.push(customFunctions.getFormId());
                    metlife_analytics_functions.onFormStartEvent();
                    GLOBAL.formStart = true;
					formCustomDropDownStart = true;
                    /* formAbandon could be triggered after formStart */
                    GLOBAL.formAbandon = true;
                }
                if (isTargetNotNullInUserInputPanel && (typeof digitalDataObj != 'undefined')) {
                    if (typeof digitalDataObj.formInfo == 'undefined') {
                        digitalDataObj.formInfo = {};
                    }
                    digitalDataObj.formInfo.formName = customFunctions.getFormId();
                    digitalDataObj.formInfo.lastAccessedField = payload.target.name;
                }
            } catch (err) {
                console.log("Error in loading" + err);
            }
        });
    }
});

window.onload = function (e) {
    var node = null;
    var aemFormele = parent.document.getElementsByClassName("aemform");
    try {
        node = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].authorInputPanel[0].typeOfTheme[0]");
        if (node != null && node.value === 'siteComponent') {
            var iFrameEle = parent.document.getElementById("aemFormFrame");


            //remove height set during single column for heading
            $(".MetLifeFormHeaderH1 p").css('margin-top', '0');

        }

        if (!String.prototype.includes) {
            String.prototype.includes = function (search, start) {
                'use strict';
                if (typeof start !== 'number') {
                    start = 0;
                }
                if (start + search.length > this.length) {
                    return false;
                } else {
                    return this.indexOf(search, start) !== -1;
                }
            };
        }

        //apply the background-color for the entire body
        $(aemFormele).css("display", "block");

    } catch (err) {
        console.log("Error in loading" + err);
    }

    window.top.$(".aemFormFrame", window.parent.document).each(function () {
        var id = $(this).attr("id");
        window.top.$('#' + id, window.parent.document).contents().find(".submitButton").attr("data-form-frame-id", id);
    });

    window.top.$("#aemFormFrame", window.parent.document).each(function () {
        var id = $(this).attr("id");
        window.top.$('#' + id, window.parent.document).contents().find(".submitButton").attr("data-form-frame-id", id);
    });

    window.top.$(".form-bg-blue.generic_global_overlay_form .aemFormFrame", window.parent.document).each(function () {
        $(this).contents().find(".aemformcontainer").addClass("overlay-blue-background");
    });

    if (window.top.$(".gated-overlay__container", window.parent.document).length > 0) {
        var aemFormsSubmittedVariable = sessionStorage.getItem('gatedFormSubmittedID');
        var sessionStorageVariable = sessionStorage.getItem('gatedForm');
        var leadGenSessionVariable = sessionStorage.getItem('leadGenBreaker');

        if ((sessionStorageVariable != null && sessionStorageVariable == "completed") || (leadGenSessionVariable != null && leadGenSessionVariable == "completed")) {
            var aemFormsSubmitted = aemFormsSubmittedVariable.split(",");
            if (aemFormsSubmitted.length != 0) {
                for (var i = 0; i < aemFormsSubmitted.length; i++) {
                    var element = parent.document.getElementById(aemFormsSubmitted[i]);
                    $(element).find(".thank-you-overlay-parsys").removeClass("hidden");
                    $(element).find(".aemFormFrame").contents().find("#guideContainer-rootPanel-userInputPanel___guide-item").hide();
                    $(element).find(".aemFormFrame").contents().find("#guideContainer-rootPanel-formTitlePanel___guide-item").hide();
                    $(element).find(".aemFormFrame").contents().find("#guideContainer-rootPanel-thankYouErrorMsgPanel___guide-item").removeClass("hidden");
                    $(element).find(".aemFormFrame").contents().find("#guideContainer-rootPanel-thankyouerrormsgpane___guide-item").removeClass("hidden");
                    $(element).find(".aemFormFrame").contents().find("#guideContainer-rootPanel-thankyouerrormsgpane-messageOptionDropDown___guide-item").addClass("hidden");
                    $(element).find(".aemFormFrame").contents().find(".thankYouMessage").parent().parent().removeClass("hidden");
                    $(element).find(".aemFormFrame").contents().find(".thankYouMessageText").parent().parent().removeClass("hidden");
                    $(element).find(".aemFormFrame").contents().find("#guideContainer-rootPanel-thankYouErrorMsgPanel-messageOptionDropDown__").hide();

                }

            }


        }

        if (window.top.$(".lead-gen-breaker__cta").closest(".lead-gen-breaker").length > 0) {
            window.top.$(".lead-gen-breaker__cta").closest(".lead-gen-breaker").find(".aemFormFrame").removeClass("hidden");
        }
        window.top.$(".gated-overlay-close-cta").removeClass("hidden");
        window.top.$(".lead-gen-breaker__cta").on("click", function () {
            var sessionStorageVariable = sessionStorage.getItem('leadGenBreaker');
            if (sessionStorageVariable == null && sessionStorage.getItem('gatedForm') != null && sessionStorage.getItem('gatedForm') == 'completed') {
                window.top.$(".gated-overlay-close-cta").addClass("hidden");
                var elementSrc = window.top.$(".lead-gen-breaker__cta").closest(".lead-gen-breaker").find(".aemFormFrame").attr('src');
                window.top.$(".lead-gen-breaker__cta").closest(".lead-gen-breaker").find(".aemFormFrame").attr('src', elementSrc);
                window.top.$(".lead-gen-breaker__cta").closest(".lead-gen-breaker").find(".aemFormFrame").addClass("hidden");
            }

        });
    }

    customFunctions.initializeFormFields();

    $(".guideHelpQuestionMark").click(function () {

        $(this).toggleClass("active-mark");
		($(this).attr("aria-expanded") == "true") ? $(this).attr("aria-expanded","false") : $(this).attr("aria-expanded","true");
    });

    $(".tooltip-bottom").each(function () {
        if ($(this).find(".guideHelpQuestionMark").length > 0) {
            $(this).find(".guideHelpQuestionMark").addClass("hidden");
        }
        var tooltipText = $(this).find(".guideFieldDescription.short p").text().trim();
        $(this).find('.guideFieldDescription.long').addClass("tool-tip-bottom");
        $(this).find('.guideFieldError').after("<span tabindex='0' class=' tool-tip '>" + tooltipText + "</span>");
        $(this).find(".guideFieldDescription.short").remove();

    });

    $(document).on("click", ".tool-tip", function (e) {
        $(this).closest(".tooltip-bottom").find(".guideHelpQuestionMark").click();
    });

    $(document).on("keydown", ".tool-tip", function (e) {
        var key = e.which;
        if ((key == 32) || (key == 13)) {  // trigger click with the enter key or space bar
            e.preventDefault();
            $(this).closest(".tooltip-bottom").find(".guideHelpQuestionMark").click();
        }
    });


    $(document).on("click", ".tooltip-close", function (e) {
        $(this).closest(".guideFieldNode").find(".guideHelpQuestionMark").click();
    });

    $(document).on("keydown", ".tooltip-close", function (e) {
        var key = e.which;
        if ((key == 32) || (key == 13)) {  // trigger click with the enter key or space bar
            e.preventDefault();
            $(this).closest(".guideFieldNode ").find(".guideHelpQuestionMark").click();
        }
    });



    $(".aemFormFrame", window.parent.document).removeClass("hidden");
    $(document, window.parent.document).scrollTop(0);
};



/**
 * beforeunload trigger once reload page, leave page, input new url, redirect,
 * reload after form complete will not trigger digitalData.eventTrack
 **/
$(window).on('beforeunload',function(e){
     e.stopImmediatePropagation();
    /* No formAbandon if form completed */
    if (GLOBAL.formAbandon == true && GLOBAL.formComplete == false) {
       metlife_analytics_functions.onFormAbandonEvent();
    } else {
       console.log("formAbandon: " + GLOBAL.formAbandon + ", formComplete: " + GLOBAL.formComplete + ", formAbandon analytics event is not triggered");
    }
});


/**
 * iframe load event
 **/
$(".aemFormFrame", window.parent.document).on("load", function(e) {
    metlife_analytics_functions.iFrameLoadEvent();
});



var customFunctions = {

    fieldTypes: ["guideRadioButton", "guideDatePicker", "guideDropDownList", "guideFileUpload", "guideNumericBox", "guideTextBox", "guideCheckBox"],

    isField: function (item) {
        return customFunctions.fieldTypes.indexOf(item.className) > -1;
    },

    isPanel: function (item) {
        return item.className === "guidePanel" || item.className === "rootPanelNode";
    },

    isCheckBox: function (item) {
        return item.className === "guideCheckBox";
    },

    isStaticTextField: function (item) {
        if (item != null) {
            return item.className === "guideTextDraw";
        } else {
            return false;
        }
    },

    initializeCheckBoxRadioToolTips: function () {
        $(".aemformcontainer .guideradiobutton,.aemformcontainer .guidecheckbox,.aemformcontainer .guideCheckBox, .contactSideForm .guideradiobutton, .contactSideForm .guidecheckbox, .contactSideForm .guideCheckBox  ").each(function () {
            if ($(this).find(".guideFieldDescription.long").length != 0) {
                var label = $(this).find(".guideFieldLabel.top");
                var questionMark = $(this).find(".guideHelpQuestionMark");
                var labelLength = $(this).siblings(".guideFieldLabel.top").outerWidth() + 8;
                var closeButtonHtml ='<div class="tooltip-close" tabindex="0" role="button"><svg class="icon icon-close" tabindex="-1" focusable="false" ><use xmlns:xlink="http://www.w3.org/1999/xlink"xlink:href="/static/images/icons-metlife.svg#icon-close"></use></svg></div>';
                $(this).find(".guideFieldDescription.long").append(closeButtonHtml);
                $(this).find(".guideFieldDescription.long").detach().appendTo(label);
                questionMark.detach().insertBefore(label);
            }

        });

    },

    initializeFormFields: function () {

		$(".aemformcontainer input, .contactSideForm input").blur(function(){
            if($(this).val() != ""){
                  $(this).css("padding","30px 24px 16px 22px");
                  $(this).addClass("tt-rotate");
            } else {
                 $(this).css("padding","20px 24px");
                 $(this).removeClass("tt-rotate");
            }
        });

        $(".aemformcontainer input, .contactSideForm input").focus(function(){
            $(this).css("padding","30px 24px 16px 22px");
        });

        $(".aemformcontainer input[type=range], .contactSideForm input[type=range]").blur(function(){
            $(this).css("padding","0px");
        });

        $(".aemformcontainer input[type=range], .contactSideForm input[type=range]").focus(function(){
            $(this).css("padding","0px");
        });

		$(".aemformcontainer textarea, .contactSideForm textarea").blur(function(){
		  if($(this).val() != ""){
				  $(this).css("padding","30px 24px 16px 22px");
		  } else {
				 $(this).css("padding","20px 24px");
		  }
		});

		$(".aemformcontainer textarea, .contactSideForm textarea").focus(function(){
			$(this).css("padding","30px 24px 16px 22px");
		});

		$("input[type=date]").blur(function(){
		  if($(this).val() != ""){
				  $(this).css("padding","20px 24px");
		  } else {
				  $(this).css("padding","20px 24px");
		  }
		});

		$("input[type=date]").focus(function(){
					$(this).css("padding","20px 24px");
				});

        $(".aemformcontainer input, .aemformcontainer textarea, .contactSideForm input, .contactSideForm textarea").each(function () {
            if ($(this).val() != '' && $(this).val() != null) {
                $(this).closest(".guideFieldNode").find(".guideFieldLabel label").addClass("focus-state");
            }
        });

        $(".aemformcontainer input, .aemformcontainer textarea, .contactSideForm input, .contactSideForm textarea").focus(function () {
            $(this).closest(".guideFieldNode").find(".guideFieldLabel label").addClass("focus-state");
        });
        $(".aemformcontainer input,.aemformcontainer textarea, .contactSideForm input, .contactSideForm textarea").on("blur", function () {
            if ($(this).val() == '') {
                $(this).closest(".guideFieldNode").find(".guideFieldLabel label").removeClass("focus-state");
            }
        });

        $(".aemformcontainer select, .contactSideForm select").each(function () {
            var labelText = $(this).closest(".guideFieldNode").find("select option#emptyValue").text();
            $(this).closest(".guideFieldNode").find(".guideFieldLabel label").text(labelText);
            $(this).closest(".guideFieldNode").find(".guideFieldLabel label").addClass("hidden-label");
        });

        $(".aemformcontainer select, .contactSideForm select").on("focus", function () {
            $(this).addClass("select-focus");
        });
        $(".aemformcontainer select, .contactSideForm select").on("change", function () {
            if ($(this).val() != "" && $(this).val() != null && $(this).find("option:selected").text().trim() != $(this).closest(".guideFieldNode").find(".guideFieldLabel label").text()) {
                $(this).closest(".guideFieldNode").find(".guideFieldLabel label").addClass("focus-state");
                $(this).addClass("selected-state");
                $(this).closest(".guideFieldNode").find(".guideFieldLabel label").removeClass("hidden-label");

            } else if ($(this).find("option:selected").text().trim() == $(this).closest(".guideFieldNode").find(".guideFieldLabel label").text()) {
                $(this).closest(".guideFieldNode").find(".guideFieldLabel label").removeClass("focus-state");
                $(this).removeClass("selected-state");
                $(this).closest(".guideFieldNode").find(".guideFieldLabel label").addClass("hidden-label");
            }

        });
        $(".aemformcontainer select, .contactSideForm select").on("blur", function () {
            if ($(this).val() == '') {
                $(this).closest(".guideFieldNode").find(".guideFieldLabel label").removeClass("focus-state");
            }
            $(this).removeClass("select-focus");
        });

        $(".aemformcontainer input,.aemformcontainer textarea,.aemformcontainer select, .contactSideForm input, .contactSideForm textarea, .contactSideForm select").each(function () {
            var labelText = $(this).closest(".guideFieldNode").find(".guideFieldLabel label").text();
            if (labelText == null || labelText == '') {
                $(this).closest(".guideFieldNode").find(".guideFieldLabel label").addClass("noLabelText");
            }
        });

        $(".aemformcontainer textarea, .contactSideForm textarea").each(function () {
            $(this).parent().siblings(".guideFieldLabel").addClass("textarea-label");
        });

        $(".aemformcontainer .guideFieldLabel label, .contactSideForm .guideFieldLabel label").click(function () {

            if ($(this).closest(".guideFieldNode").find("select").length != 0) {
                $(this).closest(".guideFieldNode").find("select").focus();
            }
        });

        $(".aemformcontainer .mask-input-field, .contactSideForm .mask-input-field").each(function () {

            if ($(this).find(".guideHelpQuestionMark").length != 0) {
                $(this).find("input").after("<span tabindex='0' class='masked-input hide-icon'></span>");
            } else {
                $(this).find("input").after("<span tabindex='0' class='masked-input hide-icon'></span>");
            }
        });

        $(".aemformcontainer .guideradiobutton,.aemformcontainer .guidecheckbox,.aemformcontainer .guideCheckBox, .contactSideForm .guideradiobutton, .contactSideForm .guidecheckbox, .contactSideForm .guideCheckBox  ").each(function () {
            if ($(this).find(".guideFieldDescription.long").length != 0) {
                var label = $(this).find(".guideFieldLabel.top");
                var questionMark = $(this).find(".guideHelpQuestionMark");
                var labelLength = $(this).find(".guideFieldLabel.top").outerWidth() + 8;
                var closeButtonHtml ='<div class="tooltip-close" tabindex="0" role="button"><svg class="icon icon-close" tabindex="-1" focusable="false" ><use xmlns:xlink="http://www.w3.org/1999/xlink"xlink:href="/static/images/icons-metlife.svg#icon-close"></use></svg></div>';
                $(this).find(".guideFieldDescription.long").append(closeButtonHtml);
                $(this).find(".guideFieldDescription.long").detach().appendTo(label);
                questionMark.detach().insertBefore(label);
            }
        });

        $(".aemformcontainer input, .aemformcontainer textarea, .contactSideForm input, .contactSideForm textarea, .aemformcontainer select, .contactSideForm select").each(function () {
            var parent = $(this).closest(".guideFieldNode");
            if (parent.find(".guideFieldDescription.long").length != 0) {
                var errorMessage = parent.find(".guideFieldError");
				var closeButtonLabel = parent.find(".guideFieldDescription.short").text();
                var closeButtonHtml ='<div class="tooltip-close" tabindex="0" role="button" aria-label='+closeButtonLabel+'><svg class="icon icon-close" tabindex="-1" focusable="false" ><use xmlns:xlink="http://www.w3.org/1999/xlink"xlink:href="/static/images/icons-metlife.svg#icon-close"></use></svg></div>';
                parent.find(".guideFieldDescription.long").append(closeButtonHtml);
                parent.find(".guideFieldDescription.long").detach().insertAfter(errorMessage);
            }
        });
    },

    resetMultiPanel: function (tablePanel) {
        var count = tablePanel.instanceManager.instanceCount;

        if (count === 0) {
            return false;
        }
        if (count === 1) {
            return customFunctions.resetFields(tablePanel.instanceManager.instances[0]);
        }

        for (var i = 0; i < (count - 1); i++) {
            tablePanel.instanceManager.removeInstance(i);
        }

        customFunctions.resetFields(tablePanel.instanceManager.instances[0]);

        return false;
    },

    resetInput: function (afObj) {

        // For preventing default value to get reset
        if (afObj.jsonModel["{default}"]) {
            afObj.value = afObj.jsonModel["{default}"];
            return;
        }

        if (customFunctions.isCheckBox(afObj)) {
            afObj.value = "none";
            return;
        }
        afObj.value = null;

    },

    resetFields: function (afObj) {
        if (customFunctions.isField(afObj)) { //Resetting individual fields
            customFunctions.resetInput(afObj);

        } else if (customFunctions.isPanel(afObj)) { //Resetting all individual fields of the panel

            for (var i = 0; i < afObj.items.length; i++) {
                var item = afObj.items[i];

                if (customFunctions.isField(item)) {
                    customFunctions.resetInput(item);

                } else if (customFunctions.isPanel(item)) {

                    if (item.repeatable) {
                        customFunctions.resetMultiPanel(item);
                    } else {
                        customFunctions.resetFields(item);
                    }
                }
            }
        }
    },

    xmlToJson: function (xml) {

        // Create the return object
        var obj = {};

        if (xml.nodeType === 1) { // element
            // do attributes

        } else if (xml.nodeType === 3) { // text
            obj = xml.nodeValue;
        }

        // do children
        // If just one text node inside
        if (xml.hasChildNodes() && xml.childNodes.length === 1 && xml.childNodes[0].nodeType === 3) {
            obj = xml.childNodes[0].nodeValue;
        } else if (xml.hasChildNodes()) {
            for (var i = 0; i < xml.childNodes.length; i++) {
                var item = xml.childNodes.item(i);
                var nodeName = item.nodeName;
                if (typeof (obj[nodeName]) === "undefined") {
                    obj[nodeName] = customFunctions.xmlToJson(item);
                } else {
                    if (typeof (obj[nodeName].push) === "undefined") {
                        var old = obj[nodeName];
                        obj[nodeName] = [];
                        obj[nodeName].push(old);
                    }
                    obj[nodeName].push(customFunctions.xmlToJson(item));
                }
            }
        }
        return obj;
    },

    //Returns an array of static text fields recursively inside the given panel
    getStaticTextFields: function (afObj) {
        var staticTextFields = [];

        if (customFunctions.isStaticTextField(afObj)) {
            staticTextFields.push(afObj.name);

        } else if (customFunctions.isPanel(afObj)) {

            for (var i = 0; i < afObj.items.length; i++) {
                var item = afObj.items[i];

                if (customFunctions.isStaticTextField(item)) {
                    staticTextFields.push(item.name);

                } else if (customFunctions.isPanel(item)) {
                    var childStaticTextFields = customFunctions.getStaticTextFields(item);
                    staticTextFields = staticTextFields.concat(childStaticTextFields);
                }
            }
        }
        return staticTextFields;
    },
    getFieldNames: function (userInputPanel, authorInputPanel, systemGeneratedPanel) {

        var finalOutPut = '';

        finalOutPut = customFunctions.getPanelFieldNames(userInputPanel, finalOutPut, false, false);
        finalOutPut = customFunctions.getPanelFieldNames(authorInputPanel, finalOutPut, false, false);
        finalOutPut = customFunctions.getPanelFieldNames(systemGeneratedPanel, finalOutPut, true, false);
        if (finalOutPut.substr(finalOutPut.length - 1) === CONSTANTS.comma) {
            finalOutPut = finalOutPut.substr(0, finalOutPut.length - 1);
        }
        return finalOutPut;
    },
    getPanelFieldNames: function (obj, finalOutPut, isEnd, isEmail) {

        if (customFunctions.isPanel(obj)) {

            for (var count = 0; count < obj.items.length; count++) {
                var item = obj.items[count];
                if (customFunctions.isPanel(item)) {
                    finalOutPut = customFunctions.getPanelFieldNames(item, finalOutPut, isEnd);
                } else {

                    var fieldName = item.name;
                    if (!customFunctions.isStaticTextField(item)) {
                        if (CONSTANTS.submit !== fieldName) {
                            finalOutPut = finalOutPut + fieldName + CONSTANTS.comma;

                        }
                    }
                }

            }
        }
        if ($(".quote-results-form", window.parent.document).length == 0) {
            finalOutPut = finalOutPut.replace('quoteinfo,', '');
        }
        return finalOutPut;
    },
    getPanelMandatoryFieldNames: function (obj, mandatoryFields) {
        var isMandatory = false;
        if (customFunctions.isPanel(obj)) {

            for (var count = 0; count < obj.items.length; count++) {
                var item = obj.items[count];
                if (customFunctions.isPanel(item)) {
                    mandatoryFields = customFunctions.getPanelMandatoryFieldNames(item, mandatoryFields);
                } else {

                    var fieldName = item.name;
                    isMandatory = item.mandatory;
                    if (!customFunctions.isStaticTextField(item)) {
                        if (CONSTANTS.submit !== fieldName && isMandatory) {
                            mandatoryFields = mandatoryFields + fieldName + CONSTANTS.comma;
                        }

                    }
                }
            }

        }
        if (mandatoryFields.substr(mandatoryFields.length - 1) === CONSTANTS.comma) {
            mandatoryFields = mandatoryFields.substr(0, mandatoryFields.length - 1);
        }

        return mandatoryFields;
    },
    getDropDownList: function (nodeName) {

        var LOAD_PATH_EXTN = CONSTANTS.listJson;
        var responseArray = JSON.parse($.ajax({
            url: nodeName + "/" + LOAD_PATH_EXTN,
            type: "GET",
            async: false,
            success: function (res) {
            },
            error: function (message) {
                guideBridge._guide.logger().log(message);
            }
        }).responseText);

        var returnArray = [];

        for (var i = 0; i < responseArray.length; i++) {
            var str = responseArray[i].value + '=' + responseArray[i].text;
            returnArray.push(str);
        }

        return returnArray;
    },
    getProxyUrl: function (nodeName, nameOfTheTemplate) {

        var LOAD_PATH = CONSTANTS.acsCommonsUrl;
        var LOAD_PATH_EXTN = CONSTANTS.listJson;
        var responseArray = JSON.parse($.ajax({
            url: LOAD_PATH + "/" + nodeName + "/" +
                LOAD_PATH_EXTN,
            type: "GET",
            async: false,
            success: function (res) {
            },
            error: function (message) {
                guideBridge._guide.logger().log(message);
            }
        }).responseText);
        var returnVal;
        for (var i = 0; i < responseArray.length; i++) {
            if (responseArray[i].text == nameOfTheTemplate) {
                returnVal = responseArray[i].value;
                return returnVal;
            }
        }
        return false;
    },
    // analytics function
    getFieldInfo: function (guideRootPanel) {
        var noofmandatoryFields = 0;
        noofoptionalFields = 0;
        var finalOutPut = '"formValues":{';
        var jsonData = customFunctions.getPanelFieldInfo(guideRootPanel.userInputPanel, finalOutPut, false, 0, 0);
        finalOutPut = jsonData[0];
        noofmandatoryFields = jsonData[1];
        noofoptionalFields = jsonData[2];


        jsonData = customFunctions.getPanelFieldInfo(guideRootPanel.authorInputPanel, finalOutPut, false, noofmandatoryFields, noofoptionalFields);
        finalOutPut = jsonData[0];
        noofmandatoryFields = jsonData[1];
        noofoptionalFields = jsonData[2];


        jsonData = customFunctions.getPanelFieldInfo(guideRootPanel.systemGeneratedPanel, finalOutPut, true, noofmandatoryFields, noofoptionalFields);
        finalOutPut = jsonData[0];
        noofmandatoryFields = jsonData[1];
        noofoptionalFields = jsonData[2];
        finalOutPut = finalOutPut + "},";
        finalOutPut = finalOutPut.replace(",},", "},");
        return [finalOutPut, noofmandatoryFields, noofoptionalFields];
    },
    // to get the field info i.e. field name, mandatory and optional count
    getPanelFieldInfo: function (obj, finalOutPut, isEnd, noofmandatoryFields, noofoptionalFields) {
        if (customFunctions.isPanel(obj)) {
            for (var count = 0; count < obj.items.length; count++) {
                var item = obj.items[count];
                var fieldName = '';
                var fieldValue = '';
                if (item.value !== null) {

                    fieldValue = item.value;
                }
                if (item.name !== null) {
                    fieldName = item.name;
                }
                var fieldMandatory = 'O';
                if (item.mandatory != 'undefined' && item.mandatory) {
                    noofmandatoryFields = noofmandatoryFields + 1;
                    fieldMandatory = 'M';

                } else {
                    noofoptionalFields = noofoptionalFields + 1;
                }
                if (!customFunctions.isStaticTextField(item)) {
                    if ("submitButton" !== fieldName) {
                        if($("#fdtheme-id-clientlibs link[href*='nh-microsite-calculator-theme']").length > 0 || $("#fdtheme-id-clientlibs link[href*='generic-loan-calc']").length > 0){
                            if ("QuoteInfo" !== fieldName){
                                finalOutPut = finalOutPut + '"' + fieldName + "|" + fieldMandatory + '":"' + fieldValue + '" ,';
                            }else{
                                finalOutPut = finalOutPut + '"' + fieldName + "|" + fieldMandatory + '":{' + fieldValue + '} ,';
                            }
                        }else{
                            finalOutPut = finalOutPut + '"' + fieldName + "|" + fieldMandatory + '":"' + fieldValue + '" ,';
                        }


                    }
                }


            }
        }
        return [finalOutPut, noofmandatoryFields, noofoptionalFields];
    },
    // to get the form id
    getFormId: function () {
        var node = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].authorInputPanel[0].formTitle[0]"),
            pathArray = $(".guidePanelNode").attr("data-path").split("/"),
            index = pathArray.indexOf("jcr:content");
        if (node != null && (typeof node != "undefined")) {
            if (node.value !== null) {
                return node.value;
            } else {
                return pathArray[index-1];
            }
        }else{
            var pathArray = $(".guidePanelNode").attr("data-path").split("/");
            var index = pathArray.indexOf("jcr:content");
            return pathArray[index-1];
        }
        return '';
    },
    // to create the json data for start,abandon,complete and error events
    getFormFieldsJSON: function (actionType, guideRootPanel) {
        var formDataJSON = '';
        var noofMandatoryFields = 0;
        var noofOptionalFields = 0;
        var data = '';
        var formId = '';
        if (guideRootPanel != null && (typeof guideRootPanel != 'undefined') && (typeof guideRootPanel.authorInputPanel != 'undefined') && (typeof guideRootPanel.authorInputPanel.formTitle != 'undefined') && guideRootPanel.authorInputPanel.formTitle.value != null) {
            formId = guideRootPanel.authorInputPanel.formTitle.value;
        }
        switch (actionType) {
            case 'formComplete':
                var fieldInfo = customFunctions.getFieldInfo(guideRootPanel);
                var formEndinMiliseconds = Date.now();
                if (fieldInfo != 'undefined') {
                    data = fieldInfo[0];
                    noofMandatoryFields = fieldInfo[1];
                    noofOptionalFields = fieldInfo[2];
                }
                formDataJSON = '{' + '"eventName":' + '"formComplete","attributes": {"form":' + '"' + formId + '",' + '"formTime":' + '"' + ((formEndinMiliseconds - formStartTimeinMiliseconds) / 1000) + '",' + data +
                    '"BackEndSystem":' + '"' + guideRootPanel.hiddenPanel.nameOfTheTemplate.value + '",' +
                    '"NoofMFields":' + '"' + noofMandatoryFields + '","NoofOFields": "' +
                    noofOptionalFields + '"}}';
                GLOBAL.formComplete = true;
                GLOBAL.formStart = false;
                console.log("json data for form complete event : ", formDataJSON);
                break;

            case 'formStart':
                formDataJSON = '{' + '"eventName":' + '"formStart","attributes": {"form":' + '"' + customFunctions.getFormId() + '"' +
                    '}}';
                console.log(formDataJSON);
                break;

            case 'formError':
                formDataJSON = '{' + '"eventName":' + '"formError","attributes": {"form":' + '"' + formId + '"' +
                    '}}';
                console.log(formDataJSON);
                break;

            case 'formAbandon':
                formDataJSON = '{' + '"eventName":' + '"formAbandon","attributes": {"form":' + '"' + formId + '"' + '}}';
                console.log(formDataJSON);
                break;

            case 'formStep':
                formDataJSON = '{' + '"eventName":' + '"formStep","attributes": {"form":' + '"' + customFunctions.getFormId() + '"' +
                    '}}';
                console.log(formDataJSON);
                break;

            case 'iFrameLoad':
                formDataJSON = '{' + '"eventName":' + '"iFrameLoad","attributes": {"form":' + '"' + customFunctions.getFormId() + '"' + '}}';
        }
        return formDataJSON;
    },
    getObjectSize: function (obj) {
        var size = 0, key;
        for (key in obj) {
            if (obj.hasOwnProperty(key))
                size++;
        }
        return size;
    },
    getJsonObjFromResultObj: function (guideResultObject, guideRootPanel) {

        var xmlDoc = guideResultObject.data;
        var xmlDOM = new DOMParser().parseFromString(xmlDoc, 'text/xml');
        var jsonObj = customFunctions.xmlToJson(xmlDOM);
        var afDataObj = jsonObj['afData'];
        var finalUnboundObj = afDataObj['afUnboundData'];
        var finaljsonObj = finalUnboundObj['data'];
        delete finaljsonObj["#text"];

        $.each(finaljsonObj, function (key, val) {
            if (val.constructor === Object && customFunctions.getObjectSize(val) === 0) {
                delete finaljsonObj[key];
            }
        });

        var removeFields = ["nameOfTheTemplate", "typeOfTheme", "messageDelay", "pageTargetDropDown",
            "messageOptionDropDown", "errorPageTextBox", "thankYouPageTextBox", "termsandconditions",
            "errorMessage", "errorMessageText", "thankYouMessage", "thankYouMessageText"
        ];

        var staticFieldsPanel = customFunctions.getStaticTextFields(guideRootPanel);

        removeFields = removeFields.concat(staticFieldsPanel);
        for (var i = 0; i < removeFields.length; i++) {
            delete finaljsonObj[removeFields[i]];
        }
        return finaljsonObj;
    },
    createMarketoPayload: function (finaljsonObj, guideRootPanel) {
        var marketoJson = {
          "marketoConfig": finaljsonObj["marketoConfig"],
          "programName": finaljsonObj["programName"],
          "lookupField": finaljsonObj["lookupField"],
          "input": []
         };

         if(finaljsonObj["filterOption"] !== null && finaljsonObj["filterOption"] == "yes"){
                 marketoJson["filterOption"] = finaljsonObj["filterOption"];
                 marketoJson["filterField"] = finaljsonObj["filterField"];
                 marketoJson["filterValue"] = finaljsonObj["filterValue"];
         }

        var removeFields = ["typeOfTheme", "messageDelay", "pageTargetDropDown",
            "messageOptionDropDown", "errorPageTextBox", "thankYouPageTextBox", "termsandconditions",
            "errorMessage", "errorMessageText", "thankYouMessage", "thankYouMessageText","captcha"
        ];

        var staticFieldsPanel = customFunctions.getStaticTextFields(guideRootPanel);

        removeFields = removeFields.concat(staticFieldsPanel);
        for (var i = 0; i < removeFields.length; i++) {
            delete finaljsonObj[removeFields[i]];
        }
        var inputJson = {};
        $.each(finaljsonObj, function (key, val) {

            if(val !== null){
                inputJson[key] = finaljsonObj[key];
            }
        });

        var removeFieldsInput = ["programName", "marketoConfig", "nameOfTheTemplate",
            "lookupField", "typeofform", "formTitle","filterOption","filterField","filterValue","captcha"];
        for (var i = 0; i < removeFieldsInput.length; i++) {
            delete inputJson[removeFieldsInput[i]];
        }
        inputJson[finaljsonObj["filterField"]]=finaljsonObj["filterValue"];

        var input =[];
        input.push(inputJson);
        marketoJson["input"] = input;
        console.log("marketo Json" + JSON.stringify(marketoJson));
        return JSON.stringify(marketoJson);
    },
    dobValidationCLR: function (cssName, strValue) {
        if (typeof cssName != "undefined" && cssName.includes("DateValidation")) {
            var y = strValue.substring(6, 10);
            var m = strValue.substring(0, 2);
            var d = strValue.substring(3, 5);
            return customFunctions.dateValidation(y, m, d, cssName);
        } else {
            return true;
        }
    },
    dobValidationGLU: function (cssName, format, str) {
        switch (format) {
            case "yyyy/mm/dd":
            case "yyyy-mm-dd":
                if (RegExp("^([0-9]{4}).(0[1-9]|1[012]).(0[1-9]|[12][0-9]|3[01])$").test(str)) {
                    if (typeof cssName != "undefined" && cssName.includes("DateValidation")) {
                        var y = str.substring(0, 4);
                        var m = str.substring(5, 7);
                        var d = str.substring(8, 10);
                        return customFunctions.dateValidation(y, m, d, cssName);
                    } else return true;
                } else {
                    return false;
                }
                break;
            case "mm/dd/yyyy":
            case "mm-dd-yyyy":
                if (RegExp("^(0[1-9]|1[012]).(0[1-9]|[12][0-9]|3[01]).([0-9]{4})$").test(str)) {
                    if (typeof cssName != "undefined" && cssName.includes("DateValidation")) {
                        var y = str.substring(6, 10);
                        var m = str.substring(0, 2);
                        var d = str.substring(3, 5);
                        return customFunctions.dateValidation(y, m, d, cssName);
                    } else return true;
                } else {
                    return false;
                }
                break;
            case "dd/mm/yyyy":
            case "dd-mm-yyyy":
                if (RegExp("^(0[1-9]|[12][0-9]|3[01]).(0[1-9]|1[012]).([0-9]{4})$").test(str)) {
                    if (typeof cssName != "undefined" && cssName.includes("DateValidation")) {
                        var y = str.substring(6, 10);
                        var d = str.substring(0, 2);
                        var m = str.substring(3, 5);
                        return customFunctions.dateValidation(y, m, d, cssName);
                    } else {
                        return true;
                    }
                } else return false;
                break;
        }
    },
    dobValidationEmail: function (cssName, str) {
        if (RegExp("^([0-9]{4}).(0[1-9]|1[012]).(0[1-9]|[12][0-9]|3[01])$").test(str)) {
            if (typeof cssName != "undefined" && cssName.includes("DateValidation")) {
                var y = str.substring(0, 4);
                var m = str.substring(5, 7);
                var d = str.substring(8, 10);
                return customFunctions.dateValidation(y, m, d, cssName);
            } else return true;
        } else if (RegExp("^(0[1-9]|1[012]).(0[1-9]|[12][0-9]|3[01]).([0-9]{4})$").test(str)) {
            if (typeof cssName != "undefined" && cssName.includes("DateValidation")) {
                var y = str.substring(6, 10);
                var m = str.substring(0, 2);
                var d = str.substring(3, 5);
                return customFunctions.dateValidation(y, m, d, cssName);
            } else return true;
        } else if (RegExp("^(0[1-9]|[12][0-9]|3[01]).(0[1-9]|1[012]).([0-9]{4})$").test(str)) {
            if (typeof cssName != "undefined" && cssName.includes("DateValidation")) {
                var y = str.substring(6, 10);
                var d = str.substring(0, 2);
                var m = str.substring(3, 5);
                return customFunctions.dateValidation(y, m, d, cssName);
            } else return true;
        } else return false;
    },

    dateValidation: function (y, m, d, cssName) {
        var inputDate = new Date(y + "/" + m + "/" + d);
        var currentDate = new Date();
        var strdate = d + "/" + m + "/" + y;
        if (RegExp("^(((0[1-9]|[12][0-9]|3[01])([\/])(0[13578]|10|12)([\/])([1-2][0,9][0-9][0-9]))|(([0][1-9]|[12][0-9]|30)([\/])(0[469]|11)([\/])([1-2][0,9][0-9][0-9]))|((0[1-9]|1[0-9]|2[0-8])([\/])(02)([\/])([1-2][0,9][0-9][0-9]))|((29)(\.|-|\/)(02)([\/])([02468][048]00))|((29)([\/])(02)([\/])([13579][26]00))|((29)([\/])(02)([\/])([0-9][0-9][0][48]))|((29)([\/])(02)([\/])([0-9][0-9][2468][048]))|((29)([\/])(02)([\/])([0-9][0-9][13579][26])))$").test(strdate)) {
            if (cssName == "pastDateValidation") {
                if (inputDate.setHours(0, 0, 0, 0) >= currentDate.setHours(0, 0, 0, 0)) {
                    return false;
                } else {
                    return true;
                }
            }
            if (cssName == "futureDateValidation") {
                if (inputDate.setHours(0, 0, 0, 0) < currentDate.setHours(0, 0, 0, 0)) {
                    return false;
                } else {
                    return true;
                }
            }
        } else {
            return false;
        }
    },
    guid: function () {
        return customFunctions.s4() + customFunctions.s4() + '-' + customFunctions.s4() + '-' + customFunctions.s4() + '-' +
            customFunctions.s4() + '-' + customFunctions.s4() + customFunctions.s4() + customFunctions.s4();
    },

    s4: function () {
        return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
    }
};



/**
 * AEM Slider Form Widget overlay the OOTB GuideNumericBox Form Widget.
 * Few are listed below:
 * <ul>
 * <li> Options of sequential or segmented choices configured during authoring
 * <li> Hide or show subcopy configured during authoring
 * </ul>
 *
 */
$(document).ready(function() {
	heightAdjusterForRoundIconButton();
    if($(".slider-widget").length > 0) {
        $(".slider-widget").each(function() {
            var groupLabel, groupLabelTooltip, linkTooltipText = "What's this?", linkTooltipContent, ariaLabelledby, hidden, onChange, animatedCurrentValueStyle;

            var id = $(this).attr("id"), name = $(this).attr("name"), className="segmented-slider", segmented = $(this).attr("data-segmented"),
                subcopy = $(this).find(".slider-subcopy").attr("data-subcopy"), singularUnit = $(this).attr("data-singularUnit"), pluralUnit = $(this).attr("data-pluralUnit"),
                ariaLabel = $(this).attr("data-ariaLabel");

            var thumbSize = 32, min = Number($(this).attr("data-min")), max = Number($(this).attr("data-max")), value = Number($(this).attr("value")),
                step = Number($(this).attr("data-step")), colspan = Number($(this).attr("data-colspan")), valueState = value || min || 0, ariaLabelledbyIds = ariaLabelledby || "";

            segmented === "segmented" ? segmented=true : segmented=false;
            if (groupLabel) {ariaLabelledbyIds += ` ${id}-group-label`;}
            var ratio = (valueState - min) / (max - min);
            var inputStyle = {
                backgroundSize: ratio * 100 + "% 100%"
            };
            var progressStyle = {
                width: "calc(" + ratio * 100 + "% - 16px)"
            };
            var grayBarStyle = {
                width: "calc(100% - " + ratio * 100 + "% - 16px)",
                maxWidth: "calc(100% - 32px)"
            };
            var outputStyle = {
                top: "-28px",
                left: "calc(" + ((32+4) / 2) + "px + " + ratio * 100 + "% - " + ratio + " * 36px)",
                height: "21px",
                width: "32px",
                overflow: "hidden"
            };

            function getUnit() {
                var unit = singularUnit || pluralUnit;
                if (valueState > 1) {
                    unit = pluralUnit || singularUnit;
                }
                return unit;
            }

            function getValue() {
                var num = Math.ceil((max - min) / (step || 1)) + 1;
                var $ul = $("<ul aria-hidden='true'></ul>");
                for (var i = 0; i < num; i++) {
                    var mark = i * (step || 1) + min;
                    if (mark > max) {
                        mark = max;
                    }
                    var $li = $("<li aria-hidden='true'></li>").text(mark);
                    $ul.append($li);
                }
                return $ul;
            }

            function getRangeLabels() {
                var num = Math.ceil((max - min) / (step || 1)) + 1;
                var labels = [];
                for (var i = 0; i < num; i++) {
                    var mark = i * (step || 1) + min;
                    if (mark > max) {
                        mark = max;
                    }
                    var thumbSize = 32;
                    var pos = (mark - min) / (max - min);
                    var labelStyle = {
                        left: `calc(${thumbSize / 2}px + ${pos * 100}% - ${pos * thumbSize}px)`
                    };
                    labels.push($("<span>").css(labelStyle).attr("data-unit", getUnit()).text(mark));
                }
                return labels;
            };


            var $slider = $("<div>").attr({
                id: id,
                class: "aem-form-slider" + (segmented ? " segmented-slider" : "")
            });

            var $subcopy = $("<div>").addClass("subcopy").text(subcopy);
            $slider.append($subcopy);

            if (groupLabel) {
                var $groupLabel = $("<label>").attr({
                    id: `${id}-group-label`,
                    class: groupLabelTooltip ? "slider-accessible-text" : "group-label"
                }).text(groupLabel);
                $slider.append($groupLabel);
            }

            if (groupLabelTooltip) {
                var $groupLabelTooltip = $("<div>").addClass("group-label-w-tooltip");
                var $groupLabelContent = $("<div>").attr({
                    "aria-hidden": "true",
                    role: "presentation",
                    class: "group-label"
                }).text(groupLabel);
                $groupLabelTooltip.append($groupLabelContent);
                $slider.append($groupLabelTooltip);
            }

            if (linkTooltipContent) {
                var $linkTooltip = $("<div>").attr({
                    role: "tooltip",
                    class: "link-tooltip"
                });
                var $linkText = $("<span>").text(linkTooltipText).attr({
                    id: `${id}-link-tooltip-text`
                });
                var $infoContent = $("<div>").addClass("info");
                var $linkTooltipContent = $("<div>").attr({
                    id: `${id}-link-tooltip-content`
                }).text(linkTooltipContent);
                var $closeIcon = $("<div>").addClass("slider-icons").attr({
                    svgName: "Close",
                    title: "Close",
                    titleId: "close-svg-icon",
                    "aria-hidden": true
                }).css({
                    width: "8px",
                    height: "8px",
                    color: "#333"
                }).on("click", function() {
                    setOpenLinkTooltip(false);
                });
                $infoContent.append($linkTooltipContent, $closeIcon);
                $linkTooltip.append($linkText, $infoContent);
                $slider.append($linkTooltip);
            }

            var $sliderGroup = $("<div>").addClass("slider-group");
            var $sliderElement = $("<div>").addClass("slider");

            var $rangeInput = $("<input>").attr({
                type: "range",
                id: `${name}-range-input`,
                "data-testid": `${id}-range-input`,
                class: "slider",
                "aria-labelledby": ariaLabelledbyIds,
                "aria-label": ariaLabel || groupLabel || "Slider",
                "aria-describedby": linkTooltipContent ? `${id}-link-tooltip-content` : "",
                name: name,
                min: min,
                max: max,
                step: step,
                value: valueState,
                segmented: segmented
            }).css(inputStyle);
            $sliderElement.append($rangeInput);


            var $progressBar = $("<div>").addClass("slider-progress-bar").css(progressStyle);
            $sliderElement.append($progressBar);

            var $grayBar = $("<div>").addClass("slider-gray-bar").css(grayBarStyle);
            $sliderElement.append($grayBar);

            var $labelElement;
            if (segmented) {
                $labelElement = $("<div>").addClass("segmented-range-label").append(getRangeLabels());
            } else {
                $labelElement = $("<div>").addClass("range-label");
                var $minLabel = $("<span>").text(min).css({ left: "6px" }).attr({ "data-unit": singularUnit || pluralUnit });
                var $maxLabel = $("<span>").text(`${max} ${pluralUnit || singularUnit}`).css({ left: "calc(100% - 2px)" }).addClass(pluralUnit || singularUnit ? "with-unit" : "no-unit");
                $labelElement.append($minLabel, $maxLabel);
            }
            $sliderElement.append($labelElement);
            $sliderGroup.append($sliderElement);

            var $currentValueElement;
            if (segmented) {
                    $currentValueElement = $("<div>").addClass("current-value segmented").attr({ "data-unit": getUnit() }).text(valueState || value || min);
                } else {
                    if(min > 0) {
                    valueState = valueState-min;
                }
                animatedCurrentValueStyle = {
                    transition: "transform 0.3s ease-out",
                    transform: `translateY(-${valueState / step * 20}px)`
                };
                $currentValueElement = $("<div>").addClass("current-value").css(Object.assign({}, outputStyle, { position: "absolute" }));
                var $ulElement = $("<ul>").css(animatedCurrentValueStyle).append(getValue());
                $currentValueElement.append($ulElement);
            }
            $sliderGroup.append($currentValueElement);
            $slider.append($sliderGroup);

            var $sliderCotainer = $("<div>").addClass("segmented-container").css({width:"auto",marginTop:"20px",marginBottom:"25px",paddingBottom:"25px"});
            $sliderCotainer.append($slider);
            $sliderWrap = $(".slider-widget");
            $(this).append($sliderCotainer);


        	$(document).find($(this)).contents().find(".slider input[type=range]").on("input", function() {
				var $inputSelected = $(this);
                var valueState = $inputSelected.val() || min || 0;
                var ratio = (valueState - min) / (max - min);
                var inputStyle = {
                    backgroundSize: `${ratio * 100}% 100%`
                };
                var progressStyle = {
                    width: `calc(${ratio * 100}% - 16px)`
                };
                var grayBarStyle = {
                    width: `calc(100% - ${ratio * 100}% - 16px)`,
                    maxWidth: "calc(100% - 32px)"
                };
                $inputSelected.css(inputStyle);
                $inputSelected.parent().next().css({left: "calc(" + (thumbSize+4) / 2 + "px + " + ratio * 100 + "% - " + ratio + " * " + (thumbSize+4) + "px)"});

                if (segmented) {
                    $labelElement = $("<div>").addClass("segmented-range-label").append(getRangeLabels());
                    $inputSelected.parent().next().html(valueState);
                } else {
                    if(min > 0) {
						valueState = valueState-min;
                    }
                    var translateY = `translateY(-${valueState / step * 10}px)`;
                    $inputSelected.parent().next().find("ul").css({transform: translateY});
                }
				$inputSelected.attr("value", valueState);
            }).on("mouseup keyup", function(e) {
                if (typeof onChange === "function") {
                    onChange(e);
                }
            });
        })
    }

})



/**
 * GuideImageChoice encapsulates basic properties of the adaptive forms Image Choice Component.
 * Few are listed below:
 * <ul>
 * <li> Options of the Image choice component configured during authoring
 * <li> Alignment of the Image choice component configured during authoring
 * </ul>
 *
 */
$(document).ready(function() {
    if($(".round-icon__button").length > 0) {
        $(".round-icon__button .round-icon__button__title").each(function() {
            var textButtonTitle = $(this).text();
            var textRoundIcon = $(this).parent().find("input").attr("data-path");

            if (textButtonTitle.indexOf("_") > -1) {
                var valueText = textButtonTitle.split('_');
                var textPart = valueText[1];
                $(this).html(textPart);
            }

            if (textRoundIcon.indexOf("?") > -1) {
                if (textRoundIcon.indexOf("/") > -1 && textRoundIcon.indexOf(".") > -1) {
                    var lastSlashIndex = textRoundIcon.lastIndexOf('/');
                    var dotIndex = textRoundIcon.indexOf('.', lastSlashIndex);
                    var textBetween = textRoundIcon.substring(lastSlashIndex + 1, dotIndex);
                    $(this).text(textBetween);
                }

                if (textRoundIcon.indexOf("/") > -1 && textRoundIcon.indexOf(".") < 0) {
                    var lastSlashIndex = textRoundIcon.lastIndexOf('/');
                    var queryIndex = textRoundIcon.indexOf('?');
                    var fileName;
                    if (queryIndex === -1) {
                        fileName = textRoundIcon.substring(lastSlashIndex + 1);
                    } else {
                        fileName = textRoundIcon.substring(lastSlashIndex + 1, queryIndex);
                    }
                    $(this).text(fileName);
                }

                if (textRoundIcon.indexOf(".") > -1 && textRoundIcon.indexOf("/") < 0) {
                    var textBeforeDot = textRoundIcon.split('.')[0];
                    $(this).text(textBeforeDot);
                }
            }
        })
    }

})


/*
 Function and file to handle the slider submission
 Service  to collect the Data from form fields and post the the back-end service.
 Post the response get the success / error message from site header global config.
 Post the Json to the service

 */
/* clear form array and call form reload on cross button click of slider form */
var tempUserInputPanel = null;
$('.contact-close').one('click', function (e) {
    var formPath = document.getElementById(CONSTANTS.formPath).value;
    var sitedata = $('input:hidden', '.contactSideForm');
    var index = forms.indexOf(customFunctions.getFormId());
    if (index > -1) {
        forms.splice(index, 1);
    }
    if (tempUserInputPanel !== null && (typeof tempUserInputPanel !== 'undefined')) {
        metLifeHeaderFunctions.reloadAemForm(tempUserInputPanel);
    }
    metLifeHeaderFunctions.callAemForm(sitedata, formPath);
    tempUserInputPanel = null;
    // e.stopImmediatePropagation();
    // e.preventDefault();

});

$(".sliderCancelButton").attr('tabindex', '0');

$('.sliderCancelButton').keypress(function(e){
        if(e.which == 13){
           $(".contact-close").trigger("click");
    	   var userInputPanel = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].userInputPanel[0]");
    	   metLifeHeaderFunctions.resetForm(userInputPanel);
        }
});

$(".sliderCancelButton p").on("click",function(){
    $(".contact-close").trigger("click");
    var userInputPanel = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].userInputPanel[0]");
    metLifeHeaderFunctions.resetForm(userInputPanel);
});

var metLifeHeaderFunctions = {

    /* submit function to be triggered on submit of form 	*/
    submitProcessAsyncCall: function (userInputPanel, guideRootPanel) {
        document.getElementsByClassName(CONSTANTS.contactSliderOuterCon).disabled = true;
		var fieldNames = customFunctions.getPanelFieldNames(userInputPanel,fieldNames,false,false);
		
        setTimeout(function () {
            guideBridge.getDataXML({
                success: function (guideResultObject) {
                    /* handling of objects and variables defined for different templates */
                    var finaljsonObj = customFunctions.getJsonObjFromResultObj(guideResultObject, guideRootPanel);
                    var urlRef = CONSTANTS.emptyString;
                    var nameOfTheTemplate = guideRootPanel.hiddenPanel.nameOfTheTemplate.value;
                    finaljsonObj["nameOfTheTemplate"] = nameOfTheTemplate;
                    if (nameOfTheTemplate === CONSTANTS.clr) {
                        // Update json to truncate the zip code to 5 digit , get prod interest value in array.
                        finaljsonObj.prodInterest = finaljsonObj.prodInterest.split(CONSTANTS.comma);
                        finaljsonObj.zip = finaljsonObj.zip.substr(0, 5);
                    } else if (nameOfTheTemplate === CONSTANTS.glu) {
                        if (finaljsonObj.BirthDate != undefined) {
                            var format = guideRootPanel.authorInputPanel.dateFormat.value;

                            switch (format) {
                                case "yyyy/mm/dd":
                                case "yyyy-mm-dd":
                                    var str = finaljsonObj.BirthDate;
                                    srt = str.trim();
                                    var year = str.substring(0, 4);
                                    var month = str.substring(5, 7);
                                    var day = str.substring(8, 10);
                                    finaljsonObj.BirthDate = year + "-" + month + "-" + day;
                                    break;
                                case "mm/dd/yyyy":
                                case "mm-dd-yyyy":
                                    var str = finaljsonObj.BirthDate;
                                    srt = str.trim();
                                    var year = str.substring(6, 10);
                                    var month = str.substring(0, 2);
                                    var day = str.substring(3, 5);
                                    finaljsonObj.BirthDate = year + "-" + month + "-" + day;
                                    break;
                                case "dd/mm/yyyy":
                                case "dd-mm-yyyy":
                                    var str = finaljsonObj.BirthDate;
                                    srt = str.trim();
                                    var year = str.substring(6, 10);
                                    var month = str.substring(3, 5);
                                    var day = str.substring(0, 2);
                                    finaljsonObj.BirthDate = year + "-" + month + "-" + day;
                                    break;


                            }

                        }
						var vendorAppName = fieldNames.search(CONSTANTS.vendorAppName);
                        if(vendorAppName > -1){
                            var vendorAppNameValue = userInputPanel.vendorAppName.value; 
                            if (vendorAppNameValue == 'CRMNext') {
                                nameOfTheTemplate = CONSTANTS.glucrmnext;
                            }
                        }
                        finaljsonObj.LanguageValue = CONSTANTS.emptyString;
                    } else if (nameOfTheTemplate === CONSTANTS.gluemail) {

                        if (finaljsonObj.request == undefined) {
                            finaljsonObj.UniqueReferenceNumber = customFunctions.guid();
                        }
                        else if (finaljsonObj.request != undefined) {
                            var thisId = customFunctions.guid();
                            var requestValue = finaljsonObj.request;
                            switch (requestValue) {
                                case "general":
                                    thisId = "G" + thisId;
                                    finaljsonObj.UniqueReferenceNumber = thisId;
                                    break;
                                case "feedback":
                                    thisId = "F" + thisId;
                                    finaljsonObj.UniqueReferenceNumber = thisId;
                                    break;
                                case "complaint":
                                    thisId = "C" + thisId;
                                    finaljsonObj.UniqueReferenceNumber = thisId;
                                    break;
                            }
                        }						
						if (finaljsonObj.attachmentInfo != undefined) {
                            finaljsonObj.attachmentInfo = JSON.parse(finaljsonObj.attachmentInfo);
                            guideRootPanel.systemGeneratedPanel.attachmentInfo.value = finaljsonObj.attachmentInfo; 
                        }
                    }
                    if(nameOfTheTemplate == "GLU"){
                        urlRef = CONSTANTS.gluServlet;
                    }else{
                        urlRef = customFunctions.getProxyUrl("proxyConfigurations", nameOfTheTemplate);

                    }/* handling of getting selected message option and getting variables defined for ajax call */
                    var selectedMessageOption = document.getElementById(CONSTANTS.msgDisplayType).value;
                    var redirectPage = CONSTANTS.emptyString;
                    var targetName = document.getElementById(CONSTANTS.openIn).value;
                    var formPath = document.getElementById(CONSTANTS.formPath).value;
                    var sitedata = $('input:hidden', '.contactSideForm');

					var uniqueID = metLifeFunctions.uniqueID();
                    if (selectedMessageOption === CONSTANTS.samePagefadeOutSite || selectedMessageOption === CONSTANTS.samePagefixedSite) {
                        userInputPanel.visible = false;
                        $("#guideContainer-rootPanel-formTitlePanel___guide-item-container").hide();
                        document.getElementsByClassName(CONSTANTS.contactSideThankyou).disabled = false;
                    }
                    if(nameOfTheTemplate === CONSTANTS.gluemail){
                        $.ajax({
                            url: CONSTANTS.gluemailServlet,
                            dataType: 'json',
                            data: JSON.stringify(finaljsonObj),
                            async: true,
                            type: 'POST',
                            headers:{"x-csrf-token":uniqueID},
                            contentType: "application/json; charset=utf-8",
                            /* handling of success in ajax response */
                            success: function (data) {
                                var response = data.result;
                                GLOBAL.returnStatus = data.result;
                                if (response === undefined) {
                                    response = data.Result;
                                    GLOBAL.returnStatus = data.Result;
                                }
                                switch (response.toLowerCase()) {
                                    case CONSTANTS.success:
                                        metLifeHeaderFunctions.ajaxSuccess(guideRootPanel, userInputPanel, selectedMessageOption, redirectPage, targetName);
                                        break;
                                    case CONSTANTS.fail:
                                    case CONSTANTS.error:
                                    case CONSTANTS.failure:
                                    case CONSTANTS.Error:
                                        // Handle Failure
                                        //Thank you, Error panel configurations based on failure response
                                       metLifeHeaderFunctions.ajaxError(guideRootPanel, userInputPanel, selectedMessageOption, redirectPage, targetName);
                                        break;
                                    default:
                                } // switch closed
                                metLifeHeaderFunctions.samePageOption(userInputPanel, selectedMessageOption);
                            }, // success closed
                            error: function () {
                                metLifeHeaderFunctions.ajaxError(guideRootPanel, userInputPanel, selectedMessageOption, redirectPage, targetName);
                                metLifeHeaderFunctions.samePageOption(userInputPanel, selectedMessageOption);
                            } //error closed
                        }); // Ajax ended
                    }else{
                        $.ajax({
                            url: urlRef,
                            dataType: 'json',
                            data: JSON.stringify(finaljsonObj),
                            async: true,
                            type: 'POST',
                            headers:{"x-csrf-token":uniqueID},
                            contentType: "application/json; charset=utf-8",
                            /* handling of success in ajax response */
                            success: function (data) {
                                var response = data.result;
                                GLOBAL.returnStatus = data.result;
                                if (response === undefined) {
                                    response = data.Result;
                                    GLOBAL.returnStatus = data.Result;
                                }
                                switch (response.toLowerCase()) {
                                    case CONSTANTS.success:
                                         metLifeHeaderFunctions.ajaxSuccess(guideRootPanel, userInputPanel, selectedMessageOption, redirectPage, targetName);
                                        break;
                                    case CONSTANTS.fail:
                                    case CONSTANTS.error:
                                    case CONSTANTS.failure:
                                    case CONSTANTS.Error:
                                        // Handle Failure
                                        //Thank you, Error panel configurations based on failure response
                                        metLifeHeaderFunctions.ajaxError(guideRootPanel, userInputPanel, selectedMessageOption, redirectPage, targetName);
                                        break;
                                    default:
                                } // switch closed
                                metLifeHeaderFunctions.samePageOption(userInputPanel, selectedMessageOption);
                            }, // success closed
                            error: function () {
                                metLifeHeaderFunctions.ajaxError(guideRootPanel, userInputPanel, selectedMessageOption, redirectPage, targetName);
                                metLifeHeaderFunctions.samePageOption(userInputPanel, selectedMessageOption);
                            } //error closed
                        }); // Ajax ended
                    }

                }, // Success guidebridge ended

                error: function (guideResultObject) {
                    guideBridge._guide.logger().log(guideResultObject);
                } // error guideBridge ended
            }); //Closing guideBridge.getDataXML
        }, 500); //Closing setTimeOut
    }, //Closing submitProcessAsyncCall function
    ajaxSuccess: function(guideRootPanel, userInputPanel, selectedMessageOption, redirectPage, targetName){
        metlife_analytics_functions.onFormCompleteEvent(guideRootPanel);
        // Handle Success Thank you, Error panel configurations based on successful response
        if (selectedMessageOption === CONSTANTS.newPageSite) {
            $('.contact-close').trigger('click');
            metLifeHeaderFunctions.reloadAemForm(userInputPanel);
            redirectPage = document.getElementById(CONSTANTS.thankYouMsgUrl).value;
            metLifeHeaderFunctions.openIn(redirectPage, targetName);
        } else {
            $("#contactus_lead_thankyou").fadeIn(500);
        }
    },
    ajaxError: function(guideRootPanel, userInputPanel, selectedMessageOption, redirectPage, targetName){
        metlife_analytics_functions.onFormErrorEvent(guideRootPanel);
        if (selectedMessageOption === CONSTANTS.newPageSite) {
            redirectPage = document.getElementById(CONSTANTS.errorMsgUrl).value;
            metLifeHeaderFunctions.openIn(redirectPage, targetName);
        } else {
            GLOBAL.returnStatus = "error";
            $("#contactus_lead_submit_error").fadeIn(500);
        }
    },
    /* resetting of all the form field values on submit */
    resetForm: function (userInputPanel) {
        customFunctions.resetInput(userInputPanel);
        customFunctions.resetFields(userInputPanel);
        customFunctions.resetMultiPanel(userInputPanel);
    }, // Closing resetForm function
    /* function to handle the window open on new page options */
    openIn: function (redirectPage, targetName) {
        var target = CONSTANTS.emptyString;

        if (targetName === CONSTANTS.samePageTab) {
            target = "_parent";
        } else if (targetName === CONSTANTS.newPageTab) {
            target = "_blank";
        }
        window.open(redirectPage, target);
    },
    /* function to handle same page option  */
    samePageOption: function (userInputPanel, selectedMessageOption) {
        if (selectedMessageOption === CONSTANTS.samePagefixedSite) {
            tempUserInputPanel = userInputPanel;
        }
        //Thank you, Error panel configurations irrespective of server response
        if (selectedMessageOption === CONSTANTS.samePagefadeOutSite) {
            if (GLOBAL.returnStatus == "success") {
                metLifeHeaderFunctions.resetForm(userInputPanel);
                var delayInSeconds = document.getElementById(CONSTANTS.fadeOutTimer).value;
                setTimeout(function () {
                    $('.contact-close').trigger('click');
                    metLifeHeaderFunctions.reloadAemForm(userInputPanel);
                }, delayInSeconds * 1000);
            } else {
                var delayInSeconds = document.getElementById(CONSTANTS.fadeOutTimer).value;
                setTimeout(function () {
                    $("#contactus_lead_submit_error").fadeOut(500);
                    $("#contactus_lead_thankyou").fadeOut(500);
                    userInputPanel.visible = true;
                    $("#guideContainer-rootPanel-userInputPanel___guide-item").fadeIn(500);
                }, delayInSeconds * 1000);
            }

        }
    },
    /* removes the error or success submit message function post time out */
    removeErrorClass: function (userInputPanel) {
        setTimeout(function () {
            $("#contactus_lead_submit_error").fadeOut(500);
            $("#contactus_lead_thankyou").fadeOut(500);
            userInputPanel.visible = true;
            $("#guideContainer-rootPanel-formTitlePanel___guide-item-container").show();
            $("#guideContainer-rootPanel-userInputPanel___guide-item").fadeIn(500);
        }, 500);
        $("#contactus_lead_submit_error").fadeOut(500);
        $("#contactus_lead_thankyou").fadeOut(500);
        $(".validation-failure").removeClass("validation-failure");
        $('.guideFieldError').css('display', 'none');
    },
    // Reload the Aem form after success or error for contact us click
    reloadAemForm: function (userInputPanel) {
        metLifeHeaderFunctions.resetForm(userInputPanel);
        $("#contactus_lead_submit_error").fadeOut(500);
        $("#contactus_lead_thankyou").fadeOut(500);
        userInputPanel.visible = true;
        $("#guideContainer-rootPanel-userInputPanel___guide-item").fadeIn(500);
    },
    // Reload the Aem form after success or error for contact us click
    callAemForm: function (sitedata, formPath) {

        $.ajax({
            type: 'GET',
            // formPath should be till the from Ex <div class="formPath">/content/dam/formsanddocuments/sidebar</div>
            url: formPath + "/jcr:content?wcmmode=disabled",
            success: function (data) {
                $("div.contactSideForm").empty();
                for (var i = 0; i < sitedata.length; i++) {
                    if($(sitedata[i]).attr('id') != undefined){
                        if (!$(sitedata[i]).attr('id').includes("guideContainer")) {
                            $("div.contactSideForm").append(sitedata[i]);
                        }
                    }
                }
                $("div.contactOtherDetails").remove();
                $("div.contactSideForm").append(data);

                customFunctions.initializeFormFields();
            }
        });
    }

}; //Closing metLifeFunctions variable
/*
 set of functions written for Email Back End Integration
 Main function is emailSubmitProcessAsyncCall which is triggered on submit of the form associated with email template
 */
var metLifeEmailFunctions = {
    /* submit function to be triggered on submit of form 	*/
    emailSubmitProcessAsyncCall: function (userInputPanel, thankYouErrorMsgPanel, guideRootPanel, aemFormID) {
        window.top.$(".gated-overlay-close-cta").addClass("hidden");
        /* initialization of dom based on type of form - slider or non slider	*/
        var sliderEnabled = CONSTANTS.emptyString;
        var selectedMessageOption = CONSTANTS.emptyString;
        if (guideRootPanel.authorInputPanel.typeOfTheme.value !== 'slider') {
            sliderEnabled = CONSTANTS.no;
        }

        var uniqueID = metLifeFunctions.uniqueID();

        if (sliderEnabled === CONSTANTS.no) {
            /* Handling scroll bar for thank you or error panel	*/
            if (parent.document.getElementById(CONSTANTS.AEMFORMNAME) != null) {
                parent.document.getElementById(CONSTANTS.AEMFORMNAME).scrolling = CONSTANTS.no;
            }
            selectedMessageOption = thankYouErrorMsgPanel.messageOptionDropDown.value;
            if (selectedMessageOption !== CONSTANTS.newPage) {
                $("#guideContainer-rootPanel-userInputPanel___guide-item").fadeOut(500);
                $("#guideContainer-rootPanel-thankYouErrorMsgPanel___guide-item").fadeIn(500);
            }
        } else {
            document.getElementsByClassName(CONSTANTS.contactSliderOuterCon).disabled = true;
        }


        /* Time out function defined for triggering AJAX call	*/
        setTimeout(function () {
            guideBridge.getDataXML({
                success: function (guideResultObject) {

                    /* declaring variables to be used  */
                    var finaljsonObj = customFunctions.getJsonObjFromResultObj(guideResultObject, guideRootPanel);
                    var targetName = CONSTANTS.emptyString;
                    var redirectPage = CONSTANTS.emptyString;

                    if (sliderEnabled === CONSTANTS.no) {
                        targetName = thankYouErrorMsgPanel.optionThreePanel.pageTargetDropDown.value;
                    } else {
                        selectedMessageOption = document.getElementById(CONSTANTS.msgDisplayType).value;
                        targetName = document.getElementById(CONSTANTS.openIn).value;
                    }

                    if (sliderEnabled === CONSTANTS.no) {
                        if (selectedMessageOption === CONSTANTS.samePageFadeOut || selectedMessageOption === CONSTANTS.samePageFixed) {
                            userInputPanel.visible = false;
                            $("#guideContainer-rootPanel-formTitlePanel___guide-item-container").hide();
                            thankYouErrorMsgPanel.messageOptionDropDown.visible = false;
                            thankYouErrorMsgPanel.visible = true;
                        }
                    } else {
                        if (selectedMessageOption === CONSTANTS.samePagefadeOutSite || selectedMessageOption === CONSTANTS.samePagefixedSite) {
                            userInputPanel.visible = false;
                            $("#guideContainer-rootPanel-formTitlePanel___guide-item-container").hide();
                            document.getElementsByClassName(CONSTANTS.contactSideThankyou).disabled = false;
                        }
                    }

                    /* creating form object to be passed as parameter to ajax call */
                    if ($(".quote-results-form", window.parent.document).length > 0) {
                        if (window.sessionStorage.length > 0) {
                            var string = JSON.stringify(window.sessionStorage);
                            string = string.replace(/[{()}]/g, '');
                            finaljsonObj.quoteinfo = string;
                        }
                    }

                    var proxyValue = "";

                    if (typeof guideRootPanel.authorInputPanel.typeOfBackendInt == "undefined")
                        proxyValue = metLifeEmailFunctions.getEmailProxy(guideRootPanel.authorInputPanel.country.value, "email");
                    else
                        proxyValue = metLifeEmailFunctions.getEmailProxy(guideRootPanel.authorInputPanel.country.value, guideRootPanel.authorInputPanel.typeOfBackendInt.value);

                    finaljsonObj["typeOfBackendInt"] = proxyValue;

                    var formData;
                    console.log(customFunctions.getProxyUrl("proxyConfigurations", proxyValue));
                    if(customFunctions.getProxyUrl("proxyConfigurations", proxyValue) == "AGLU"){
                        formData = JSON.stringify(finaljsonObj);
                    }else{
                        var form = metLifeEmailFunctions.getForm(finaljsonObj);
                        $(form).hide();
                        formData = new FormData(form);
                    }


                    $.ajax({
                        url: CONSTANTS.emailServlet,
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        headers: {"x-csrf-token": uniqueID},
                        /* handling of success call */
                        success: function (data) {
                            GLOBAL.returnStatus = CONSTANTS.success;
                            //analytics function call
                            metlife_analytics_functions.onFormCompleteEvent(guideRootPanel);
                            // Handle Success Thank you, Error panel configurations based on successful response 
                            // handling for slider and non slider conditions
                            if (sliderEnabled !== CONSTANTS.no) {
                                if (selectedMessageOption === CONSTANTS.newPageSite) {
                                    $('.contact-close').trigger('click');
                                    metLifeHeaderFunctions.reloadAemForm(userInputPanel);
                                    redirectPage = document.getElementById(CONSTANTS.thankYouMsgUrl).value;
                                    metLifeHeaderFunctions.openIn(redirectPage, targetName);
                                } else {
                                    //Updating For Overlap issue if success
                                    $("#guideContainer-rootPanel-formTitlePanel___guide-item-container").hide();
                                    $("#guideContainer-rootPanel-userInputPanel___guide-item").fadeOut(500);
                                    $("#contactus_lead_thankyou").fadeIn(500);
                                }
                                metLifeHeaderFunctions.samePageOption(userInputPanel, selectedMessageOption);
                            } else {
                                if (selectedMessageOption === CONSTANTS.newPage) {
                                    $("#guideContainer-rootPanel-userInputPanel___guide-item").fadeIn(500);
                                    redirectPage = thankYouErrorMsgPanel.optionThreePanel.thankYouPageTextBox.value;
                                    metLifeFunctions.openIn(redirectPage, targetName);
                                } else {
                                    var element = parent.document.getElementById(aemFormID);
                                    if ($(element).closest(".contactCard").find(".thank-you-overlay-parsys").length > 0) {
                                        $(element).closest(".contactCard").find(".thank-you-overlay-parsys").removeClass("hidden");
                                    }
                                    if ($(element).closest(".gated-overlay__container").find(".thank-you-overlay-parsys").length > 0) {
                                        var element = parent.document.getElementById(aemFormID);
                                        var aemFormElementID = $(element).closest(".gated-overlay__container").attr("id");

                                        var aemForms = "";
                                        if (sessionStorage.getItem("gatedFormSubmittedID") != null) {
                                            aemForms = sessionStorage.getItem("gatedFormSubmittedID") + aemFormElementID + ",";
                                        } else {
                                            aemForms = aemFormElementID + ",";
                                        }
                                        sessionStorage.setItem("gatedFormSubmittedID", aemForms);
                                        if ($(element).closest(".lead-gen-breaker").length == 0) {
                                            sessionStorage.setItem("gatedForm", "completed");
                                            sessionStorage.setItem("gatedFormContent", JSON.stringify(finaljsonObj));
                                        } else {
                                            sessionStorage.setItem("leadGenBreaker", "completed");
                                        }
                                        window.top.$(".gated-overlay-close-cta").removeClass("hidden");
                                        $(element).closest(".gated-overlay__container").find(".thank-you-overlay-parsys").removeClass("hidden");
                                    }
                                    if($(element).closest(".component.hero-progressive-form").length > 0){
                                        window.top.$(element, window.parent.document).closest(".component.hero-progressive-form").find(".hero-progressive-form__rightsection .hero-progressive-form__formcontainer .hero-progressive-form__progresscontainer .hero-progressive-form__progressfields .hero-progressive-form__progressfielditem:last-child").removeClass("in-progress").addClass('completed');
                                    }
                                    if (window.top.$(".results-form__wrapper .results-form__text", window.parent.document).length > 0) {
                                        window.top.$(".results-form__wrapper .results-form__text", window.parent.document).hide();
                                        window.top.$(".results-form__wrapper .results-form__inputs", window.parent.document).addClass("full-width");
                                    }
                                    if($(element).closest(".embedded-lead-form").length > 0) {
                                    	metLifeFunctions.embeddedLeadSubmit();
                                    }
                                    metLifeFunctions.samePageSuccessOption(thankYouErrorMsgPanel, userInputPanel, aemFormID);
                                }

                            }
                        }, // success closed
                        /* handling of error call */
                        error: function () {
                            //Thank you, Error panel configurations based on failure response
                            //analytics function call
                            metlife_analytics_functions.onFormErrorEvent(guideRootPanel);
                            if (sliderEnabled !== CONSTANTS.no) {
                                if (selectedMessageOption === CONSTANTS.newPageSite) {
                                    $('.contact-close').trigger('click');
                                    metLifeHeaderFunctions.reloadAemForm(userInputPanel);
                                    redirectPage = document.getElementById(CONSTANTS.errorMsgUrl).value;
                                    metLifeHeaderFunctions.openIn(redirectPage, targetName);
                                } else {
                                    GLOBAL.returnStatus = "error";
                                    //Updating For Overlap issue if error
                                    $("#guideContainer-rootPanel-formTitlePanel___guide-item-container").hide();
                                    $("#guideContainer-rootPanel-userInputPanel___guide-item").fadeOut(500);
                                    $("#contactus_lead_submit_error").fadeIn(500);
                                }
                                metLifeHeaderFunctions.samePageOption(userInputPanel, selectedMessageOption);
                            } else {
                                if (selectedMessageOption === CONSTANTS.newPage) {
                                    $("#guideContainer-rootPanel-userInputPanel___guide-item").fadeIn(500);
                                    redirectPage = thankYouErrorMsgPanel.optionThreePanel.errorPageTextBox.value;
                                } else {
                                    if (window.top.$(".results-form__wrapper .results-form__text", window.parent.document).length > 0) {
                                        window.top.$(".results-form__wrapper .results-form__text", window.parent.document).hide();
                                        window.top.$(".results-form__wrapper .results-form__inputs", window.parent.document).addClass("full-width");
                                    }
                                    thankYouErrorMsgPanel.optionOneTwoPanel.visible = true;
                                    thankYouErrorMsgPanel.optionOneTwoPanel.errorMessage.visible = true;
                                    thankYouErrorMsgPanel.optionOneTwoPanel.errorMessageText.visible = true;
                                    window.guideBridge.setFocus(thankYouErrorMsgPanel.optionOneTwoPanel.errorMessage.somExpression, CONSTANTS.firstItem, false);
                                    metLifeFunctions.contactFormCardSubmit();
                                    GLOBAL.returnStatus = "error";
                                }
                            }
                        } //error closed
                    }); // Ajax ended
                }, // Success guidebridge ended

                error: function (guideResultObject) {
                    guideBridge._guide.logger().log(guideResultObject);
                } // error guideBridge ended
            }); //Closing guideBridge.getDataXML
        }, 500); //Closing setTimeOut
    }, //Closing submitProcessAsyncCall function

    /* get Form function defined for getting form object for Ajax call */
    getForm: function (finaljsonObj) {
        var form = document.createElement(CONSTANTS.form);
        form.setAttribute(CONSTANTS.enctype, CONSTANTS.multipart);

        for (var key in finaljsonObj) {
            if (finaljsonObj.hasOwnProperty(key)) {
                var emailData = document.createElement(CONSTANTS.input);
                if (key === CONSTANTS.ToEmailId) {
                    emailData.setAttribute(CONSTANTS.name, CONSTANTS.id);
                    emailData.setAttribute(CONSTANTS.value, finaljsonObj[key]);
                } else {
                    emailData.setAttribute(CONSTANTS.name, key);
                    emailData.setAttribute(CONSTANTS.value, finaljsonObj[key]);
                }
                form.appendChild(emailData);
            }
        }
        return form;
    },
    getEmailProxy: function (country, backendIntegration) {
        if (country == "USA" && backendIntegration == "email")
            return "WebForms-Email-US";
        if (country == "USA" && backendIntegration == "kana")
            return "KANA-Email-US";
        else
            return "Webforms-Email-International";
    }
}; //Closing metLifeEmailFunctions variable
$(document).ready(function () {
    $(".fileUpload").find("input").removeAttr("multiple");

    $(".guidefileupload").find("label").on("click", function (e) {
        e.preventDefault();
    });

    $(".fileupload").on('click', '.fileInProgressClose', function (event) {
        var $this = $(".fileupload");
        $this.find(".guide-fu-fileItemList li:last-child").find('.guide-fu-fileClose').trigger('click');
        $this.find('.guideFieldTooltip').remove();
        $(".fileUploadHelpText").show();
        fileUploadFunctions.enableFileUploadButton();
    });
    if (!String.prototype.endsWith) {
        String.prototype.endsWith = function (search, this_len) {
            if (this_len === undefined || this_len > this.length) {
                this_len = this.length;
            }
            return this.substring(this_len - search.length, this_len) === search;
        };
    }
});
var attachmentInfoJSON = [];
var fileUploadFunctions = {
    handleFileUploadChange: function (event) {
        var fileItems = $(".fileupload .guide-fu-fileItem").length;
        var fileCount = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].authorInputPanel[0].fileCount[0]");
        if (fileItems <= fileCount.value) {
            data = $(event.target);
            var fileObject = data[0].files;
            var mimeType = fileObject[0].type;
            if (fileObject[0].name != undefined && (fileObject[0].name.toLowerCase().endsWith(".msg") || fileObject[0].name.toLowerCase().endsWith(".eml"))) {
                if (mimeType != undefined && mimeType.length > 0) {
                    console.log("File mimeType exists: " + mimeType);
                } else {
                    mimeType = "application/vnd.ms-outlook";
                }
            }
            $('.fileupload').find('.guideFieldError').hide();
            $('.fileupload').removeClass("validation-failure");
            $('.afFileUpload.fileUpload button').removeClass("validation-failure");
            if (fileObject != undefined && fileUploadFunctions.handleFileTypeRestriction($(".fileUpload").find("input").attr("accept"), mimeType)) {
                $(".guideFieldNode.submitButton ").find("button").attr("disabled", "disabled").css("opacity", "0.3");
                $(".guide-fu-attach-button").attr("disabled", "disabled").css({"color": "#b1acac", "cursor": "auto"});
                if (fileItems > 0 && !$(".guide-fu-attach-button").data("multiselect")) {
                    $(".loader").addClass("d-none");
                    $('.fileupload').find('button').hide();
                    $(".fileUploadHelpText").hide();
                } else {

                }
                fileUploadFunctions.readFileData(fileObject, this);
            } else {
            }
        } else {
            $('.fileupload').find('button').hide();
        }
        if (window.top.window.CampaignContainerModule != undefined) {
            window.top.window.CampaignContainerModule.campaignRightRailSticky();
        }
    },

    fileSizeLimit: function (currentFileSize) {
        var fileListSize = 0;
        var validFileSizeLimit = true;
        var maxFileSizeLimit = $(".guide-fu-attach-button").data("filesizelimit");
        $(".fileupload .guide-fu-fileItem span.guide-fu-fileName").each(function () {
            fileListSize = fileListSize + $(this).data("filesize");
        });
        fileListSize = fileListSize + currentFileSize;
        if (maxFileSizeLimit < fileListSize) {
            validFileSizeLimit = false;
        }
        return validFileSizeLimit;
    },
    readFileData: function (fileObject, obj) {
        var file = fileObject[0];
        var blob = file.slice();
        var reader = new FileReader();
        var fileName = file.name;
        var fileContent;
        reader.onload = function (event) {
            if (event.target.readyState == FileReader.DONE) {
                fileContent = fileUploadFunctions.getB64Str(reader.result);
                fileUploadFunctions.scanFileUploadDocument(fileContent, fileName);
            }
        };
        reader.readAsArrayBuffer(blob);
    },
    getB64Str: function (buffer) {
        var binary = '';
        var bytes = new Uint8Array(buffer);
        var len = bytes.byteLength;
        for (var i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    },

    scanFileUploadDocument: function (fileContent, fileName) {
        var documentContentJSON = {
            "documents": [{
                "content": fileContent,
                "fileName": fileName
            }]
        };

        var attachmentInProgress = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].authorInputPanel[0].scanInProgress[0]");
        var attachmentVirusFound = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].authorInputPanel[0].virusFound[0]");
        var serviceDown = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].authorInputPanel[0].serviceDown[0]");
        $(".fileupload").find('.guideFieldTooltip').remove();
        var attachmentInProgressSpan = "<div class='guideFieldTooltip'><span>" + attachmentInProgress.value + "</span><span class='fileInProgressClose'><svg class='icon icon-close'><use xlink:href='/static/images/icons-metlife.svg#icon-close'></use></svg></span></div>";

        var uniqueID = metLifeFunctions.uniqueID();

        var uploadedFileName=documentContentJSON.documents[0].fileName;
        var fileLength = uploadedFileName.length;
        if(fileLength<15){
            uploadedFileName = uploadedFileName;
        }
        else{
            var name1= uploadedFileName.substr(0,10);
            var name2=" ...";
            var name3=uploadedFileName.substr(uploadedFileName.lastIndexOf(".")+1,uploadedFileName.length);
            uploadedFileName=name1.concat(name2,name3);
        }
        $(".guide-fu-attach-button .fileName").html(uploadedFileName);
        $(".loader").removeClass("d-none");
        $.ajax({
            url: "/bin/MLApp/familyReunion",
            type: "POST",
            headers: {"x-csrf-token": uniqueID},
            dataType: "json",
            data: {
                documents:JSON.stringify(documentContentJSON),
                endPointService: "documentScan"
            },
            success: function (data, status, xhr) {
                fileUploadFunctions.enableFileUploadButton();
                $(".fileupload .guide-fu-fileItemList").removeClass("hidden");
                if (xhr.status == 200) {
                    var responseStatus = data.result[0].statusCode;
                    if (responseStatus == 200) {
                        if ($(".guide-fu-fileItemList li:last-child").hasClass("hidden")) {
                            $(".fileupload .guide-fu-fileItem").removeClass("hidden");
                            fileUploadFunctions.setSelectedAttachmentInfo(fileName, fileContent);
                            var fileText = $(".fileupload input").attr('aria-label');
                            $(".guide-fu-attach-button .fileName").html(fileText);
                            $(".loader").addClass("d-none");
                            var fileListLength = $('.guide-fu-fileItem').length;
                            var fileCount = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].authorInputPanel[0].fileCount[0]");
                            if (fileListLength > 0) {
                                if ($(".guide-fu-attach-button").data("multiselect")) {
                                    var uploadMoreText = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].authorInputPanel[0].uploadMore[0]");
                                    var uploadButtonName =  $(".guide-fu-attach-button .button").text();
                                    $(".guide-fu-attach-button .button").text(uploadButtonName);
                                    if (fileListLength == fileCount.value) {
                                        $('.fileupload').find('button').hide();
                                    }
                                } else {
                                    $('.fileupload').find('button').hide();
                                }
                            }
                        } else {
                            fileUploadFunctions.clearSelectedAttachmentInfo(fileName);
                            $(".fileUploadHelpText").show();
                        }

                    } else {
                        fileUploadFunctions.handleFileUploadErrorScenarios(fileName, attachmentVirusFound.value);
                    }
                } else {
                    fileUploadFunctions.handleFileUploadErrorScenarios(fileName, serviceDown.value);
                }
            },
            error: function () {
                fileUploadFunctions.handleFileUploadErrorScenarios(fileName, serviceDown.value);
            }
        });
    },
    handleFileUploadErrorScenarios: function (fileName, erroMessage) {
        fileUploadFunctions.enableFileUploadButton();
        $('.fileupload').find('button').show();
        $(".loader").addClass("d-none");
        fileUploadFunctions.clearVirusInfectedFile(fileName);
        $('.fileupload').find('.guideFieldError').show().html(erroMessage);
        $('.fileupload').addClass("validation-failure");
        $('.afFileUpload.fileUpload button').addClass("validation-failure");
        fileUploadFunctions.clearSelectedAttachmentInfo(fileName);
        $(".fileupload").find('.guideFieldTooltip').remove();
    },
    enableFileUploadButton: function () {
        $(".guideFieldNode.submitButton ").find("button").removeAttr("disabled").css("opacity", "1");
        $(".guide-fu-attach-button").removeAttr("disabled").removeAttr("style");
    },

    clearVirusInfectedFile: function (fileName) {
        $(".fileupload .guide-fu-fileItem ").each(function () {
            if ($(this).find("span.guide-fu-fileName").attr("title") == fileName) {
                $(this).find(".guide-fu-fileClose").trigger('click');
            }
        });
    },
    handleFileUploadError: function () {
        var invalidFileTypeError = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].authorInputPanel[0].inValidFileType[0]");
        $('.fileupload').find('.guideFieldError').show().html(invalidFileTypeError.value);
        $('.fileupload').addClass("validation-failure");
        $('.afFileUpload.fileUpload button').addClass("validation-failure");
        $(".fileupload").find('.guideFieldTooltip').remove();
    },
    setSelectedAttachmentInfo: function (name, content) {
        var attachmentInfoInput = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].systemGeneratedPanel[0].attachmentInfo[0]");
        var attachmentInfo = {"attachmentFileName": name, "attachmentContent": content};
        attachmentInfoJSON.push(attachmentInfo);
        console.log("JSON.stringify(attachmentInfoJSON)   " + attachmentInfoJSON);
        attachmentInfoInput.value = JSON.stringify(attachmentInfoJSON);
    },
    getIndexofFile: function (fileName) {
        var index = -1;
        attachmentInfoJSON.forEach(function (item, i) {
            if (item.attachmentFileName === fileName) {
                index = i;
                return i;
            }
        });
        return index;
    },
    clearSelectedAttachmentInfo: function (name) {
        var attachmentInfoInput = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].systemGeneratedPanel[0].attachmentInfo[0]");
        var index = fileUploadFunctions.getIndexofFile(name);
        if (index != -1) {
            attachmentInfoJSON.splice(index, 1);
        }
        console.log(attachmentInfoJSON);
        attachmentInfoInput.value = JSON.stringify(attachmentInfoJSON);
    },

    handleFileTypeRestriction: function (accept, fileType) {
        var fileType = fileType.split("/");
        var validFileType = true;
        if (accept.indexOf(fileType[0]) != -1) {
            switch (fileType[0]) {
                case "image":
                    break;
                case "text":
                    break;
                case "application":
                    if (accept.indexOf(fileType[1]) != -1) {
                    } else {
                        fileUploadFunctions.handleFileUploadError();
                        validFileType = false;
                    }
                    break;
                case "message":
                    if (accept.indexOf(fileType[1]) != -1) {
                    } else {
                        fileUploadFunctions.handleFileUploadError();
                        validFileType = false;
                    }
                    break;
                default:
                    fileUploadFunctions.handleFileUploadError();
                    validFileType = false;
                    break;
            }
        } else {
            fileUploadFunctions.handleFileUploadError();
            validFileType = false;
        }
        return validFileType;
    }
};
/*
 Analytics functions for generating data layer
 js code to trigger different analytics events i.e form start, form complete, form abandon and form complete.It call the metlife custom fuction to form the json data to send it to analytics server.
 */
var metlife_analytics_functions = {
    /* Form Start Event */
    onFormStartEvent: function () {
        parent.digitalData.eventTrack('formStart', JSON.parse(customFunctions.getFormFieldsJSON('formStart', null)));
    },

    /* Form Error Event */
    onFormErrorEvent: function (guideRootPanel) {
        parent.digitalData.eventTrack('formError', JSON.parse(customFunctions.getFormFieldsJSON('formError', guideRootPanel)));
        metlife_analytics_functions.clearFormAbandonData();
    },

    /* Form Complete Event */
    onFormCompleteEvent: function (guideRootPanel) {
        var index = forms.indexOf(customFunctions.getFormId());
        if (index > -1) {
            forms.splice(index, 1);
        }
        parent.digitalData.eventTrack('formComplete', JSON.parse(customFunctions.getFormFieldsJSON('formComplete', guideRootPanel)));
        metlife_analytics_functions.clearFormAbandonData();
    },

    /* Abandonment Event data tracking for last filed */
    clearFormAbandonData: function () {
        if (typeof parent.digitalData != 'undefined') {
            parent.digitalData.formInfo = {};
        }
        if (typeof digitalData != 'undefined') {
            digitalData.formInfo = {};
        }
    },

    /* Abandonment Event data tracking for reloading page,
     * closing page, inputting a new url, redirecting to a new page
     */
    onFormAbandonEvent: function() {
        parent.digitalData.eventTrack('formAbandon', JSON.parse(customFunctions.getFormFieldsJSON('formAbandon', null)));
        console.log("formAbandon analytics event triggered: " + GLOBAL.formAbandon);
    },

    /* iframe load event data tracking */
    iFrameLoadEvent: function() {
        parent.digitalData.eventTrack('iFrameLoad', JSON.parse(customFunctions.getFormFieldsJSON('iFrameLoad', null)));
    }

}; //Closing metLifeFunctions variable
$(".contactCard .aemform-minimize svg", window.parent.document).click(function () {
    var node = null;
    try {
        node = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].authorInputPanel[0].typeOfTheme[0]");
        if (node != null && node.value === 'contactCardForm') {
			$(".contactCard .aemform-minimize", window.parent.document).focus();
            var userInputPanel = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].userInputPanel[0]");
            metLifeFunctions.resetForm(userInputPanel);
            var notFixedUserPanel = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].userInputPanel[0].userInputNotFixedPanel[0]");
            notFixedUserPanel.visible = false;
            $(".contactCard .aemform-minimize", window.parent.document).addClass("hidden-field");
			window.guideBridge.setFocus(window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].userInputPanel[0].userInputFixedPanel[0]").somExpression, CONSTANTS.firstItem, false);
            $(".aemformcontainer .DisclaimerSectionH3").addClass("hidden");
        }
    } catch (err) {
        console.log("Error in loading" + err);
    }

    if ((window.top.window.UtilityModule.getViewport() == "tablet") || (window.top.window.UtilityModule.getViewport() == "desktop")) {
        $(".aemformcontainer .MetLifeFormHeaderH2 p").hide();
    }

});

$(".contactCard .aemform-minimize", window.parent.document).on("keyup", function (e) {
    if (e.keyCode == 13) {
        var node = null;
        try {
            node = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].authorInputPanel[0].typeOfTheme[0]");
            if (node != null && node.value === 'contactCardForm') {
                var userInputPanel = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].userInputPanel[0]");
                metLifeFunctions.resetForm(userInputPanel);
                var notFixedUserPanel = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].userInputPanel[0].userInputNotFixedPanel[0]");
                notFixedUserPanel.visible = false;
                $(".contactCard .aemform-minimize", window.parent.document).addClass("hidden-field");
                window.guideBridge.setFocus(window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].userInputPanel[0].userInputFixedPanel[0]").somExpression, CONSTANTS.firstItem, false);
                $(".aemformcontainer .DisclaimerSectionH3").addClass("hidden");
            }
        } catch (err) {
            console.log("Error in loading" + err);
        }

        if ((window.top.window.UtilityModule.getViewport() == "tablet") || (window.top.window.UtilityModule.getViewport() == "desktop")) {
            $(".aemformcontainer .MetLifeFormHeaderH2 p").hide();
        }
    }

});

$(window).on('load', function () {
    var node = null;
    try {
        node = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].authorInputPanel[0].typeOfTheme[0]");

        if (node != null && node.value === 'contactCardForm') {
            window.top.$('.contactCard.hidden').removeClass("hidden");
            var notFixedUserPanel = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].userInputPanel[0].userInputNotFixedPanel[0]");
            $(".contactCard .aemform-minimize", window.parent.document).addClass("hidden-field");
            if (window.top.window.UtilityModule.getViewport() != "mobile") {
                notFixedUserPanel.visible = false;
                $(".aemformcontainer .DisclaimerSectionH3").addClass("hidden");
            }


        } else if (node != null && node.value === 'siteComponent') {
            window.top.$('.aemcampaignform.hidden').removeClass("hidden");
            customFunctions.initializeCheckBoxRadioToolTips();
        }
    } catch (err) {
        console.log("Error in loading" + err);
    }
    if (window.top.window.UtilityModule.getViewport() == "mobile") {
        $(".aemformcontainer").addClass("aem-form-mobile");
        $(".aemformcontainer").removeClass("aem-form-tablet");
        $(".aemformcontainer").removeClass("aem-form-desktop");

    } else if (window.top.window.UtilityModule.getViewport() == "tablet") {
        $(".aemformcontainer").addClass("aem-form-tablet");
        $(".aemformcontainer").removeClass("aem-form-mobile");
        $(".aemformcontainer").removeClass("aem-form-desktop");

    } else if (window.top.window.UtilityModule.getViewport() == "desktop") {
        $(".aemformcontainer").addClass("aem-form-desktop");
        $(".aemformcontainer").removeClass("aem-form-tablet");
        $(".aemformcontainer").removeClass("aem-form-mobile");

    }

    setTimeout(
        function () {
            var h = window.top.$('.contact-container--form-card').outerHeight();
            window.top.$('.form-card__img__inner').css('height', h + 'px');
            window.top.$('.contact-container--form-card').css('min-height', h + 'px');
        }, 500);
    /************Height Adjustment for Quote-results Component*********************/
    setTimeout(
        function () {
            var h = window.top.$('.results-form__wrapper').outerHeight();
            window.top.$('.results-card__premium-card__container').css('height', h + 'px');
            window.top.$('.results-form__wrapper').css('min-height', h + 'px');
        }, 500);

    $(".guideFieldWidget input[type='radio']").focusin(function () {
        $(this).closest(".guideRadioButtonItem").find("label").addClass("focus-label");

    });
    $(".guideFieldWidget input[type='radio']").focusout(function () {
        $(this).closest(".guideRadioButtonItem").find("label").removeClass("focus-label");

    });

});


parent.window.onresize = function (event) {

    $(".contactCard .aemform-minimize svg", window.parent.document).removeAttr('style');
    if (window.top.window.UtilityModule.getViewport() == "mobile") {
        $(".aemformcontainer").addClass("aem-form-mobile");
        $(".aemformcontainer").removeClass("aem-form-tablet");
        $(".aemformcontainer").removeClass("aem-form-desktop");

    } else if (window.top.window.UtilityModule.getViewport() == "tablet") {
        $(".aemformcontainer").addClass("aem-form-tablet");
        $(".aemformcontainer").removeClass("aem-form-mobile");
        $(".aemformcontainer").removeClass("aem-form-desktop");

    } else if (window.top.window.UtilityModule.getViewport() == "desktop") {
        $(".aemformcontainer").addClass("aem-form-desktop");
        $(".aemformcontainer").removeClass("aem-form-tablet");
        $(".aemformcontainer").removeClass("aem-form-mobile");

    }

    var node = null;
    try {
        node = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].authorInputPanel[0].typeOfTheme[0]");

        if (node != null && node.value === 'contactCardForm') {
            var notFixedUserPanel = window.guideBridge.resolveNode("guide[0].guide1[0].guideRootPanel[0].userInputPanel[0].userInputNotFixedPanel[0]");
            if (window.top.window.UtilityModule.getViewport() == "mobile") {
                notFixedUserPanel.visible = true;
                $(".aemformcontainer .DisclaimerSectionH3").removeClass("hidden");
                $(".contactCard .aemform-minimize", window.parent.document).addClass("hidden-field");
                window.top.$('.contact-container--form-card').css('min-height', 20 + 'px');
                customFunctions.initializeCheckBoxRadioToolTips();
            }
            if (window.top.window.UtilityModule.getViewport() != "mobile") {
                if (notFixedUserPanel.visible) {
                    $(".aemformcontainer .DisclaimerSectionH3").removeClass("hidden");
                    window.top.$(".contactCard .aemform-minimize", window.parent.document).removeClass("hidden-field");
                    window.top.$('.contact-container--form-card, .contactCard .aemform-minimize').removeAttr('style');
                } else {
                    $(".aemformcontainer .DisclaimerSectionH3").addClass("hidden");
                    window.top.$(".contactCard .aemform-minimize", window.parent.document).addClass("hidden-field");
                    window.top.$('.contact-container--form-card').removeAttr('style');
                }

            }

        }
    } catch (err) {
        console.log("Error in loading" + err);
    }
};

/*!
 * typeahead.js 0.11.1
 * https://github.com/twitter/typeahead.js
 * Copyright 2013-2015 Twitter, Inc. and other contributors; Licensed MIT
 */

(function (root, factory) {
    if (typeof define === "function" && define.amd) {
        define("bloodhound", ["jquery"], function (a0) {
            return root["Bloodhound"] = factory(a0);
        });
    } else if (typeof exports === "object") {
        module.exports = factory(require("jquery"));
    } else {
        root["Bloodhound"] = factory(jQuery);
    }
})(this, function ($) {
    var _ = function () {
        "use strict";
        return {
            isMsie: function () {
                return /(msie|trident)/i.test(navigator.userAgent) ? navigator.userAgent.match(/(msie |rv:)(\d+(.\d+)?)/i)[2] : false;
            },
            isBlankString: function (str) {
                return !str || /^\s*$/.test(str);
            },
            escapeRegExChars: function (str) {
                return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
            },
            isString: function (obj) {
                return typeof obj === "string";
            },
            isNumber: function (obj) {
                return typeof obj === "number";
            },
            isArray: $.isArray,
            isFunction: $.isFunction,
            isObject: $.isPlainObject,
            isUndefined: function (obj) {
                return typeof obj === "undefined";
            },
            isElement: function (obj) {
                return !!(obj && obj.nodeType === 1);
            },
            isJQuery: function (obj) {
                return obj instanceof $;
            },
            toStr: function toStr(s) {
                return _.isUndefined(s) || s === null ? "" : s + "";
            },
            bind: $.proxy,
            each: function (collection, cb) {
                $.each(collection, reverseArgs);
                function reverseArgs(index, value) {
                    return cb(value, index);
                }
            },
            map: $.map,
            filter: $.grep,
            every: function (obj, test) {
                var result = true;
                if (!obj) {
                    return result;
                }
                $.each(obj, function (key, val) {
                    if (!(result = test.call(null, val, key, obj))) {
                        return false;
                    }
                });
                return !!result;
            },
            some: function (obj, test) {
                var result = false;
                if (!obj) {
                    return result;
                }
                $.each(obj, function (key, val) {
                    if (result = test.call(null, val, key, obj)) {
                        return false;
                    }
                });
                return !!result;
            },
            mixin: $.extend,
            identity: function (x) {
                return x;
            },
            clone: function (obj) {
                return $.extend(true, {}, obj);
            },
            getIdGenerator: function () {
                var counter = 0;
                return function () {
                    return counter++;
                };
            },
            templatify: function templatify(obj) {
                return $.isFunction(obj) ? obj : template;
                function template() {
                    return String(obj);
                }
            },
            defer: function (fn) {
                setTimeout(fn, 0);
            },
            debounce: function (func, wait, immediate) {
                var timeout, result;
                return function () {
                    var context = this, args = arguments, later, callNow;
                    later = function () {
                        timeout = null;
                        if (!immediate) {
                            result = func.apply(context, args);
                        }
                    };
                    callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) {
                        result = func.apply(context, args);
                    }
                    return result;
                };
            },
            throttle: function (func, wait) {
                var context, args, timeout, result, previous, later;
                previous = 0;
                later = function () {
                    previous = new Date();
                    timeout = null;
                    result = func.apply(context, args);
                };
                return function () {
                    var now = new Date(), remaining = wait - (now - previous);
                    context = this;
                    args = arguments;
                    if (remaining <= 0) {
                        clearTimeout(timeout);
                        timeout = null;
                        previous = now;
                        result = func.apply(context, args);
                    } else if (!timeout) {
                        timeout = setTimeout(later, remaining);
                    }
                    return result;
                };
            },
            stringify: function (val) {
                return _.isString(val) ? val : JSON.stringify(val);
            },
            noop: function () {
            }
        };
    }();
    var VERSION = "0.11.1";
    var tokenizers = function () {
        "use strict";
        return {
            nonword: nonword,
            whitespace: whitespace,
            obj: {
                nonword: getObjTokenizer(nonword),
                whitespace: getObjTokenizer(whitespace)
            }
        };
        function whitespace(str) {
            str = _.toStr(str);
            return str ? str.split(/\s+/) : [];
        }

        function nonword(str) {
            str = _.toStr(str);
            return str ? str.split(/\W+/) : [];
        }

        function getObjTokenizer(tokenizer) {
            return function setKey(keys) {
                keys = _.isArray(keys) ? keys : [].slice.call(arguments, 0);
                return function tokenize(o) {
                    var tokens = [];
                    _.each(keys, function (k) {
                        tokens = tokens.concat(tokenizer(_.toStr(o[k])));
                    });
                    return tokens;
                };
            };
        }
    }();
    var LruCache = function () {
        "use strict";
        function LruCache(maxSize) {
            this.maxSize = _.isNumber(maxSize) ? maxSize : 100;
            this.reset();
            if (this.maxSize <= 0) {
                this.set = this.get = $.noop;
            }
        }

        _.mixin(LruCache.prototype, {
            set: function set(key, val) {
                var tailItem = this.list.tail, node;
                if (this.size >= this.maxSize) {
                    this.list.remove(tailItem);
                    delete this.hash[tailItem.key];
                    this.size--;
                }
                if (node = this.hash[key]) {
                    node.val = val;
                    this.list.moveToFront(node);
                } else {
                    node = new Node(key, val);
                    this.list.add(node);
                    this.hash[key] = node;
                    this.size++;
                }
            },
            get: function get(key) {
                var node = this.hash[key];
                if (node) {
                    this.list.moveToFront(node);
                    return node.val;
                }
            },
            reset: function reset() {
                this.size = 0;
                this.hash = {};
                this.list = new List();
            }
        });
        function List() {
            this.head = this.tail = null;
        }

        _.mixin(List.prototype, {
            add: function add(node) {
                if (this.head) {
                    node.next = this.head;
                    this.head.prev = node;
                }
                this.head = node;
                this.tail = this.tail || node;
            },
            remove: function remove(node) {
                node.prev ? node.prev.next = node.next : this.head = node.next;
                node.next ? node.next.prev = node.prev : this.tail = node.prev;
            },
            moveToFront: function (node) {
                this.remove(node);
                this.add(node);
            }
        });
        function Node(key, val) {
            this.key = key;
            this.val = val;
            this.prev = this.next = null;
        }

        return LruCache;
    }();
    var PersistentStorage = function () {
        "use strict";
        var LOCAL_STORAGE;
        try {
            LOCAL_STORAGE = window.localStorage;
            LOCAL_STORAGE.setItem("~~~", "!");
            LOCAL_STORAGE.removeItem("~~~");
        } catch (err) {
            LOCAL_STORAGE = null;
        }
        function PersistentStorage(namespace, override) {
            this.prefix = ["__", namespace, "__"].join("");
            this.ttlKey = "__ttl__";
            this.keyMatcher = new RegExp("^" + _.escapeRegExChars(this.prefix));
            this.ls = override || LOCAL_STORAGE;
            !this.ls && this._noop();
        }

        _.mixin(PersistentStorage.prototype, {
            _prefix: function (key) {
                return this.prefix + key;
            },
            _ttlKey: function (key) {
                return this._prefix(key) + this.ttlKey;
            },
            _noop: function () {
                this.get = this.set = this.remove = this.clear = this.isExpired = _.noop;
            },
            _safeSet: function (key, val) {
                try {
                    this.ls.setItem(key, val);
                } catch (err) {
                    if (err.name === "QuotaExceededError") {
                        this.clear();
                        this._noop();
                    }
                }
            },
            get: function (key) {
                if (this.isExpired(key)) {
                    this.remove(key);
                }
                return decode(this.ls.getItem(this._prefix(key)));
            },
            set: function (key, val, ttl) {
                if (_.isNumber(ttl)) {
                    this._safeSet(this._ttlKey(key), encode(now() + ttl));
                } else {
                    this.ls.removeItem(this._ttlKey(key));
                }
                return this._safeSet(this._prefix(key), encode(val));
            },
            remove: function (key) {
                this.ls.removeItem(this._ttlKey(key));
                this.ls.removeItem(this._prefix(key));
                return this;
            },
            clear: function () {
                var i, keys = gatherMatchingKeys(this.keyMatcher);
                for (i = keys.length; i--;) {
                    this.remove(keys[i]);
                }
                return this;
            },
            isExpired: function (key) {
                var ttl = decode(this.ls.getItem(this._ttlKey(key)));
                return _.isNumber(ttl) && now() > ttl ? true : false;
            }
        });
        return PersistentStorage;
        function now() {
            return new Date().getTime();
        }

        function encode(val) {
            return JSON.stringify(_.isUndefined(val) ? null : val);
        }

        function decode(val) {
            return $.parseJSON(val);
        }

        function gatherMatchingKeys(keyMatcher) {
            var i, key, keys = [], len = LOCAL_STORAGE.length;
            for (i = 0; i < len; i++) {
                if ((key = LOCAL_STORAGE.key(i)).match(keyMatcher)) {
                    keys.push(key.replace(keyMatcher, ""));
                }
            }
            return keys;
        }
    }();
    var Transport = function () {
        "use strict";
        var pendingRequestsCount = 0, pendingRequests = {}, maxPendingRequests = 6, sharedCache = new LruCache(10);

        function Transport(o) {
            o = o || {};
            this.cancelled = false;
            this.lastReq = null;
            this._send = o.transport;
            this._get = o.limiter ? o.limiter(this._get) : this._get;
            this._cache = o.cache === false ? new LruCache(0) : sharedCache;
        }

        Transport.setMaxPendingRequests = function setMaxPendingRequests(num) {
            maxPendingRequests = num;
        };
        Transport.resetCache = function resetCache() {
            sharedCache.reset();
        };
        _.mixin(Transport.prototype, {
            _fingerprint: function fingerprint(o) {
                o = o || {};
                return o.url + o.type + $.param(o.data || {});
            },
            _get: function (o, cb) {
                var that = this, fingerprint, jqXhr;
                fingerprint = this._fingerprint(o);
                if (this.cancelled || fingerprint !== this.lastReq) {
                    return;
                }
                if (jqXhr = pendingRequests[fingerprint]) {
                    jqXhr.done(done).fail(fail);
                } else if (pendingRequestsCount < maxPendingRequests) {
                    pendingRequestsCount++;
                    pendingRequests[fingerprint] = this._send(o).done(done).fail(fail).always(always);
                } else {
                    this.onDeckRequestArgs = [].slice.call(arguments, 0);
                }
                function done(resp) {
                    cb(null, resp);
                    that._cache.set(fingerprint, resp);
                }

                function fail() {
                    cb(true);
                }

                function always() {
                    pendingRequestsCount--;
                    delete pendingRequests[fingerprint];
                    if (that.onDeckRequestArgs) {
                        that._get.apply(that, that.onDeckRequestArgs);
                        that.onDeckRequestArgs = null;
                    }
                }
            },
            get: function (o, cb) {
                var resp, fingerprint;
                cb = cb || $.noop;
                o = _.isString(o) ? {
                    url: o
                } : o || {};
                fingerprint = this._fingerprint(o);
                this.cancelled = false;
                this.lastReq = fingerprint;
                if (resp = this._cache.get(fingerprint)) {
                    cb(null, resp);
                } else {
                    this._get(o, cb);
                }
            },
            cancel: function () {
                this.cancelled = true;
            }
        });
        return Transport;
    }();
    var SearchIndex = window.SearchIndex = function () {
        "use strict";
        var CHILDREN = "c", IDS = "i";

        function SearchIndex(o) {
            o = o || {};
            if (!o.datumTokenizer || !o.queryTokenizer) {
                $.error("datumTokenizer and queryTokenizer are both required");
            }
            this.identify = o.identify || _.stringify;
            this.datumTokenizer = o.datumTokenizer;
            this.queryTokenizer = o.queryTokenizer;
            this.reset();
        }

        _.mixin(SearchIndex.prototype, {
            bootstrap: function bootstrap(o) {
                this.datums = o.datums;
                this.trie = o.trie;
            },
            add: function (data) {
                var that = this;
                data = _.isArray(data) ? data : [data];
                _.each(data, function (datum) {
                    var id, tokens;
                    that.datums[id = that.identify(datum)] = datum;
                    tokens = normalizeTokens(that.datumTokenizer(datum));
                    _.each(tokens, function (token) {
                        var node, chars, ch;
                        node = that.trie;
                        chars = token.split("");
                        while (ch = chars.shift()) {
                            node = node[CHILDREN][ch] || (node[CHILDREN][ch] = newNode());
                            node[IDS].push(id);
                        }
                    });
                });
            },
            get: function get(ids) {
                var that = this;
                return _.map(ids, function (id) {
                    return that.datums[id];
                });
            },
            search: function search(query) {
                var that = this, tokens, matches;
                tokens = normalizeTokens(this.queryTokenizer(query));
                _.each(tokens, function (token) {
                    var node, chars, ch, ids;
                    if (matches && matches.length === 0) {
                        return false;
                    }
                    node = that.trie;
                    chars = token.split("");
                    while (node && (ch = chars.shift())) {
                        node = node[CHILDREN][ch];
                    }
                    if (node && chars.length === 0) {
                        ids = node[IDS].slice(0);
                        matches = matches ? getIntersection(matches, ids) : ids;
                    } else {
                        matches = [];
                        return false;
                    }
                });
                return matches ? _.map(unique(matches), function (id) {
                    return that.datums[id];
                }) : [];
            },
            all: function all() {
                var values = [];
                for (var key in this.datums) {
                    values.push(this.datums[key]);
                }
                return values;
            },
            reset: function reset() {
                this.datums = {};
                this.trie = newNode();
            },
            serialize: function serialize() {
                return {
                    datums: this.datums,
                    trie: this.trie
                };
            }
        });
        return SearchIndex;
        function normalizeTokens(tokens) {
            tokens = _.filter(tokens, function (token) {
                return !!token;
            });
            tokens = _.map(tokens, function (token) {
                return token.toLowerCase();
            });
            return tokens;
        }

        function newNode() {
            var node = {};
            node[IDS] = [];
            node[CHILDREN] = {};
            return node;
        }

        function unique(array) {
            var seen = {}, uniques = [];
            for (var i = 0, len = array.length; i < len; i++) {
                if (!seen[array[i]]) {
                    seen[array[i]] = true;
                    uniques.push(array[i]);
                }
            }
            return uniques;
        }

        function getIntersection(arrayA, arrayB) {
            var ai = 0, bi = 0, intersection = [];
            arrayA = arrayA.sort();
            arrayB = arrayB.sort();
            var lenArrayA = arrayA.length, lenArrayB = arrayB.length;
            while (ai < lenArrayA && bi < lenArrayB) {
                if (arrayA[ai] < arrayB[bi]) {
                    ai++;
                } else if (arrayA[ai] > arrayB[bi]) {
                    bi++;
                } else {
                    intersection.push(arrayA[ai]);
                    ai++;
                    bi++;
                }
            }
            return intersection;
        }
    }();
    var Prefetch = function () {
        "use strict";
        var keys;
        keys = {
            data: "data",
            protocol: "protocol",
            thumbprint: "thumbprint"
        };
        function Prefetch(o) {
            this.url = o.url;
            this.ttl = o.ttl;
            this.cache = o.cache;
            this.prepare = o.prepare;
            this.transform = o.transform;
            this.transport = o.transport;
            this.thumbprint = o.thumbprint;
            this.storage = new PersistentStorage(o.cacheKey);
        }

        _.mixin(Prefetch.prototype, {
            _settings: function settings() {
                return {
                    url: this.url,
                    type: "GET",
                    dataType: "json"
                };
            },
            store: function store(data) {
                if (!this.cache) {
                    return;
                }
                this.storage.set(keys.data, data, this.ttl);
                this.storage.set(keys.protocol, location.protocol, this.ttl);
                this.storage.set(keys.thumbprint, this.thumbprint, this.ttl);
            },
            fromCache: function fromCache() {
                var stored = {}, isExpired;
                if (!this.cache) {
                    return null;
                }
                stored.data = this.storage.get(keys.data);
                stored.protocol = this.storage.get(keys.protocol);
                stored.thumbprint = this.storage.get(keys.thumbprint);
                isExpired = stored.thumbprint !== this.thumbprint || stored.protocol !== location.protocol;
                return stored.data && !isExpired ? stored.data : null;
            },
            fromNetwork: function (cb) {
                var that = this, settings;
                if (!cb) {
                    return;
                }
                settings = this.prepare(this._settings());
                this.transport(settings).fail(onError).done(onResponse);
                function onError() {
                    cb(true);
                }

                function onResponse(resp) {
                    cb(null, that.transform(resp));
                }
            },
            clear: function clear() {
                this.storage.clear();
                return this;
            }
        });
        return Prefetch;
    }();
    var Remote = function () {
        "use strict";
        function Remote(o) {
            this.url = o.url;
            this.prepare = o.prepare;
            this.transform = o.transform;
            this.transport = new Transport({
                cache: o.cache,
                limiter: o.limiter,
                transport: o.transport
            });
        }

        _.mixin(Remote.prototype, {
            _settings: function settings() {
                return {
                    url: this.url,
                    type: "GET",
                    dataType: "json"
                };
            },
            get: function get(query, cb) {
                var that = this, settings;
                if (!cb) {
                    return;
                }
                query = query || "";
                settings = this.prepare(query, this._settings());
                return this.transport.get(settings, onResponse);
                function onResponse(err, resp) {
                    err ? cb([]) : cb(that.transform(resp));
                }
            },
            cancelLastRequest: function cancelLastRequest() {
                this.transport.cancel();
            }
        });
        return Remote;
    }();
    var oParser = function () {
        "use strict";
        return function parse(o) {
            var defaults, sorter;
            defaults = {
                initialize: true,
                identify: _.stringify,
                datumTokenizer: null,
                queryTokenizer: null,
                sufficient: 5,
                sorter: null,
                local: [],
                prefetch: null,
                remote: null
            };
            o = _.mixin(defaults, o || {});
            !o.datumTokenizer && $.error("datumTokenizer is required");
            !o.queryTokenizer && $.error("queryTokenizer is required");
            sorter = o.sorter;
            o.sorter = sorter ? function (x) {
                return x.sort(sorter);
            } : _.identity;
            o.local = _.isFunction(o.local) ? o.local() : o.local;
            o.prefetch = parsePrefetch(o.prefetch);
            o.remote = parseRemote(o.remote);
            return o;
        };
        function parsePrefetch(o) {
            var defaults;
            if (!o) {
                return null;
            }
            defaults = {
                url: null,
                ttl: 24 * 60 * 60 * 1e3,
                cache: true,
                cacheKey: null,
                thumbprint: "",
                prepare: _.identity,
                transform: _.identity,
                transport: null
            };
            o = _.isString(o) ? {
                url: o
            } : o;
            o = _.mixin(defaults, o);
            !o.url && $.error("prefetch requires url to be set");
            o.transform = o.filter || o.transform;
            o.cacheKey = o.cacheKey || o.url;
            o.thumbprint = VERSION + o.thumbprint;
            o.transport = o.transport ? callbackToDeferred(o.transport) : $.ajax;
            return o;
        }

        function parseRemote(o) {
            var defaults;
            if (!o) {
                return;
            }
            defaults = {
                url: null,
                cache: true,
                prepare: null,
                replace: null,
                wildcard: null,
                limiter: null,
                rateLimitBy: "debounce",
                rateLimitWait: 300,
                transform: _.identity,
                transport: null
            };
            o = _.isString(o) ? {
                url: o
            } : o;
            o = _.mixin(defaults, o);
            !o.url && $.error("remote requires url to be set");
            o.transform = o.filter || o.transform;
            o.prepare = toRemotePrepare(o);
            o.limiter = toLimiter(o);
            o.transport = o.transport ? callbackToDeferred(o.transport) : $.ajax;
            delete o.replace;
            delete o.wildcard;
            delete o.rateLimitBy;
            delete o.rateLimitWait;
            return o;
        }

        function toRemotePrepare(o) {
            var prepare, replace, wildcard;
            prepare = o.prepare;
            replace = o.replace;
            wildcard = o.wildcard;
            if (prepare) {
                return prepare;
            }
            if (replace) {
                prepare = prepareByReplace;
            } else if (o.wildcard) {
                prepare = prepareByWildcard;
            } else {
                prepare = idenityPrepare;
            }
            return prepare;
            function prepareByReplace(query, settings) {
                settings.url = replace(settings.url, query);
                return settings;
            }

            function prepareByWildcard(query, settings) {
                settings.url = settings.url.replace(wildcard, encodeURIComponent(query));
                return settings;
            }

            function idenityPrepare(query, settings) {
                return settings;
            }
        }

        function toLimiter(o) {
            var limiter, method, wait;
            limiter = o.limiter;
            method = o.rateLimitBy;
            wait = o.rateLimitWait;
            if (!limiter) {
                limiter = /^throttle$/i.test(method) ? throttle(wait) : debounce(wait);
            }
            return limiter;
            function debounce(wait) {
                return function debounce(fn) {
                    return _.debounce(fn, wait);
                };
            }

            function throttle(wait) {
                return function throttle(fn) {
                    return _.throttle(fn, wait);
                };
            }
        }

        function callbackToDeferred(fn) {
            return function wrapper(o) {
                var deferred = $.Deferred();
                fn(o, onSuccess, onError);
                return deferred;
                function onSuccess(resp) {
                    _.defer(function () {
                        deferred.resolve(resp);
                    });
                }

                function onError(err) {
                    _.defer(function () {
                        deferred.reject(err);
                    });
                }
            };
        }
    }();
    var Bloodhound = function () {
        "use strict";
        var old;
        old = window && window.Bloodhound;
        function Bloodhound(o) {
            o = oParser(o);
            this.sorter = o.sorter;
            this.identify = o.identify;
            this.sufficient = o.sufficient;
            this.local = o.local;
            this.remote = o.remote ? new Remote(o.remote) : null;
            this.prefetch = o.prefetch ? new Prefetch(o.prefetch) : null;
            this.index = new SearchIndex({
                identify: this.identify,
                datumTokenizer: o.datumTokenizer,
                queryTokenizer: o.queryTokenizer
            });
            o.initialize !== false && this.initialize();
        }

        Bloodhound.noConflict = function noConflict() {
            window && (window.Bloodhound = old);
            return Bloodhound;
        };
        Bloodhound.tokenizers = tokenizers;
        _.mixin(Bloodhound.prototype, {
            __ttAdapter: function ttAdapter() {
                var that = this;
                return this.remote ? withAsync : withoutAsync;
                function withAsync(query, sync, async) {
                    return that.search(query, sync, async);
                }

                function withoutAsync(query, sync) {
                    return that.search(query, sync);
                }
            },
            _loadPrefetch: function loadPrefetch() {
                var that = this, deferred, serialized;
                deferred = $.Deferred();
                if (!this.prefetch) {
                    deferred.resolve();
                } else if (serialized = this.prefetch.fromCache()) {
                    this.index.bootstrap(serialized);
                    deferred.resolve();
                } else {
                    this.prefetch.fromNetwork(done);
                }
                return deferred.promise();
                function done(err, data) {
                    if (err) {
                        return deferred.reject();
                    }
                    that.add(data);
                    that.prefetch.store(that.index.serialize());
                    deferred.resolve();
                }
            },
            _initialize: function initialize() {
                var that = this, deferred;
                this.clear();
                (this.initPromise = this._loadPrefetch()).done(addLocalToIndex);
                return this.initPromise;
                function addLocalToIndex() {
                    that.add(that.local);
                }
            },
            initialize: function initialize(force) {
                return !this.initPromise || force ? this._initialize() : this.initPromise;
            },
            add: function add(data) {
                this.index.add(data);
                return this;
            },
            get: function get(ids) {
                ids = _.isArray(ids) ? ids : [].slice.call(arguments);
                return this.index.get(ids);
            },
            search: function search(query, sync, async) {
                var that = this, local;
                local = this.sorter(this.index.search(query));
                sync(this.remote ? local.slice() : local);
                if (this.remote && local.length < this.sufficient) {
                    this.remote.get(query, processRemote);
                } else if (this.remote) {
                    this.remote.cancelLastRequest();
                }
                return this;
                function processRemote(remote) {
                    var nonDuplicates = [];
                    _.each(remote, function (r) {
                        !_.some(local, function (l) {
                            return that.identify(r) === that.identify(l);
                        }) && nonDuplicates.push(r);
                    });
                    async && async(nonDuplicates);
                }
            },
            all: function all() {
                return this.index.all();
            },
            clear: function clear() {
                this.index.reset();
                return this;
            },
            clearPrefetchCache: function clearPrefetchCache() {
                this.prefetch && this.prefetch.clear();
                return this;
            },
            clearRemoteCache: function clearRemoteCache() {
                Transport.resetCache();
                return this;
            },
            ttAdapter: function ttAdapter() {
                return this.__ttAdapter();
            }
        });
        return Bloodhound;
    }();
    return Bloodhound;
});

(function (root, factory) {
    if (typeof define === "function" && define.amd) {
        define("typeahead.js", ["jquery"], function (a0) {
            return factory(a0);
        });
    } else if (typeof exports === "object") {
        module.exports = factory(require("jquery"));
    } else {
        factory(jQuery);
    }
})(this, function ($) {
    var _ = function () {
        "use strict";
        return {
            isMsie: function () {
                return /(msie|trident)/i.test(navigator.userAgent) ? navigator.userAgent.match(/(msie |rv:)(\d+(.\d+)?)/i)[2] : false;
            },
            isBlankString: function (str) {
                return !str || /^\s*$/.test(str);
            },
            escapeRegExChars: function (str) {
                return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
            },
            isString: function (obj) {
                return typeof obj === "string";
            },
            isNumber: function (obj) {
                return typeof obj === "number";
            },
            isArray: $.isArray,
            isFunction: $.isFunction,
            isObject: $.isPlainObject,
            isUndefined: function (obj) {
                return typeof obj === "undefined";
            },
            isElement: function (obj) {
                return !!(obj && obj.nodeType === 1);
            },
            isJQuery: function (obj) {
                return obj instanceof $;
            },
            toStr: function toStr(s) {
                return _.isUndefined(s) || s === null ? "" : s + "";
            },
            bind: $.proxy,
            each: function (collection, cb) {
                $.each(collection, reverseArgs);
                function reverseArgs(index, value) {
                    return cb(value, index);
                }
            },
            map: $.map,
            filter: $.grep,
            every: function (obj, test) {
                var result = true;
                if (!obj) {
                    return result;
                }
                $.each(obj, function (key, val) {
                    if (!(result = test.call(null, val, key, obj))) {
                        return false;
                    }
                });
                return !!result;
            },
            some: function (obj, test) {
                var result = false;
                if (!obj) {
                    return result;
                }
                $.each(obj, function (key, val) {
                    if (result = test.call(null, val, key, obj)) {
                        return false;
                    }
                });
                return !!result;
            },
            mixin: $.extend,
            identity: function (x) {
                return x;
            },
            clone: function (obj) {
                return $.extend(true, {}, obj);
            },
            getIdGenerator: function () {
                var counter = 0;
                return function () {
                    return counter++;
                };
            },
            templatify: function templatify(obj) {
                return $.isFunction(obj) ? obj : template;
                function template() {
                    return String(obj);
                }
            },
            defer: function (fn) {
                setTimeout(fn, 0);
            },
            debounce: function (func, wait, immediate) {
                var timeout, result;
                return function () {
                    var context = this, args = arguments, later, callNow;
                    later = function () {
                        timeout = null;
                        if (!immediate) {
                            result = func.apply(context, args);
                        }
                    };
                    callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) {
                        result = func.apply(context, args);
                    }
                    return result;
                };
            },
            throttle: function (func, wait) {
                var context, args, timeout, result, previous, later;
                previous = 0;
                later = function () {
                    previous = new Date();
                    timeout = null;
                    result = func.apply(context, args);
                };
                return function () {
                    var now = new Date(), remaining = wait - (now - previous);
                    context = this;
                    args = arguments;
                    if (remaining <= 0) {
                        clearTimeout(timeout);
                        timeout = null;
                        previous = now;
                        result = func.apply(context, args);
                    } else if (!timeout) {
                        timeout = setTimeout(later, remaining);
                    }
                    return result;
                };
            },
            stringify: function (val) {
                return _.isString(val) ? val : JSON.stringify(val);
            },
            noop: function () {
            }
        };
    }();
    var WWW = function () {
        "use strict";
        var defaultClassNames = {
            wrapper: "twitter-typeahead",
            input: "tt-input",
            hint: "tt-hint",
            menu: "tt-menu",
            dataset: "tt-dataset",
            suggestion: "tt-suggestion",
            selectable: "tt-selectable",
            empty: "tt-empty",
            open: "tt-open",
            cursor: "tt-cursor",
            highlight: "tt-highlight"
        };
        return build;
        function build(o) {
            var www, classes;
            classes = _.mixin({}, defaultClassNames, o);
            www = {
                css: buildCss(),
                classes: classes,
                html: buildHtml(classes),
                selectors: buildSelectors(classes)
            };
            return {
                css: www.css,
                html: www.html,
                classes: www.classes,
                selectors: www.selectors,
                mixin: function (o) {
                    _.mixin(o, www);
                }
            };
        }

        function buildHtml(c) {
            return {
                wrapper: '<span class="' + c.wrapper + '"></span>',
                menu: '<div class="' + c.menu + '"></div>'
            };
        }

        function buildSelectors(classes) {
            var selectors = {};
            _.each(classes, function (v, k) {
                selectors[k] = "." + v;
            });
            return selectors;
        }

        function buildCss() {
            var css = {
                wrapper: {
                    position: "relative",
                    display: "inline-block"
                },
                hint: {
                    position: "absolute",
                    top: "0",
                    left: "0",
                    borderColor: "transparent",
                    boxShadow: "none",
                    opacity: "1"
                },
                input: {
                    position: "relative",
                    verticalAlign: "top",
                    backgroundColor: "transparent"
                },
                inputWithNoHint: {
                    position: "relative",
                    verticalAlign: "top"
                },
                menu: {
                    position: "absolute",
                    top: "100%",
                    left: "0",
                    zIndex: "100",
                    display: "none"
                },
                ltr: {
                    left: "0",
                    right: "auto"
                },
                rtl: {
                    left: "auto",
                    right: " 0"
                }
            };
            if (_.isMsie()) {
                _.mixin(css.input, {
                    backgroundImage: "url(data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)"
                });
            }
            return css;
        }
    }();
    var EventBus = function () {
        "use strict";
        var namespace, deprecationMap;
        namespace = "typeahead:";
        deprecationMap = {
            render: "rendered",
            cursorchange: "cursorchanged",
            select: "selected",
            autocomplete: "autocompleted"
        };
        function EventBus(o) {
            if (!o || !o.el) {
                $.error("EventBus initialized without el");
            }
            this.$el = $(o.el);
        }

        _.mixin(EventBus.prototype, {
            _trigger: function (type, args) {
                var $e;
                $e = $.Event(namespace + type);
                (args = args || []).unshift($e);
                this.$el.trigger.apply(this.$el, args);
                return $e;
            },
            before: function (type) {
                var args, $e;
                args = [].slice.call(arguments, 1);
                $e = this._trigger("before" + type, args);
                return $e.isDefaultPrevented();
            },
            trigger: function (type) {
                var deprecatedType;
                this._trigger(type, [].slice.call(arguments, 1));
                if (deprecatedType = deprecationMap[type]) {
                    this._trigger(deprecatedType, [].slice.call(arguments, 1));
                }
            }
        });
        return EventBus;
    }();
    var EventEmitter = function () {
        "use strict";
        var splitter = /\s+/, nextTick = getNextTick();
        return {
            onSync: onSync,
            onAsync: onAsync,
            off: off,
            trigger: trigger
        };
        function on(method, types, cb, context) {
            var type;
            if (!cb) {
                return this;
            }
            types = types.split(splitter);
            cb = context ? bindContext(cb, context) : cb;
            this._callbacks = this._callbacks || {};
            while (type = types.shift()) {
                this._callbacks[type] = this._callbacks[type] || {
                        sync: [],
                        async: []
                    };
                this._callbacks[type][method].push(cb);
            }
            return this;
        }

        function onAsync(types, cb, context) {
            return on.call(this, "async", types, cb, context);
        }

        function onSync(types, cb, context) {
            return on.call(this, "sync", types, cb, context);
        }

        function off(types) {
            var type;
            if (!this._callbacks) {
                return this;
            }
            types = types.split(splitter);
            while (type = types.shift()) {
                delete this._callbacks[type];
            }
            return this;
        }

        function trigger(types) {
            var type, callbacks, args, syncFlush, asyncFlush;
            if (!this._callbacks) {
                return this;
            }
            types = types.split(splitter);
            args = [].slice.call(arguments, 1);
            while ((type = types.shift()) && (callbacks = this._callbacks[type])) {
                syncFlush = getFlush(callbacks.sync, this, [type].concat(args));
                asyncFlush = getFlush(callbacks.async, this, [type].concat(args));
                syncFlush() && nextTick(asyncFlush);
            }
            return this;
        }

        function getFlush(callbacks, context, args) {
            return flush;
            function flush() {
                var cancelled;
                for (var i = 0, len = callbacks.length; !cancelled && i < len; i += 1) {
                    cancelled = callbacks[i].apply(context, args) === false;
                }
                return !cancelled;
            }
        }

        function getNextTick() {
            var nextTickFn;
            if (window.setImmediate) {
                nextTickFn = function nextTickSetImmediate(fn) {
                    setImmediate(function () {
                        fn();
                    });
                };
            } else {
                nextTickFn = function nextTickSetTimeout(fn) {
                    setTimeout(function () {
                        fn();
                    }, 0);
                };
            }
            return nextTickFn;
        }

        function bindContext(fn, context) {
            return fn.bind ? fn.bind(context) : function () {
                fn.apply(context, [].slice.call(arguments, 0));
            };
        }
    }();
    var highlight = function (doc) {
        "use strict";
        var defaults = {
            node: null,
            pattern: null,
            tagName: "strong",
            className: null,
            wordsOnly: false,
            caseSensitive: false
        };
        return function hightlight(o) {
            var regex;
            o = _.mixin({}, defaults, o);
            if (!o.node || !o.pattern) {
                return;
            }
            o.pattern = _.isArray(o.pattern) ? o.pattern : [o.pattern];
            regex = getRegex(o.pattern, o.caseSensitive, o.wordsOnly);
            traverse(o.node, hightlightTextNode);
            function hightlightTextNode(textNode) {
                var match, patternNode, wrapperNode;
                if (match = regex.exec(textNode.data)) {
                    wrapperNode = doc.createElement(o.tagName);
                    o.className && (wrapperNode.className = o.className);
                    patternNode = textNode.splitText(match.index);
                    patternNode.splitText(match[0].length);
                    wrapperNode.appendChild(patternNode.cloneNode(true));
                    textNode.parentNode.replaceChild(wrapperNode, patternNode);
                }
                return !!match;
            }

            function traverse(el, hightlightTextNode) {
                var childNode, TEXT_NODE_TYPE = 3;
                for (var i = 0; i < el.childNodes.length; i++) {
                    childNode = el.childNodes[i];
                    if (childNode.nodeType === TEXT_NODE_TYPE) {
                        i += hightlightTextNode(childNode) ? 1 : 0;
                    } else {
                        traverse(childNode, hightlightTextNode);
                    }
                }
            }
        };
        function getRegex(patterns, caseSensitive, wordsOnly) {
            var escapedPatterns = [], regexStr;
            for (var i = 0, len = patterns.length; i < len; i++) {
                escapedPatterns.push(_.escapeRegExChars(patterns[i]));
            }
            regexStr = wordsOnly ? "\\b(" + escapedPatterns.join("|") + ")\\b" : "(" + escapedPatterns.join("|") + ")";
            return caseSensitive ? new RegExp(regexStr) : new RegExp(regexStr, "i");
        }
    }(window.document);
    var Input = function () {
        "use strict";
        var specialKeyCodeMap;
        specialKeyCodeMap = {
            9: "tab",
            27: "esc",
            37: "left",
            39: "right",
            13: "enter",
            38: "up",
            40: "down"
        };
        function Input(o, www) {
            o = o || {};
            if (!o.input) {
                $.error("input is missing");
            }
            www.mixin(this);
            this.$hint = $(o.hint);
            this.$input = $(o.input);
            this.query = this.$input.val();
            this.queryWhenFocused = this.hasFocus() ? this.query : null;
            this.$overflowHelper = buildOverflowHelper(this.$input);
            this._checkLanguageDirection();
            if (this.$hint.length === 0) {
                this.setHint = this.getHint = this.clearHint = this.clearHintIfInvalid = _.noop;
            }
        }

        Input.normalizeQuery = function (str) {
            return _.toStr(str).replace(/^\s*/g, "").replace(/\s{2,}/g, " ");
        };
        _.mixin(Input.prototype, EventEmitter, {
            _onBlur: function onBlur() {
                this.resetInputValue();
                this.trigger("blurred");
            },
            _onFocus: function onFocus() {
                this.queryWhenFocused = this.query;
                this.trigger("focused");
            },
            _onKeydown: function onKeydown($e) {
                var keyName = specialKeyCodeMap[$e.which || $e.keyCode];
                this._managePreventDefault(keyName, $e);
                if (keyName && this._shouldTrigger(keyName, $e)) {
                    this.trigger(keyName + "Keyed", $e);
                }
            },
            _onInput: function onInput() {
                this._setQuery(this.getInputValue());
                this.clearHintIfInvalid();
                this._checkLanguageDirection();
            },
            _managePreventDefault: function managePreventDefault(keyName, $e) {
                var preventDefault;
                switch (keyName) {
                    case "up":
                    case "down":
                        preventDefault = !withModifier($e);
                        break;

                    default:
                        preventDefault = false;
                }
                preventDefault && $e.preventDefault();
            },
            _shouldTrigger: function shouldTrigger(keyName, $e) {
                var trigger;
                switch (keyName) {
                    case "tab":
                        trigger = !withModifier($e);
                        break;

                    default:
                        trigger = true;
                }
                return trigger;
            },
            _checkLanguageDirection: function checkLanguageDirection() {
                var dir = (this.$input.css("direction") || "ltr").toLowerCase();
                if (this.dir !== dir) {
                    this.dir = dir;
                    this.$hint.attr("dir", dir);
                    this.trigger("langDirChanged", dir);
                }
            },
            _setQuery: function setQuery(val, silent) {
                var areEquivalent, hasDifferentWhitespace;
                areEquivalent = areQueriesEquivalent(val, this.query);
                hasDifferentWhitespace = areEquivalent ? this.query.length !== val.length : false;
                this.query = val;
                if (!silent && !areEquivalent) {
                    this.trigger("queryChanged", this.query);
                } else if (!silent && hasDifferentWhitespace) {
                    this.trigger("whitespaceChanged", this.query);
                }
            },
            bind: function () {
                var that = this, onBlur, onFocus, onKeydown, onInput;
                onBlur = _.bind(this._onBlur, this);
                onFocus = _.bind(this._onFocus, this);
                onKeydown = _.bind(this._onKeydown, this);
                onInput = _.bind(this._onInput, this);
                this.$input.on("blur.tt", onBlur).on("focus.tt", onFocus).on("keydown.tt", onKeydown);
                if (!_.isMsie() || _.isMsie() > 9) {
                    this.$input.on("input.tt", onInput);
                } else {
                    this.$input.on("keydown.tt keypress.tt cut.tt paste.tt", function ($e) {
                        if (specialKeyCodeMap[$e.which || $e.keyCode]) {
                            return;
                        }
                        _.defer(_.bind(that._onInput, that, $e));
                    });
                }
                return this;
            },
            focus: function focus() {
                this.$input.focus();
            },
            blur: function blur() {
                this.$input.blur();
            },
            getLangDir: function getLangDir() {
                return this.dir;
            },
            getQuery: function getQuery() {
                return this.query || "";
            },
            setQuery: function setQuery(val, silent) {
                this.setInputValue(val);
                this._setQuery(val, silent);
            },
            hasQueryChangedSinceLastFocus: function hasQueryChangedSinceLastFocus() {
                return this.query !== this.queryWhenFocused;
            },
            getInputValue: function getInputValue() {
                return this.$input.val();
            },
            setInputValue: function setInputValue(value) {
                this.$input.val(value);
                this.clearHintIfInvalid();
                this._checkLanguageDirection();
            },
            resetInputValue: function resetInputValue() {
                this.setInputValue(this.query);
            },
            getHint: function getHint() {
                return this.$hint.val();
            },
            setHint: function setHint(value) {
                this.$hint.val(value);
            },
            clearHint: function clearHint() {
                this.setHint("");
            },
            clearHintIfInvalid: function clearHintIfInvalid() {
                var val, hint, valIsPrefixOfHint, isValid;
                val = this.getInputValue();
                hint = this.getHint();
                valIsPrefixOfHint = val !== hint && hint.indexOf(val) === 0;
                isValid = val !== "" && valIsPrefixOfHint && !this.hasOverflow();
                !isValid && this.clearHint();
            },
            hasFocus: function hasFocus() {
                return this.$input.is(":focus");
            },
            hasOverflow: function hasOverflow() {
                var constraint = this.$input.width() - 2;
                this.$overflowHelper.text(this.getInputValue());
                return this.$overflowHelper.width() >= constraint;
            },
            isCursorAtEnd: function () {
                var valueLength, selectionStart, range;
                valueLength = this.$input.val().length;
                selectionStart = this.$input[0].selectionStart;
                if (_.isNumber(selectionStart)) {
                    return selectionStart === valueLength;
                } else if (document.selection) {
                    range = document.selection.createRange();
                    range.moveStart("character", -valueLength);
                    return valueLength === range.text.length;
                }
                return true;
            },
            destroy: function destroy() {
                this.$hint.off(".tt");
                this.$input.off(".tt");
                this.$overflowHelper.remove();
                this.$hint = this.$input = this.$overflowHelper = $("<div>");
            }
        });
        return Input;
        function buildOverflowHelper($input) {
            return $('<pre aria-hidden="true"></pre>').css({
                position: "absolute",
                visibility: "hidden",
                whiteSpace: "pre",
                fontFamily: $input.css("font-family"),
                fontSize: $input.css("font-size"),
                fontStyle: $input.css("font-style"),
                fontVariant: $input.css("font-variant"),
                fontWeight: $input.css("font-weight"),
                wordSpacing: $input.css("word-spacing"),
                letterSpacing: $input.css("letter-spacing"),
                textIndent: $input.css("text-indent"),
                textRendering: $input.css("text-rendering"),
                textTransform: $input.css("text-transform")
            }).insertAfter($input);
        }

        function areQueriesEquivalent(a, b) {
            return Input.normalizeQuery(a) === Input.normalizeQuery(b);
        }

        function withModifier($e) {
            return $e.altKey || $e.ctrlKey || $e.metaKey || $e.shiftKey;
        }
    }();
    var Dataset = function () {
        "use strict";
        var keys, nameGenerator;
        keys = {
            val: "tt-selectable-display",
            obj: "tt-selectable-object"
        };
        nameGenerator = _.getIdGenerator();
        function Dataset(o, www) {
            o = o || {};
            o.templates = o.templates || {};
            o.templates.notFound = o.templates.notFound || o.templates.empty;
            if (!o.source) {
                $.error("missing source");
            }
            if (!o.node) {
                $.error("missing node");
            }
            if (o.name && !isValidName(o.name)) {
                $.error("invalid dataset name: " + o.name);
            }
            www.mixin(this);
            this.highlight = !!o.highlight;
            this.name = o.name || nameGenerator();
            this.limit = o.limit || 8;
            this.displayFn = getDisplayFn(o.display || o.displayKey);
            this.templates = getTemplates(o.templates, this.displayFn);
            this.source = o.source.__ttAdapter ? o.source.__ttAdapter() : o.source;
            this.async = _.isUndefined(o.async) ? this.source.length > 2 : !!o.async;
            this._resetLastSuggestion();
            this.$el = $(o.node).addClass(this.classes.dataset).addClass(this.classes.dataset + "-" + this.name);
        }

        Dataset.extractData = function extractData(el) {
            var $el = $(el);
            if ($el.data(keys.obj)) {
                return {
                    val: $el.data(keys.val) || "",
                    obj: $el.data(keys.obj) || null
                };
            }
            return null;
        };
        _.mixin(Dataset.prototype, EventEmitter, {
            _overwrite: function overwrite(query, suggestions) {
                suggestions = suggestions || [];
                if (suggestions.length) {
                    this._renderSuggestions(query, suggestions);
                } else if (this.async && this.templates.pending) {
                    this._renderPending(query);
                } else if (!this.async && this.templates.notFound) {
                    this._renderNotFound(query);
                } else {
                    this._empty();
                }
                this.trigger("rendered", this.name, suggestions, false);
            },
            _append: function append(query, suggestions) {
                suggestions = suggestions || [];
                if (suggestions.length && this.$lastSuggestion.length) {
                    this._appendSuggestions(query, suggestions);
                } else if (suggestions.length) {
                    this._renderSuggestions(query, suggestions);
                } else if (!this.$lastSuggestion.length && this.templates.notFound) {
                    this._renderNotFound(query);
                }
                this.trigger("rendered", this.name, suggestions, true);
            },
            _renderSuggestions: function renderSuggestions(query, suggestions) {
                var $fragment;
                $fragment = this._getSuggestionsFragment(query, suggestions);
                this.$lastSuggestion = $fragment.children().last();
                this.$el.html($fragment).prepend(this._getHeader(query, suggestions)).append(this._getFooter(query, suggestions));
            },
            _appendSuggestions: function appendSuggestions(query, suggestions) {
                var $fragment, $lastSuggestion;
                $fragment = this._getSuggestionsFragment(query, suggestions);
                $lastSuggestion = $fragment.children().last();
                this.$lastSuggestion.after($fragment);
                this.$lastSuggestion = $lastSuggestion;
            },
            _renderPending: function renderPending(query) {
                var template = this.templates.pending;
                this._resetLastSuggestion();
                template && this.$el.html(template({
                    query: query,
                    dataset: this.name
                }));
            },
            _renderNotFound: function renderNotFound(query) {
                var template = this.templates.notFound;
                this._resetLastSuggestion();
                template && this.$el.html(template({
                    query: query,
                    dataset: this.name
                }));
            },
            _empty: function empty() {
                this.$el.empty();
                this._resetLastSuggestion();
            },
            _getSuggestionsFragment: function getSuggestionsFragment(query, suggestions) {
                var that = this, fragment;
                fragment = document.createDocumentFragment();
                _.each(suggestions, function getSuggestionNode(suggestion) {
                    var $el, context;
                    context = that._injectQuery(query, suggestion);
                    $el = $(that.templates.suggestion(context)).data(keys.obj, suggestion).data(keys.val, that.displayFn(suggestion)).addClass(that.classes.suggestion + " " + that.classes.selectable);
                    fragment.appendChild($el[0]);
                });
                this.highlight && highlight({
                    className: this.classes.highlight,
                    node: fragment,
                    pattern: query
                });
                return $(fragment);
            },
            _getFooter: function getFooter(query, suggestions) {
                return this.templates.footer ? this.templates.footer({
                    query: query,
                    suggestions: suggestions,
                    dataset: this.name
                }) : null;
            },
            _getHeader: function getHeader(query, suggestions) {
                return this.templates.header ? this.templates.header({
                    query: query,
                    suggestions: suggestions,
                    dataset: this.name
                }) : null;
            },
            _resetLastSuggestion: function resetLastSuggestion() {
                this.$lastSuggestion = $();
            },
            _injectQuery: function injectQuery(query, obj) {
                return _.isObject(obj) ? _.mixin({
                    _query: query
                }, obj) : obj;
            },
            update: function update(query) {
                var that = this, canceled = false, syncCalled = false, rendered = 0;
                this.cancel();
                this.cancel = function cancel() {
                    canceled = true;
                    that.cancel = $.noop;
                    that.async && that.trigger("asyncCanceled", query);
                };
                this.source(query, sync, async);
                !syncCalled && sync([]);
                function sync(suggestions) {
                    if (syncCalled) {
                        return;
                    }
                    syncCalled = true;
                    suggestions = (suggestions || []).slice(0, that.limit);
                    rendered = suggestions.length;
                    that._overwrite(query, suggestions);
                    if (rendered < that.limit && that.async) {
                        that.trigger("asyncRequested", query);
                    }
                }

                function async(suggestions) {
                    suggestions = suggestions || [];
                    if (!canceled && rendered < that.limit) {
                        that.cancel = $.noop;
                        rendered += suggestions.length;
                        that._append(query, suggestions.slice(0, that.limit - rendered));
                        that.async && that.trigger("asyncReceived", query);
                    }
                }
            },
            cancel: $.noop,
            clear: function clear() {
                this._empty();
                this.cancel();
                this.trigger("cleared");
            },
            isEmpty: function isEmpty() {
                return this.$el.is(":empty");
            },
            destroy: function destroy() {
                this.$el = $("<div>");
            }
        });
        return Dataset;
        function getDisplayFn(display) {
            display = display || _.stringify;
            return _.isFunction(display) ? display : displayFn;
            function displayFn(obj) {
                return obj[display];
            }
        }

        function getTemplates(templates, displayFn) {
            return {
                notFound: templates.notFound && _.templatify(templates.notFound),
                pending: templates.pending && _.templatify(templates.pending),
                header: templates.header && _.templatify(templates.header),
                footer: templates.footer && _.templatify(templates.footer),
                suggestion: templates.suggestion || suggestionTemplate
            };
            function suggestionTemplate(context) {
                return $("<div>").text(displayFn(context));
            }
        }

        function isValidName(str) {
            return /^[_a-zA-Z0-9-]+$/.test(str);
        }
    }();
    var Menu = function () {
        "use strict";
        function Menu(o, www) {
            var that = this;
            o = o || {};
            if (!o.node) {
                $.error("node is required");
            }
            www.mixin(this);
            this.$node = $(o.node);
            this.query = null;
            this.datasets = _.map(o.datasets, initializeDataset);
            function initializeDataset(oDataset) {
                var node = that.$node.find(oDataset.node).first();
                oDataset.node = node.length ? node : $("<div>").appendTo(that.$node);
                return new Dataset(oDataset, www);
            }
        }

        _.mixin(Menu.prototype, EventEmitter, {
            _onSelectableClick: function onSelectableClick($e) {
                this.trigger("selectableClicked", $($e.currentTarget));
            },
            _onRendered: function onRendered(type, dataset, suggestions, async) {
                this.$node.toggleClass(this.classes.empty, this._allDatasetsEmpty());
                this.trigger("datasetRendered", dataset, suggestions, async);
            },
            _onCleared: function onCleared() {
                this.$node.toggleClass(this.classes.empty, this._allDatasetsEmpty());
                this.trigger("datasetCleared");
            },
            _propagate: function propagate() {
                this.trigger.apply(this, arguments);
            },
            _allDatasetsEmpty: function allDatasetsEmpty() {
                return _.every(this.datasets, isDatasetEmpty);
                function isDatasetEmpty(dataset) {
                    return dataset.isEmpty();
                }
            },
            _getSelectables: function getSelectables() {
                return this.$node.find(this.selectors.selectable);
            },
            _removeCursor: function _removeCursor() {
                var $selectable = this.getActiveSelectable();
                $selectable && $selectable.removeClass(this.classes.cursor);
            },
            _ensureVisible: function ensureVisible($el) {
                var elTop, elBottom, nodeScrollTop, nodeHeight;
                elTop = $el.position().top;
                elBottom = elTop + $el.outerHeight(true);
                nodeScrollTop = this.$node.scrollTop();
                nodeHeight = this.$node.height() + parseInt(this.$node.css("paddingTop"), 10) + parseInt(this.$node.css("paddingBottom"), 10);
                if (elTop < 0) {
                    this.$node.scrollTop(nodeScrollTop + elTop);
                } else if (nodeHeight < elBottom) {
                    this.$node.scrollTop(nodeScrollTop + (elBottom - nodeHeight));
                }
            },
            bind: function () {
                var that = this, onSelectableClick;
                onSelectableClick = _.bind(this._onSelectableClick, this);
                this.$node.on("click.tt", this.selectors.selectable, onSelectableClick);
                _.each(this.datasets, function (dataset) {
                    dataset.onSync("asyncRequested", that._propagate, that).onSync("asyncCanceled", that._propagate, that).onSync("asyncReceived", that._propagate, that).onSync("rendered", that._onRendered, that).onSync("cleared", that._onCleared, that);
                });
                return this;
            },
            isOpen: function isOpen() {
                return this.$node.hasClass(this.classes.open);
            },
            open: function open() {
                this.$node.addClass(this.classes.open);
            },
            close: function close() {
                this.$node.removeClass(this.classes.open);
                this._removeCursor();
            },
            setLanguageDirection: function setLanguageDirection(dir) {
                this.$node.attr("dir", dir);
            },
            selectableRelativeToCursor: function selectableRelativeToCursor(delta) {
                var $selectables, $oldCursor, oldIndex, newIndex;
                $oldCursor = this.getActiveSelectable();
                $selectables = this._getSelectables();
                oldIndex = $oldCursor ? $selectables.index($oldCursor) : -1;
                newIndex = oldIndex + delta;
                newIndex = (newIndex + 1) % ($selectables.length + 1) - 1;
                newIndex = newIndex < -1 ? $selectables.length - 1 : newIndex;
                return newIndex === -1 ? null : $selectables.eq(newIndex);
            },
            setCursor: function setCursor($selectable) {
                this._removeCursor();
                if ($selectable = $selectable && $selectable.first()) {
                    $selectable.addClass(this.classes.cursor);
                    this._ensureVisible($selectable);
                }
            },
            getSelectableData: function getSelectableData($el) {
                return $el && $el.length ? Dataset.extractData($el) : null;
            },
            getActiveSelectable: function getActiveSelectable() {
                var $selectable = this._getSelectables().filter(this.selectors.cursor).first();
                return $selectable.length ? $selectable : null;
            },
            getTopSelectable: function getTopSelectable() {
                var $selectable = this._getSelectables().first();
                return $selectable.length ? $selectable : null;
            },
            update: function update(query) {
                var isValidUpdate = query !== this.query;
                if (isValidUpdate) {
                    this.query = query;
                    _.each(this.datasets, updateDataset);
                }
                return isValidUpdate;
                function updateDataset(dataset) {
                    dataset.update(query);
                }
            },
            empty: function empty() {
                _.each(this.datasets, clearDataset);
                this.query = null;
                this.$node.addClass(this.classes.empty);
                function clearDataset(dataset) {
                    dataset.clear();
                }
            },
            destroy: function destroy() {
                this.$node.off(".tt");
                this.$node = $("<div>");
                _.each(this.datasets, destroyDataset);
                function destroyDataset(dataset) {
                    dataset.destroy();
                }
            }
        });
        return Menu;
    }();
    var DefaultMenu = function () {
        "use strict";
        var s = Menu.prototype;

        function DefaultMenu() {
            Menu.apply(this, [].slice.call(arguments, 0));
        }

        _.mixin(DefaultMenu.prototype, Menu.prototype, {
            open: function open() {
                !this._allDatasetsEmpty() && this._show();
                return s.open.apply(this, [].slice.call(arguments, 0));
            },
            close: function close() {
                this._hide();
                return s.close.apply(this, [].slice.call(arguments, 0));
            },
            _onRendered: function onRendered() {
                if (this._allDatasetsEmpty()) {
                    this._hide();
                } else {
                    this.isOpen() && this._show();
                }
                return s._onRendered.apply(this, [].slice.call(arguments, 0));
            },
            _onCleared: function onCleared() {
                if (this._allDatasetsEmpty()) {
                    this._hide();
                } else {
                    this.isOpen() && this._show();
                }
                return s._onCleared.apply(this, [].slice.call(arguments, 0));
            },
            setLanguageDirection: function setLanguageDirection(dir) {
                this.$node.css(dir === "ltr" ? this.css.ltr : this.css.rtl);
                return s.setLanguageDirection.apply(this, [].slice.call(arguments, 0));
            },
            _hide: function hide() {
                this.$node.hide();
            },
            _show: function show() {
                this.$node.css("display", "block");
            }
        });
        return DefaultMenu;
    }();
    var Typeahead = function () {
        "use strict";
        function Typeahead(o, www) {
            var onFocused, onBlurred, onEnterKeyed, onTabKeyed, onEscKeyed, onUpKeyed, onDownKeyed, onLeftKeyed, onRightKeyed, onQueryChanged, onWhitespaceChanged;
            o = o || {};
            if (!o.input) {
                $.error("missing input");
            }
            if (!o.menu) {
                $.error("missing menu");
            }
            if (!o.eventBus) {
                $.error("missing event bus");
            }
            www.mixin(this);
            this.eventBus = o.eventBus;
            this.minLength = _.isNumber(o.minLength) ? o.minLength : 1;
            this.input = o.input;
            this.menu = o.menu;
            this.enabled = true;
            this.active = false;
            this.input.hasFocus() && this.activate();
            this.dir = this.input.getLangDir();
            this._hacks();
            this.menu.bind().onSync("selectableClicked", this._onSelectableClicked, this).onSync("asyncRequested", this._onAsyncRequested, this).onSync("asyncCanceled", this._onAsyncCanceled, this).onSync("asyncReceived", this._onAsyncReceived, this).onSync("datasetRendered", this._onDatasetRendered, this).onSync("datasetCleared", this._onDatasetCleared, this);
            onFocused = c(this, "activate", "open", "_onFocused");
            onBlurred = c(this, "deactivate", "_onBlurred");
            onEnterKeyed = c(this, "isActive", "isOpen", "_onEnterKeyed");
            onTabKeyed = c(this, "isActive", "isOpen", "_onTabKeyed");
            onEscKeyed = c(this, "isActive", "_onEscKeyed");
            onUpKeyed = c(this, "isActive", "open", "_onUpKeyed");
            onDownKeyed = c(this, "isActive", "open", "_onDownKeyed");
            onLeftKeyed = c(this, "isActive", "isOpen", "_onLeftKeyed");
            onRightKeyed = c(this, "isActive", "isOpen", "_onRightKeyed");
            onQueryChanged = c(this, "_openIfActive", "_onQueryChanged");
            onWhitespaceChanged = c(this, "_openIfActive", "_onWhitespaceChanged");
            this.input.bind().onSync("focused", onFocused, this).onSync("blurred", onBlurred, this).onSync("enterKeyed", onEnterKeyed, this).onSync("tabKeyed", onTabKeyed, this).onSync("escKeyed", onEscKeyed, this).onSync("upKeyed", onUpKeyed, this).onSync("downKeyed", onDownKeyed, this).onSync("leftKeyed", onLeftKeyed, this).onSync("rightKeyed", onRightKeyed, this).onSync("queryChanged", onQueryChanged, this).onSync("whitespaceChanged", onWhitespaceChanged, this).onSync("langDirChanged", this._onLangDirChanged, this);
        }

        _.mixin(Typeahead.prototype, {
            _hacks: function hacks() {
                var $input, $menu;
                $input = this.input.$input || $("<div>");
                $menu = this.menu.$node || $("<div>");
                $input.on("blur.tt", function ($e) {
                    var active, isActive, hasActive;
                    active = document.activeElement;
                    isActive = $menu.is(active);
                    hasActive = $menu.has(active).length > 0;
                    if (_.isMsie() && (isActive || hasActive)) {
                        $e.preventDefault();
                        $e.stopImmediatePropagation();
                        _.defer(function () {
                            $input.focus();
                        });
                    }
                });
                $menu.on("mousedown.tt", function ($e) {
                    $e.preventDefault();
                });
            },
            _onSelectableClicked: function onSelectableClicked(type, $el) {
                this.select($el);
            },
            _onDatasetCleared: function onDatasetCleared() {
                this._updateHint();
            },
            _onDatasetRendered: function onDatasetRendered(type, dataset, suggestions, async) {
                this._updateHint();
                this.eventBus.trigger("render", suggestions, async, dataset);
            },
            _onAsyncRequested: function onAsyncRequested(type, dataset, query) {
                this.eventBus.trigger("asyncrequest", query, dataset);
            },
            _onAsyncCanceled: function onAsyncCanceled(type, dataset, query) {
                this.eventBus.trigger("asynccancel", query, dataset);
            },
            _onAsyncReceived: function onAsyncReceived(type, dataset, query) {
                this.eventBus.trigger("asyncreceive", query, dataset);
            },
            _onFocused: function onFocused() {
                this._minLengthMet() && this.menu.update(this.input.getQuery());
            },
            _onBlurred: function onBlurred() {
                if (this.input.hasQueryChangedSinceLastFocus()) {
                    this.eventBus.trigger("change", this.input.getQuery());
                }
            },
            _onEnterKeyed: function onEnterKeyed(type, $e) {
                var $selectable;
                if ($selectable = this.menu.getActiveSelectable()) {
                    this.select($selectable) && $e.preventDefault();
                }
            },
            _onTabKeyed: function onTabKeyed(type, $e) {
                var $selectable;
                if ($selectable = this.menu.getActiveSelectable()) {
                    this.select($selectable) && $e.preventDefault();
                } else if ($selectable = this.menu.getTopSelectable()) {
                    this.autocomplete($selectable) && $e.preventDefault();
                }
            },
            _onEscKeyed: function onEscKeyed() {
                this.close();
            },
            _onUpKeyed: function onUpKeyed() {
                this.moveCursor(-1);
            },
            _onDownKeyed: function onDownKeyed() {
                this.moveCursor(+1);
            },
            _onLeftKeyed: function onLeftKeyed() {
                if (this.dir === "rtl" && this.input.isCursorAtEnd()) {
                    this.autocomplete(this.menu.getTopSelectable());
                }
            },
            _onRightKeyed: function onRightKeyed() {
                if (this.dir === "ltr" && this.input.isCursorAtEnd()) {
                    this.autocomplete(this.menu.getTopSelectable());
                }
            },
            _onQueryChanged: function onQueryChanged(e, query) {
                this._minLengthMet(query) ? this.menu.update(query) : this.menu.empty();
            },
            _onWhitespaceChanged: function onWhitespaceChanged() {
                this._updateHint();
            },
            _onLangDirChanged: function onLangDirChanged(e, dir) {
                if (this.dir !== dir) {
                    this.dir = dir;
                    this.menu.setLanguageDirection(dir);
                }
            },
            _openIfActive: function openIfActive() {
                this.isActive() && this.open();
            },
            _minLengthMet: function minLengthMet(query) {
                query = _.isString(query) ? query : this.input.getQuery() || "";
                return query.length >= this.minLength;
            },
            _updateHint: function updateHint() {
                var $selectable, data, val, query, escapedQuery, frontMatchRegEx, match;
                $selectable = this.menu.getTopSelectable();
                data = this.menu.getSelectableData($selectable);
                val = this.input.getInputValue();
                if (data && !_.isBlankString(val) && !this.input.hasOverflow()) {
                    query = Input.normalizeQuery(val);
                    escapedQuery = _.escapeRegExChars(query);
                    frontMatchRegEx = new RegExp("^(?:" + escapedQuery + ")(.+$)", "i");
                    match = frontMatchRegEx.exec(data.val);
                    match && this.input.setHint(val + match[1]);
                } else {
                    this.input.clearHint();
                }
            },
            isEnabled: function isEnabled() {
                return this.enabled;
            },
            enable: function enable() {
                this.enabled = true;
            },
            disable: function disable() {
                this.enabled = false;
            },
            isActive: function isActive() {
                return this.active;
            },
            activate: function activate() {
                if (this.isActive()) {
                    return true;
                } else if (!this.isEnabled() || this.eventBus.before("active")) {
                    return false;
                } else {
                    this.active = true;
                    this.eventBus.trigger("active");
                    return true;
                }
            },
            deactivate: function deactivate() {
                if (!this.isActive()) {
                    return true;
                } else if (this.eventBus.before("idle")) {
                    return false;
                } else {
                    this.active = false;
                    this.close();
                    this.eventBus.trigger("idle");
                    return true;
                }
            },
            isOpen: function isOpen() {
                return this.menu.isOpen();
            },
            open: function open() {
                if (!this.isOpen() && !this.eventBus.before("open")) {
                    this.menu.open();
                    this._updateHint();
                    this.eventBus.trigger("open");
                }
                return this.isOpen();
            },
            close: function close() {
                if (this.isOpen() && !this.eventBus.before("close")) {
                    this.menu.close();
                    this.input.clearHint();
                    this.input.resetInputValue();
                    this.eventBus.trigger("close");
                }
                return !this.isOpen();
            },
            setVal: function setVal(val) {
                this.input.setQuery(_.toStr(val));
            },
            getVal: function getVal() {
                return this.input.getQuery();
            },
            select: function select($selectable) {
                var data = this.menu.getSelectableData($selectable);
                if (data && !this.eventBus.before("select", data.obj)) {
                    this.input.setQuery(data.val, true);
                    this.eventBus.trigger("select", data.obj);
                    this.close();
                    return true;
                }
                return false;
            },
            autocomplete: function autocomplete($selectable) {
                var query, data, isValid;
                query = this.input.getQuery();
                data = this.menu.getSelectableData($selectable);
                isValid = data && query !== data.val;
                if (isValid && !this.eventBus.before("autocomplete", data.obj)) {
                    this.input.setQuery(data.val);
                    this.eventBus.trigger("autocomplete", data.obj);
                    return true;
                }
                return false;
            },
            moveCursor: function moveCursor(delta) {
                var query, $candidate, data, payload, cancelMove;
                query = this.input.getQuery();
                $candidate = this.menu.selectableRelativeToCursor(delta);
                data = this.menu.getSelectableData($candidate);
                payload = data ? data.obj : null;
                cancelMove = this._minLengthMet() && this.menu.update(query);
                if (!cancelMove && !this.eventBus.before("cursorchange", payload)) {
                    this.menu.setCursor($candidate);
                    if (data) {
                        this.input.setInputValue(data.val);
                    } else {
                        this.input.resetInputValue();
                        this._updateHint();
                    }
                    this.eventBus.trigger("cursorchange", payload);
                    return true;
                }
                return false;
            },
            destroy: function destroy() {
                this.input.destroy();
                this.menu.destroy();
            }
        });
        return Typeahead;
        function c(ctx) {
            var methods = [].slice.call(arguments, 1);
            return function () {
                var args = [].slice.call(arguments);
                _.each(methods, function (method) {
                    return ctx[method].apply(ctx, args);
                });
            };
        }
    }();
    (function () {
        "use strict";
        var old, keys, methods;
        old = $.fn.typeahead;
        keys = {
            www: "tt-www",
            attrs: "tt-attrs",
            typeahead: "tt-typeahead"
        };
        methods = {
            initialize: function initialize(o, datasets) {
                var www;
                datasets = _.isArray(datasets) ? datasets : [].slice.call(arguments, 1);
                o = o || {};
                www = WWW(o.classNames);
                return this.each(attach);
                function attach() {
                    var $input, $wrapper, $hint, $menu, defaultHint, defaultMenu, eventBus, input, menu, typeahead, MenuConstructor;
                    _.each(datasets, function (d) {
                        d.highlight = !!o.highlight;
                    });
                    $input = $(this);
                    $wrapper = $(www.html.wrapper);
                    $hint = $elOrNull(o.hint);
                    $menu = $elOrNull(o.menu);
                    defaultHint = o.hint !== false && !$hint;
                    defaultMenu = o.menu !== false && !$menu;
                    defaultHint && ($hint = buildHintFromInput($input, www));
                    defaultMenu && ($menu = $(www.html.menu).css(www.css.menu));
                    $hint && $hint.val("");
                    $input = prepInput($input, www);
                    if (defaultHint || defaultMenu) {
                        $wrapper.css(www.css.wrapper);
                        $input.css(defaultHint ? www.css.input : www.css.inputWithNoHint);
                        $input.wrap($wrapper).parent().prepend(defaultHint ? $hint : null).append(defaultMenu ? $menu : null);
                    }
                    MenuConstructor = defaultMenu ? DefaultMenu : Menu;
                    eventBus = new EventBus({
                        el: $input
                    });
                    input = new Input({
                        hint: $hint,
                        input: $input
                    }, www);
                    menu = new MenuConstructor({
                        node: $menu,
                        datasets: datasets
                    }, www);
                    typeahead = new Typeahead({
                        input: input,
                        menu: menu,
                        eventBus: eventBus,
                        minLength: o.minLength
                    }, www);
                    $input.data(keys.www, www);
                    $input.data(keys.typeahead, typeahead);
                }
            },
            isEnabled: function isEnabled() {
                var enabled;
                ttEach(this.first(), function (t) {
                    enabled = t.isEnabled();
                });
                return enabled;
            },
            enable: function enable() {
                ttEach(this, function (t) {
                    t.enable();
                });
                return this;
            },
            disable: function disable() {
                ttEach(this, function (t) {
                    t.disable();
                });
                return this;
            },
            isActive: function isActive() {
                var active;
                ttEach(this.first(), function (t) {
                    active = t.isActive();
                });
                return active;
            },
            activate: function activate() {
                ttEach(this, function (t) {
                    t.activate();
                });
                return this;
            },
            deactivate: function deactivate() {
                ttEach(this, function (t) {
                    t.deactivate();
                });
                return this;
            },
            isOpen: function isOpen() {
                var open;
                ttEach(this.first(), function (t) {
                    open = t.isOpen();
                });
                return open;
            },
            open: function open() {
                ttEach(this, function (t) {
                    t.open();
                });
                return this;
            },
            close: function close() {
                ttEach(this, function (t) {
                    t.close();
                });
                return this;
            },
            select: function select(el) {
                var success = false, $el = $(el);
                ttEach(this.first(), function (t) {
                    success = t.select($el);
                });
                return success;
            },
            autocomplete: function autocomplete(el) {
                var success = false, $el = $(el);
                ttEach(this.first(), function (t) {
                    success = t.autocomplete($el);
                });
                return success;
            },
            moveCursor: function moveCursoe(delta) {
                var success = false;
                ttEach(this.first(), function (t) {
                    success = t.moveCursor(delta);
                });
                return success;
            },
            val: function val(newVal) {
                var query;
                if (!arguments.length) {
                    ttEach(this.first(), function (t) {
                        query = t.getVal();
                    });
                    return query;
                } else {
                    ttEach(this, function (t) {
                        t.setVal(newVal);
                    });
                    return this;
                }
            },
            destroy: function destroy() {
                ttEach(this, function (typeahead, $input) {
                    revert($input);
                    typeahead.destroy();
                });
                return this;
            }
        };
        $.fn.typeahead = function (method) {
            if (methods[method]) {
                return methods[method].apply(this, [].slice.call(arguments, 1));
            } else {
                return methods.initialize.apply(this, arguments);
            }
        };
        $.fn.typeahead.noConflict = function noConflict() {
            $.fn.typeahead = old;
            return this;
        };
        function ttEach($els, fn) {
            $els.each(function () {
                var $input = $(this), typeahead;
                (typeahead = $input.data(keys.typeahead)) && fn(typeahead, $input);
            });
        }

        function buildHintFromInput($input, www) {
            return $input.clone().addClass(www.classes.hint).removeData().css(www.css.hint).css(getBackgroundStyles($input)).prop("readonly", true).removeAttr("id name placeholder required").attr({
                autocomplete: "off",
                spellcheck: "false",
                tabindex: -1
            });
        }

        function prepInput($input, www) {
            $input.data(keys.attrs, {
                dir: $input.attr("dir"),
                autocomplete: $input.attr("autocomplete"),
                spellcheck: $input.attr("spellcheck"),
                style: $input.attr("style")
            });
            $input.addClass(www.classes.input).attr({
                autocomplete: "off",
                spellcheck: false
            });
            try {
                !$input.attr("dir") && $input.attr("dir", "auto");
            } catch (e) {
            }
            return $input;
        }

        function getBackgroundStyles($el) {
            return {
                backgroundAttachment: $el.css("background-attachment"),
                backgroundClip: $el.css("background-clip"),
                backgroundColor: $el.css("background-color"),
                backgroundImage: $el.css("background-image"),
                backgroundOrigin: $el.css("background-origin"),
                backgroundPosition: $el.css("background-position"),
                backgroundRepeat: $el.css("background-repeat"),
                backgroundSize: $el.css("background-size")
            };
        }

        function revert($input) {
            var www, $wrapper;
            www = $input.data(keys.www);
            $wrapper = $input.parent().filter(www.selectors.wrapper);
            _.each($input.data(keys.attrs), function (val, key) {
                _.isUndefined(val) ? $input.removeAttr(key) : $input.attr(key, val);
            });
            $input.removeData(keys.typeahead).removeData(keys.www).removeData(keys.attr).removeClass(www.classes.input);
            if ($wrapper.length) {
                $input.detach().insertAfter($wrapper);
                $wrapper.remove();
            }
        }

        function $elOrNull(obj) {
            var isValid, $el;
            isValid = _.isJQuery(obj) || _.isElement(obj);
            $el = isValid ? $(obj).first() : [];
            return $el.length ? $el : null;
        }
    })();
});
var InputTypeAhead = (function () {
    var typeAheadFields = {};

    //helper to change all strings in array to lower
    function keysToLowerCase(myArr) {
        return myArr.join('|').toLowerCase().split('|');
    }

    function substringMatcher(strs) {
        return function findMatches(q, cb) {
            var matches, substringRegex;

            // an array that will be populated with substring matches
            matches = [];

            // regex used to determine if a string contains the substring `q`
            substrRegex = new RegExp(q, 'i');

            // iterate through the pool of strings and for any string that
            // contains the substring `q`, add it to the `matches` array
            $.each(strs, function (i, str) {
                if (substrRegex.test(str)) {
                    matches.push(str);
                }
            });

            cb(matches);
        };
    }

    //read in json file
    //return inputJson - json object with list (needs to match file name)
    //       fileName - unsure of another way to do this, read in json object name e.g. districts
    function readJsonFromPath(inputToReadIn) {
        var inputJson = [];
        var urlToRead = $(inputToReadIn).data('json-path');

        var lastSlash = urlToRead.lastIndexOf("/");
        var fileExtension = urlToRead.lastIndexOf(".");
        var fileName = urlToRead.slice(lastSlash + 1, fileExtension);

        $.getJSON(urlToRead, function (json) {
            for (var i = 0; i < json[0][fileName].length; i++) {
                inputJson.push(json[0][fileName][i]);
            }

            typeAheadFields[urlToRead] = {};
            typeAheadFields[urlToRead].fileName = fileName;
            typeAheadFields[urlToRead].inputJson = inputJson;
        });

        return {
            inputJson: inputJson,
            fileName: fileName
        };
    }


    //return true if input box value is included in json list
    function validateInListObject(input, currentVal) {
        var containsKey = false;
        var urlToRead = $(input).data('json-path');
        var inputJson = typeAheadFields[urlToRead].inputJson;
        containsKey = keysToLowerCase(inputJson).indexOf(currentVal.toLowerCase()) > -1;
        return containsKey;
    }

    //use twitter typeahead to turn input boxes into input box + hidden dropdown of populated list from json
    return {
        //use twitter typeahead to turn input boxes into input box + hidden dropdown of populated list from json
        init: function () {
            $(window).on("load", function () {

                $('.js-input-typeahead').each(function () {
                    var readObject = readJsonFromPath($(this));
                    var inputJson = readObject.inputJson;
                    var fileName = readObject.fileName;

                    $(this).typeahead({
                            hint: false,
                            highlight: true,
                            minLength: 1
                        },
                        {
                            name: fileName,
                            source: substringMatcher(inputJson)
                        });
                });

                //searchable dropdown
                $('.js-input-searchable-dropdown').each(function () {
                    var readObject = readJsonFromPath($(this));
                    var inputJson = readObject.inputJson;
                    var fileName = readObject.fileName;
                    $(this).typeahead({
                        hint: false,
                        highlight: true,
                        minLength: 0
                    },
                    {
                        name: fileName,
                        source: substringMatcher(inputJson)
                    });
                });

            });
        },
        validateInListObject: validateInListObject
    };
})();
InputTypeAhead.init();
var metlifeDropdownFunctions = {
        customListItems: function($styledSelect, listItem, $list) {
            $styledSelect.closest(".guideDropDownList").removeClass('active-state');
            $styledSelect.text($(listItem).text()).removeClass('active');
            $styledSelect.focus();
            $list.hide();
            $styledSelect.attr("aria-expanded", "false");
            var thisVal = $(listItem).attr('rel');
            $styledSelect.parent().find('.select-hidden').val(thisVal).trigger('change');
            $(listItem).closest(".select-options").find("li.selected").removeClass("selected");
            $(listItem).closest(".select-options").find("li.focused").removeClass("focused");
            var selectedLabel = $(listItem).parents(':eq(1)').find("label");
            if (thisVal != "") {
                $(selectedLabel).addClass("selected");
                $styledSelect.addClass("selected-state");
            } else {
                $(selectedLabel).removeClass("selected");
                $styledSelect.removeClass("selected-state");
            }
        },

        customADAListEventsScrollDown: function($listItems, $styledSelect, listItem, $list) {
            var selectedIndex = $styledSelect.parent().find('select option:selected').index();
            var selectedElement = $styledSelect.parent().find(".select-options li")[selectedIndex];
            $(listItem).closest(".select-options").find("li").removeClass("selected");
            var thisVal;
            if ($(selectedElement).next("li").length > 0) {
                thisVal = $(selectedElement).next("li").attr('rel');
                $(selectedElement).next("li").addClass("selected");
                $(selectedElement).next("li").focus();
            } else {
                thisVal = $(selectedElement).attr('rel');
                $(selectedElement).addClass("selected");
            }
            $styledSelect.text($(listItem).text());
            $styledSelect.parent().find('.select-hidden').val(thisVal).trigger('change');

        },

        customADAEventsScrollDownList:function($listItems, $styledSelect, listItem, $list) {
            var selectedIndex = $styledSelect.parent().find('select option:selected').index();
            var selectedElement = $styledSelect.parent().find(".select-options li")[selectedIndex];
            var nextElement = $styledSelect.parent().find(".select-options li")[selectedIndex + 1];
            $(listItem).closest(".select-options").find("li.selected").removeClass("selected");
            var thisVal;
            if ($(nextElement).length > 0) {
                thisVal = $(nextElement).attr('rel');
                $(nextElement).addClass("selected");
                $(nextElement).focus();
            } else {
                thisVal = $(selectedElement).attr('rel');
                $(selectedElement).addClass("selected");
            }

            $styledSelect.parent().find('.select-hidden').val(thisVal).trigger('change');
        },

        customADAListEventsScrollUp:function($listItems, $styledSelect, listItem, $list) {
            var selectedIndex = $styledSelect.parent().find('select option:selected').index();
            var selectedElement = $styledSelect.parent().find(".select-options li")[selectedIndex];
            $(listItem).closest(".select-options").find("li").removeClass("selected");
            var thisVal;
            if ($(selectedElement).prev("li").length > 0) {
                thisVal = $(selectedElement).prev("li").attr('rel');
                $(selectedElement).prev("li").addClass("selected");
                $(selectedElement).prev("li").focus();
            } else {
                thisVal = $(selectedElement).attr('rel');
                $(selectedElement).addClass("selected");
            }
            $styledSelect.parent().find('.select-hidden').val(thisVal).trigger('change');

        },

        customADAEventsScrollUpList:function($listItems, $styledSelect, listItem, $list) {
            var selectedIndex = $styledSelect.parent().find('select option:selected').index();
            var selectedElement = $styledSelect.parent().find(".select-options li")[selectedIndex];
            var prevElement = $styledSelect.parent().find(".select-options li")[selectedIndex - 1];
            $(listItem).closest(".select-options").find("li.selected").removeClass("selected");
            var thisVal;
            if ($(prevElement).length > 0) {
                thisVal = $(prevElement).attr('rel');
                $(prevElement).addClass("selected");
                $(prevElement).focus();
            } else {
                thisVal = $(selectedElement).attr('rel');
                $(selectedElement).addClass("selected");
            }

            $styledSelect.parent().find('.select-hidden').val(thisVal).trigger('change');
        },

        customListItemEvents:function($listItems, $styledSelect, listItem, $list) {
            $listItems.keypress(function (e) {
                var key = e.which;
                if ((key == 32) || (key == 13)) {  // trigger click with the enter key or space bar
                    metlifeDropdownFunctions.customListItems($styledSelect, this, $list);
                    return false;
                }

            });


            $listItems.click(function (e) {
                e.stopPropagation();
                metlifeDropdownFunctions.customListItems($styledSelect, this, $list);

            });


            $list.find("li").unbind("keydown");

            $listItems.keydown(function (e) {
                var key = e.which;
                if (key == 9) {
                    e.stopPropagation();
                    e.preventDefault();
                    if ($list.is(":visible") == true) {
                        $styledSelect.closest(".guideDropDownList").removeClass('active-state');
                        $styledSelect.removeClass('active');
                        $list.hide();
                        $styledSelect.attr("aria-expanded", "false");
                        $styledSelect.focus();
                    }
                }
                if (key == 38) {
                    var currentIndex = $styledSelect.parent().find('select option:selected').index();
                    if(currentIndex == 1){
                        e.stopPropagation();
                        e.preventDefault();
                    }
                    else{
                        e.stopPropagation();
                        e.preventDefault();
                        metlifeDropdownFunctions.customADAEventsScrollUpList($listItems, $styledSelect, this, $list);
                    }
                }
                if (key == 40) {
                    e.stopPropagation();
                    e.preventDefault();
                    metlifeDropdownFunctions.customADAEventsScrollDownList($listItems, $styledSelect, this, $list);
                }
            });

        },
        initCustomDropdowns:function(cssSelector){
            $(cssSelector).each(function () {
                    var $this = $(this), numberOfOptions = $(this).children('option');
                    var labelledBy = $(this).closest(".guideFieldNode").find("label").attr("id");
            		var required = $(this).attr("aria-required");
                    $this.addClass('select-hidden');

                    if(required == "true"){
                             $this.after('<div class="select-styled" tabindex="0"  role="combobox" aria-required="true" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="' + labelledBy + '"></div>');
                    }
                    else{
                        $this.after('<div class="select-styled" tabindex="0"  role="combobox" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="' + labelledBy + '"></div>');
                    }
                    var $styledSelect = $this.next('div.select-styled');
                    $styledSelect.text($this.children('option').eq(0).text());
                    var $list = $('<ul />', {
                        'class': 'select-options',
                        'role': 'listbox',
                        'tabindex': '-1'
                    }).insertAfter($styledSelect);

                    numberOfOptions.each(function () {
                        if ($(this).attr("id") == "emptyValue") {
                            $('<li />', {
                                text: $(this).text(),
                                rel: $(this).val()
                            }).addClass("empty-value").appendTo($list);
                        } else {
                            $('<li />', {
                                text: $(this).text(),
                                rel: $(this).val()
                            }).appendTo($list);
                        }

                    });


                    var $listItems = $list.children('li');
                    $listItems.each(function () {
                        $(this).attr('tabindex', 0).attr('role', 'option');
                    });

                    $styledSelect.keypress(function (e) {
                        var key = e.which;

                        if ((key == 32) || (key == 13)) {  // trigger click with the enter key or space bar
                            $styledSelect.click();
                            return false;
                        }

                    });

                    $styledSelect.keydown(function (e) {
                        var key = e.which;
                        if($(".select-options").is(":visible")){
                        if ((key == 38) || (key == 37)) {
                            e.stopPropagation();
                            e.preventDefault();
                            metlifeDropdownFunctions.customADAListEventsScrollUp($listItems, $styledSelect, this, $list);

                        }
                        if ((key == 39) || (key == 40)) {
                            e.stopPropagation();
                            e.preventDefault();
                            metlifeDropdownFunctions.customADAListEventsScrollDown($listItems, $styledSelect, this, $list);

                        }
                        }
                    });

                    $styledSelect.click(function (e) {
                        e.stopPropagation();
                        $(this).closest(".guideDropDownList").toggleClass('active-state');
                        $('div.select-styled.active').not(this).each(function () {
                            $(this).closest(".guideDropDownList").removeClass('active-state');
                            $(this).removeClass('active').next('ul.select-options').hide();
                            $(this).removeClass('active').next('ul.select-options').attr("aria-expanded", "false");
                        });
                        $(this).toggleClass('active').next('ul.select-options').toggle();
                        $(this).attr("aria-expanded", "true");
                        var selectedIndex = $(this).parent().find('select option:selected').index();
                        var selectedElement = $(this).parent().find(".select-options li")[selectedIndex];
                        $(this).parent().find(".select-options li").removeClass("selected");
                        $(this).parent().find(".select-options li").removeClass("focused");
                        $(selectedElement).addClass("selected");
                        $(selectedElement).addClass("focused");
                        $(selectedElement).focus();
                    });

                   metlifeDropdownFunctions.customListItemEvents($listItems, $styledSelect, this, $list);

                    $(document).on("mouseover", ".guideDropDownList:not(.underlined) .select-options li", function (e) {
                        $($listItems).removeClass("selected");
                    });

                    $(document).click(function () {
                        $styledSelect.closest(".guideDropDownList").removeClass('active-state');
                        $styledSelect.removeClass('active');
                        $list.hide();
                        $styledSelect.attr("aria-expanded", "false");
                    });

                    $(window.parent.document).click(function () {
                        $styledSelect.closest(".guideDropDownList").removeClass('active-state');
                        $styledSelect.removeClass('active');
                        $list.hide();
                        $styledSelect.attr("aria-expanded", "false");
                    });


            });

            $(document).on("change", cssSelector, function () {
                var value = $(this).find("option:selected").text();
                var $styledSelect = $(this).next('div.select-styled');
                $styledSelect.text(value);
                var selectedIndex = $(this).find(' option:selected').index();
                var selectedElement = $styledSelect.parent().find(".select-options li")[selectedIndex];
                $(selectedElement).addClass("selected");
                var selectedLabel = $(this).parents(':eq(1)').find("label");
                if ($(this).val() != "") {
                    $(selectedLabel).addClass("selected");
                    $styledSelect.addClass("selected-state");
                } else {
                    $(selectedLabel).removeClass("selected");
                    $styledSelect.removeClass("selected-state");
                }
                if(!GLOBAL.formStart && typeof formCustomDropDownStart != 'underfined' && !formCustomDropDownStart){
                    metlife_analytics_functions.onFormStartEvent();
                    GLOBAL.formStart = true;
                    formCustomDropDownStart = true;
                }
            });
        },
        customSearchableLiItems: function($styledInput, liItem, $ulList) {
            $styledInput.closest(".guideDropDownList").removeClass("active-state");
            $styledInput.val($(liItem).text());

            $ulList.hide();
            $styledInput.attr("aria-expanded", "false");

            var thisVal = $(liItem).attr("rel");
            $styledInput.parent().find("select.select-hidden").val(thisVal).trigger("change");

            $(liItem).closest("ul.select-options").find("li.selected").removeClass("selected");
            $(liItem).closest("ul.select-options").find("li.focused").removeClass("focused");

            var selectedLabel = $(liItem).closest(".guideFieldNode").find(".guideFieldLabel label");

            if (thisVal !== "") {
                $(selectedLabel).addClass("selected");
                $styledInput.addClass("selected-state");
            } else {
                $(selectedLabel).removeClass("selected");
                $styledInput.removeClass("selected-state");
            }
            $styledInput.focus();
        },
        customSearchableLiItemEvents: function($liItems, $styledInput, liItem, $ulList) {
            $liItems.click(function (e) {
                e.stopPropagation();
                metlifeDropdownFunctions.customSearchableLiItems($styledInput, this, $ulList);
            });

            $liItems.keypress(function (e) {
                var key = e.which;
                if ((key == 32) || (key == 13)) {
                    metlifeDropdownFunctions.customSearchableLiItems($styledInput, this, $ulList);
                    return false;
                }
            });

            $ulList.find("li").unbind("keydown");
            $liItems.keydown(function (e) {
                var key = e.which;
                if (key == 9) {
                    e.stopPropagation();
                    e.preventDefault();
                    if ($ulList.is(":visible") == true) {
                        $styledInput.closest(".guideDropDownList").removeClass("active-state");
                        $styledInput.parent().siblings(".guideFieldLabel").find("label").removeClass("focus-state");
                        $ulList.hide();
                        $styledInput.attr("aria-expanded", "false");
                        $styledInput.focus();
                    }
                }
                if (key == 38) {
                    var currentIndex = $styledInput.parent().find("ul li.selected").index();
                    if (currentIndex == 1){
                        e.stopPropagation();
                        e.preventDefault();
                    } else{
                        e.stopPropagation();
                        e.preventDefault();
                        metlifeDropdownFunctions.customADAEventsScrollUpList($liItems, $styledInput, this, $ulList);
                    }
                }
                if (key == 40) {
                    e.stopPropagation();
                    e.preventDefault();
                    metlifeDropdownFunctions.customADAEventsScrollDownList($liItems, $styledInput, this, $ulList);
                }
            });
        },
        initSearchableDropdowns: function(cssSelector) {
            $(cssSelector).each(function() {
                var $this = $(this), selectOptions = $(this).children("option");
                var labelledBy = $(this).closest(".guideFieldNode").find("label").attr("id");
                var required = $(this).attr("aria-required");
                $this.addClass("select-hidden");
                $this.parent().siblings(".guideFieldLabel").find('label').removeClass("hidden-label");
                if(required == "true") {
                    $this.after('<input type="text" class="searchable select-styled" tabindex="0" role="combobox" aria-required="true" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="' + labelledBy + '"/>');
                } else {
                    $this.after('<input type="text" class="searchable select-styled" tabindex="0" role="combobox" aria-required="true" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="' + labelledBy + '"/>');
                }

                var $styledInput = $this.next("input.select-styled");
                $styledInput.text(selectOptions.eq(0).text());

                var $ulList = $("<ul />", {
                    "class": "select-options",
                    "role": "listbox",
                    "tabindex": "-1",
                    "title": "select options"
                }).insertAfter($styledInput);

                selectOptions.each(function () {
                    if ($(this).attr("id") == "emptyValue") {
                        $("<li />", {
                            text: $(this).text(),
                            rel: $(this).val()
                        }).addClass("empty-value").appendTo($ulList);
                    } else {
                        $("<li />", {
                            text: $(this).text(),
                            rel: $(this).val()
                        }).appendTo($ulList);
                    }
                });

                var $liItems = $ulList.children("li");
                $liItems.each(function () {
                    $(this).attr("tabindex", 0).attr("role", "option");
                });


                $styledInput.click(function (e) {
                    e.stopPropagation();
                    $(this).next("ul.select-options").find("span").removeClass("span-filter");
                    $(this).next("ul.select-options").toggle();
                    $(this).attr("aria-expanded", "true");
                    $(this).parent().siblings(".guideFieldLabel").find("label").addClass("focus-state");

                    var selectedIndex = $(this).parent().find("select option:selected").index();
                    var selectedElement = $(this).parent().find("ul.select-options li")[selectedIndex];

                    $(this).parent().find("ul.select-options li").removeClass("selected");
                    $(this).parent().find("ul.select-options li").removeClass("focused");

                    $(selectedElement).addClass("selected");
                    $(selectedElement).addClass("focused");
                });


                $styledInput.keypress(function (e) {
                    var key = e.which;
                    if ((key == 32) || (key == 13)) {  // trigger click with the enter key or space bar
                        e.stopPropagation();
                        $styledInput.click();
                    }
                });


                $styledInput.keydown(function (e) {
                    var key = e.which;
                    if($("ul.select-options").is(":visible")){
                        if ((key == 38) || (key == 37)) {
                            e.stopPropagation();
                            e.preventDefault();
                            metlifeDropdownFunctions.customADAListEventsScrollUp($liItems, $styledInput, this, $ulList);
                        }
                        if ((key == 39) || (key == 40)) {
                            e.stopPropagation();
                            e.preventDefault();
                            metlifeDropdownFunctions.customADAListEventsScrollDown($liItems, $styledInput, this, $ulList);
                        }
                    }
                });

                metlifeDropdownFunctions.customSearchableLiItemEvents($liItems, $styledInput, this, $ulList);

                $(document).on("mouseover", ".guideDropDownList:not(.underlined) ul.select-options li", function (e) {
                    $($liItems).removeClass("selected");
                });


                $(document).click(function () {
                    $styledInput.removeClass('active');
                    $ulList.hide();
                    $styledInput.attr("aria-expanded", "false");
                    if($styledInput.val() === "") {
                        $styledInput.parent().siblings(".guideFieldLabel").find("label").removeClass("focus-state");
                    }
                });

                $(window.parent.document).click(function () {
                    $styledInput.removeClass('active');
                    $ulList.hide();
                    $styledInput.attr("aria-expanded", "false");
                    if($styledInput.val() === "") {
                        $styledInput.parent().siblings(".guideFieldLabel").find("label").removeClass("focus-state");
                    }
                });

                $styledInput.on("keyup", function () {
                    var filter, options, i, flag = false;
                    filter = $(this).val().toLowerCase();
                    options = $(this).siblings("ul.select-options").find("li");
                    $ulList.show();
                    $(options).removeClass("focused");

                    for (i = 0; i < options.length; i++) {
                        txtValue = options[i].textContent || options[i].innerText;
                        if (txtValue.toLowerCase().indexOf(filter) > -1) {
                            flag = true;
                            options[i].style.display = "";
                            txtValue = options[i].textContent.toLowerCase().replace(filter, '<span class="span-filter">'+filter+'</span>')
                            || options[i].innerText.toLowerCase().replace(filter, '<span class="span-filter">'+filter+'</span>');
                            options[i].innerHTML= txtValue;
                        } else {
                            options[i].style.display = "none";
                        }
                    }
                    $ulList[flag ? "show" : "hide"]();

                });

                $(this).parents(":eq(1)").click(function (e) {
                    e.stopPropagation();
                    e.preventDefault();
                    $(this).closest(".guideFieldNode").find("label").addClass("focus-state");
                    $(this).closest(".guideFieldNode").find("ul.select-options").toggle();
                    $(this).closest(".guideFieldNode").find("input.select-styled").focus();
                });

                $(this).parents(":eq(1)").hover(
                    function () {
                        $(this).closest(".guideFieldNode").find("input.select-styled").addClass("hover-input");
                    },
                    function () {
                        $(this).closest(".guideFieldNode").find("input.select-styled").removeClass("hover-input");
                    }
                );

                $(this).parents(":eq(1)").focus(
                    function () {
                        $(this).closest(".guideFieldNode").find("input.select-styled").addClass("focus-input");
                    },
                    function () {
                        $(this).closest(".guideFieldNode").find("input.select-styled").removeClass("focus-input");
                    }
                );

            });
        }


}


$(document).ready(function () {
	if(!$(".contactSidebar").length) {
	    metlifeDropdownFunctions.initCustomDropdowns('.userInputPanel .dropDownList:not(.searchableDropdown) select');
        metlifeDropdownFunctions.initSearchableDropdowns('.userInputPanel .searchableDropdown select');

        function htmlDecode(input){
            var e = document.createElement('textarea');
            e.innerHTML = input;
            // handle case of empty input
            return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
        }

        var observer = new MutationObserver(function(mutations) {
            $(mutations[0].target).closest(".dropDownList").find('div.select-styled').html($(mutations[0].target).closest(".dropDownList").find(".select-options li.empty-value").html());
            $(mutations[0].target).closest(".dropDownList").find(".select-options li:not(.empty-value)").remove();
            mutations.forEach(function(mutation) {
                if( mutation.type == 'childList' && mutation.addedNodes.length !=0){
                    console.log( $(mutation.addedNodes[0]).html());
                     $('<li />', {
                        text: htmlDecode($(mutation.addedNodes[0]).html()),
                        tabindex: "0",
                        role: "option",
                        rel: $(mutation.addedNodes[0]).attr("value")
                    }).appendTo($(mutation.target).closest(".dropDownList").find(".select-options"));
                }
            });

           $(mutations[0].target).closest(".guidedropdownlist").find('label').removeClass("focus-state");
           $(mutations[0].target).closest(".guidedropdownlist").find('label').addClass("hidden-label");
           $(mutations[0].target).closest(".dropDownList").find('div.select-styled').removeClass("selected-state");
          var $list = $(mutations[0].target).closest(".dropDownList").find(".select-options");
          var $listItems = $(mutations[0].target).closest(".dropDownList").find(".select-options li");
          var $styledSelect = $(mutations[0].target).closest(".dropDownList").find('div.select-styled');
          var $select = $(mutations[0].target).closest(".dropDownList").find('select');
          $select.val("").trigger("change");
          $(mutations[0].target).closest(".guideDropDownList").removeClass("validation-failure");
          metlifeDropdownFunctions.customListItemEvents($listItems, $styledSelect, $(mutations[0].target), $list);
          $(mutations[0].target).closest(".guideDropDownList").find(".select-options").scrollTop(0);
        });

        var config = { childList: true };

        $(".dropDownList select").each(function(){
            observer.observe($(this)[0], config);
        })
    }

    if ($("#fdtheme-id-clientlibs link[href*='nh-microsite-calculator-theme']").length > 0) {

        $(".nh-pfml-state select").each(function(){
            var value = "New Hampshire";
            var $styledSelect = $(this).next('div.select-styled');
            $styledSelect.text(value);
            var selectedElement = $styledSelect.parent().find(".select-options li")[1];
            $(selectedElement).addClass("selected");
            $styledSelect.parent().find('.select-hidden').val("NH").trigger('change');
        });

        $(".SourceInfo select").each(function(){
            var value = "100%";
            var $styledSelect = $(this).next('div.select-styled');
            $styledSelect.text(value);
            var selectedElement = $styledSelect.parent().find(".select-options li")[1];
            $(selectedElement).addClass("selected");
            $styledSelect.parent().find('.select-hidden').val("100").trigger('change');
        });

    }
});
var selectedDay;
var months_ele_year;
var years_selection;
var metlifeDatePicker = {
        setSingleDateValue: function(dateFormat,month,day,year){
            if(month < 10){
                month = "0"+month;
            }
            if(day < 10){
                day = "0"+day;
            }
            var formattedDate= ""
            switch (dateFormat) {
                case "mm/yyyy":
                    formattedDate = month + "/" + year;
                    break;
                case "mm-yyyy":
                    formattedDate = month + "-" + year;
                    break;
                case "yyyy":
                    formattedDate = year;
                    break;
                case "yyyy-mm":
                    formattedDate = year + "-" + month;
                    break;
                case "yyyy/mm":
                    formattedDate = year + "/" + month;
                    break;
                case "yyyy/mm/dd":
                    formattedDate = year + "/" + month + "/" + day;
                    break;
                case "yyyy-mm-dd":
                    formattedDate = year + "-" + month + "-" + day;
                    break;
                case "mm/dd/yyyy":
                    formattedDate = month + "/" + day + "/" + year;
                    break;
                case "mm-dd-yyyy":
                    formattedDate = month + "-" + day + "-" + year;
                    break;
                case "dd/mm/yyyy":
                    formattedDate = day + "/" + month + "/" + year;
                     break;
                case "dd-mm-yyyy":
                    formattedDate = day + "-" + month + "-" + year;
                    break;
                default:
                    formattedDate = month + "/" + day + "/" + year;
                    break;


            }

            return formattedDate;
        },
        disableDates:function(date_picker_ele){
            var month = parseInt(date_picker_ele.attr("data-month-current"))+1;
            var day = parseInt(date_picker_ele.attr("data-date-current"));
            var year = parseInt(date_picker_ele.attr("data-year-current"));
            var dayContainer = date_picker_ele.find(".days-container");
            var dayRangeContainer = date_picker_ele.find(".days-container-range");
            var disableDates = date_picker_ele.attr("data-disabled-dates").split(",");
            for(var i=0; i< disableDates.length; i++){
                var str = disableDates[i].trim();
                var disabledMonth = parseInt(str.substring(0, 2));
                var disabledDay = parseInt(str.substring(3, 5));
                var disabledYear = parseInt(str.substring(6, 10));

                if(disabledYear == year){
                    if(disabledMonth==month){
                        dayContainer.find(".day[value='"+disabledDay+"']").addClass("disabled-date");
                        if(dayRangeContainer.length > 0){
                            dayRangeContainer.find(".day[value='"+disabledDay+"']").addClass("disabled-date");
                        }

                    }
                }

            }
        },
        setCurrentDate:function(date_picker_ele,date){
            date_picker_ele.find(".day").each(function(e){
                if($(this).attr("value")==date){
                    $(this).addClass("current-date");
                }
            });
        },
        setCurrentDateRange:function(parent){
            var minDate = parent.attr("data-min-value");
            var maxDate = parent.attr("data-max-value");
            var yearCurrent = parent.attr("data-year-current");
            var monthCurrent = parent.attr("data-month-current");
            var rangeYearCurrent = parent.attr("data-year-range-current");
            var rangeMonthCurrent = parent.attr("data-month-range-current");
            var maxDate = parent.attr("data-max-value");
            var firstDateGroup = parent.find(".days-container");
            var SecondDateGroup = parent.find(".days-container-range");
            if(minDate != null && minDate != ""){
                var selectedMinDate = new Date(minDate);
                var month = selectedMinDate.getMonth();
                if(month < 0){
                    month == 0
                }
                if(month == monthCurrent && selectedMinDate.getFullYear() == yearCurrent){
                    firstDateGroup.find(".day[value='"+selectedMinDate.getDate()+"']").addClass("selected");
                    firstDateGroup.find(".day[value='"+selectedMinDate.getDate()+"']").addClass("min-value");
                }else if(month == rangeMonthCurrent && selectedMinDate.getFullYear() == rangeYearCurrent){
                    SecondDateGroup.find(".day[value='"+selectedMinDate.getDate()+"']").addClass("selected");
                    SecondDateGroup.find(".day[value='"+selectedMinDate.getDate()+"']").addClass("min-value");
                }
            }
            if(maxDate != null && maxDate != ""){
                var selectedMaxDate = new Date(maxDate);
                var month = selectedMaxDate.getMonth();
                if(month < 0){
                    month == 0
                }
                if(month == monthCurrent && selectedMaxDate.getFullYear() == yearCurrent){
                    firstDateGroup.find(".day[value='"+selectedMaxDate.getDate()+"']").addClass("selected");
                    firstDateGroup.find(".day[value='"+selectedMaxDate.getDate()+"']").addClass("max-value");
                }else if(month == rangeMonthCurrent && selectedMaxDate.getFullYear() == rangeYearCurrent){
                    SecondDateGroup.find(".day[value='"+selectedMaxDate.getDate()+"']").addClass("selected");
                    SecondDateGroup.find(".day[value='"+selectedMaxDate.getDate()+"']").addClass("max-value");
                }
            }

        },
        populateDates:function(dates_ele, month, year, day, days_ele, month_ele){
            var parent = dates_ele.closest(".date-picker-metlife");
            var date_picker_ele = parent.find(".date-picker-wrapper");
            var months = date_picker_ele.attr("data-months-name").split(",");
            var isRangeValueSelected = false;
            days_ele.html("");
            var total_days;
            var selectedMonth = Number(month).toString();
            if(selectedMonth == 1){
                if ((0 == year % 4) && (0 != year % 100) || (0 == year % 400)){
                    total_days = 29;
                }else{
                    total_days = 28;
                }

            }else if(selectedMonth % 2 === 0){
                total_days = 31;
            }else{
                total_days = 30;
            }


            var firstDay = new Date(year, month, 1);
            var currentDate = new Date();
            var currentMonth = currentDate.getMonth();
            var currentYear = currentDate.getFullYear();
            var currentDay = currentDate.getDate();

            for(var i =0; i<firstDay.getDay();i++){
                $('<div/>',{
                    text: '',
                    class: 'day empty'
                }).appendTo(days_ele)
            }

            for(var j =0; j<total_days;j++){

               $('<div/>',{
                   text: j+1,
                   value: j+1,
                   tabindex:'0',
                   class: 'day'
               }).appendTo(days_ele);
            }
            if(month==currentMonth && year==currentYear){
                    metlifeDatePicker.setCurrentDate(days_ele,currentDay);

            }



            if(date_picker_ele.hasClass("date-ranged-enable")){
                  metlifeDatePicker.setCurrentDateRange(date_picker_ele);
            }
            month_ele.text(months[month] + " " + year);
        },
        daySelection:function(day){
            var parent= day.closest(".date-picker-metlife");
            var date_picker_ele = parent.find(".date-picker-wrapper");
            var month = parseInt(date_picker_ele.attr("data-month-current"));
            var year = parseInt(date_picker_ele.attr("data-year-current"));
            var months = date_picker_ele.attr("data-months-name").split(",");
            var days = date_picker_ele.attr("data-day-name").split(",");
            var dateFormat = parent.find("input").attr("data-date-format");

            var selected_date_ele = parent.find(".selected-date");
            selectedDay = day.text();
             var selectedDate = new Date((month+1)+"/"+selectedDay+"/"+year);
            parent.find(".day").removeClass("selected");
            day.addClass("selected");
            date_picker_ele.addClass("selected-date-active");
            parent.find("input").focus().val(metlifeDatePicker.setSingleDateValue(dateFormat,month+1,selectedDay,year));

            parent.find("label").addClass("focus-state");
            selected_date_ele.text(days[selectedDate.getDay()]+", "+months[month] + " " + selectedDay +", "+ year);
            date_picker_ele.attr("data-date-current",selectedDay);
        },
        rangeDaySelection:function(day,isSelected){
            var parent= day.closest(".date-picker-metlife");
            var date_picker_ele = parent.find(".date-picker-wrapper");
            var month = parseInt(date_picker_ele.attr("data-month-current"))+1;

            var year = parseInt(date_picker_ele.attr("data-year-current"));
            var month_range = parseInt(date_picker_ele.attr("data-month-range-current"))+1;
            var year_range = parseInt(date_picker_ele.attr("data-year-range-current"));
            var months = date_picker_ele.attr("data-months-name").split(",");
            var days = date_picker_ele.attr("data-day-name").split(",");
            var dateFormat = parent.find("input").attr("data-date-format");
            var selected_date_ele = parent.find(".selected-date");

            if(isSelected){
               var selectedMaxDate;
               var selectedMaxDay = day.text();
               var maxMonth;
               var maxYear;
               if(day.closest(".days-container").length > 0){
                    maxMonth = month;
                    maxYear = year;
               }else{
                   maxMonth = month_range;
                   maxYear = year_range;
               }
               selectedMaxDate = metlifeDatePicker.setSingleDateValue(dateFormat,maxMonth,selectedMaxDay,maxYear);
               var minDate = new Date(date_picker_ele.attr("data-min-value"));
               var maxDate = new Date(maxMonth+"/"+selectedMaxDay+"/"+maxYear);
               if(maxDate.getTime() < minDate.getTime()){
                date_picker_ele.find(".day").removeClass("selected");
                date_picker_ele.find(".day.min-value").removeClass("active-selected");
                date_picker_ele.find(".day").removeClass("min-value");
                date_picker_ele.find(".day").removeClass("max-value");
                day.addClass("selected");
                day.addClass("min-value");
                date_picker_ele.attr("data-min-value",selectedMaxDate);
               }else{
                 date_picker_ele.attr("data-max-value",selectedMaxDate);
                 day.addClass("selected");
                 day.addClass("max-value");
                 parent.find("input").focus().val(date_picker_ele.attr("data-min-value")+" - "+date_picker_ele.attr("data-max-value"));
                 parent.find("label").addClass("focus-state");
                 selected_date_ele.text(months[minDate.getMonth()] + " " + minDate.getDate() +", "+ minDate.getFullYear() + " - " + months[maxDate.getMonth()] + " " + maxDate.getDate() +", "+ maxDate.getFullYear());
                 date_picker_ele.addClass("selected-date-active");
                 date_picker_ele.find(".day.min-value").addClass("active-selected");
               }


            }else{

                date_picker_ele.find(".day").removeClass("selected");
                date_picker_ele.find(".day").removeClass("max-value");
                date_picker_ele.find(".day").removeClass("min-value");
                date_picker_ele.find(".day").removeClass("active-selected");
                day.addClass("selected");
                day.addClass("min-value");
                var selectedMinDate;
                var selectedMinDay = day.text();
                var minMonth;
                var minYear;
                if(day.closest(".days-container").length > 0){
                     minMonth = month;
                     minYear = year;
                }else{
                    minMonth = month_range;
                    minYear = year_range;
                }
                selectedMinDate = metlifeDatePicker.setSingleDateValue(dateFormat,minMonth,selectedMinDay,minYear);
                date_picker_ele.attr("data-min-value",selectedMinDate);
            }

        },
        createYearsList: function(date_picker_ele, year){
            var parent =  date_picker_ele.closest(".date-picker-metlife");
            var years_container = date_picker_ele.find(".years-container");
            var currentYear = date_picker_ele.attr("data-year-current");
            var year_ele = parent.find(".months-group .year-items");
            var date = new Date();
            years_container.find(".year").removeClass("selected");
            years_container.html("");
            for(var y = 11; y >=0; y--){
                 $('<div/>',{
                       text: parseInt(year) - y,
                       class: 'year',
                       value: parseInt(year) - y,
                       role: 'button',
                       tabindex: '0'
                 }).appendTo(years_container);
            }


             years_container.find(".year[value='"+currentYear+"'").addClass("selected");
        },
        setUpMonthsYearsSelection: function(date_picker_ele){
            var months_container = date_picker_ele.find(".months-container");
            var years_container = date_picker_ele.find(".years-container");
            var currentYear = date_picker_ele.attr("data-year-current");
            var currentMonth = date_picker_ele.attr("data-month-current");
            var abbrvMonths;
            if(months_container.attr("data-months-abbrv") != "" && months_container.attr("data-months-abbrv") != null){
                abbrvMonths = months_container.attr("data-months-abbrv").split(",");
            }


            months_container.html("");
            years_container.html("");

            for(var i = 0; i < abbrvMonths.length; i++){
                $('<div/>',{
                       text:abbrvMonths[i],
                       class: 'month',
                       value: i,
                       role: 'button',
                       tabindex: '0'
                 }).appendTo(months_container);
            }

            for(var y = 11; y >=0; y--){
                 $('<div/>',{
                       text: parseInt(currentYear) - y,
                       class: 'year',
                       value: parseInt(currentYear) - y,
                       role: 'button',
                       tabindex: '0'
                 }).appendTo(years_container);
            }
            months_container.find(".month[value='"+currentMonth+"'").addClass("selected");
            years_container.find(".year[value='"+currentYear+"'").addClass("selected");
        },
        initDatePicker:function(parent){
            var date_picker_ele = parent.find(".date-picker-wrapper");
            var selected_date_ele = parent.find(".selected-date");
            var dates_ele  = parent.find(".dates-container");
            var abbrv_day_group = parent.find(".abbrv-day-group");
            var month_ele = parent.find(".months-group .month-item");
            var month_ele_date_range = parent.find(".months-group .date-range-month-item");
            var months_ele = parent.find(".months-group .months-items");
            var year_ele = parent.find(".months-group .year-items");
            var next_month_ele = parent.find(".months-group .next-month");
            var prev_month_ele = parent.find(".months-group .prev-month");
            var days_ele = parent.find(".days-container");
            var days_range_ele = parent.find(".days-container-range");
            var defaultValueDate;

            var date = new Date();
            var day = date.getDate();
            var month = date.getMonth();
            var year = date.getFullYear();
            var dayOfWeek = date.getDay();

            var selectedDate = date;
            selectedDay = day;
            var selectedMonth = month;
            var selectedYear = year;

            if(parent.find("input").val()==""){
                date_picker_ele.attr("data-year-current",year);
                date_picker_ele.attr("data-month-current",month);
                date_picker_ele.attr("data-date-current",selectedDay);
            }else{
                defaultValueDate = new Date(parent.find("input").val());
                date_picker_ele.attr("data-year-current",defaultValueDate.getFullYear());
                date_picker_ele.attr("data-month-current",defaultValueDate.getMonth());
                date_picker_ele.attr("data-date-current",defaultValueDate.getDate());
            }

            if(date_picker_ele.attr("data-months-name")!= null && date_picker_ele.attr("data-day-name") != null && date_picker_ele.attr("data-abbrv-day-name") != null){
                var months = date_picker_ele.attr("data-months-name").split(",");
                var days = date_picker_ele.attr("data-day-name").split(",");
                var days_abbrv = date_picker_ele.attr("data-abbrv-day-name").split(",");


                metlifeDatePicker.populateDates(dates_ele,month,year,selectedDay,days_ele, month_ele);
                metlifeDatePicker.setCurrentDate(date_picker_ele,day);
                if(days_range_ele.length > 0){

                  var yearRangeDate;
                   var monthRangeDate;
                   if(month == 11){
                          monthRangeDate = 0;
                          yearRangeDate = year+ 1;
                     }else{
                        monthRangeDate = month + 1;
                        yearRangeDate=year;
                    }
                   date_picker_ele.attr("data-month-range-current",monthRangeDate);
                   date_picker_ele.attr("data-year-range-current",yearRangeDate);
                   metlifeDatePicker.populateDates(dates_ele,monthRangeDate,yearRangeDate,selectedDay,days_range_ele,month_ele_date_range);
                }

                for(var i =0; i<days_abbrv.length;i++){

                   $('<div/>',{
                       text:days_abbrv[i],
                       class: 'day'
                   }).appendTo(abbrv_day_group);
                }
                 if(parent.find("input").val()!=""){
                    selected_date_ele.text(days[defaultValueDate.getDay()]+", "+months[defaultValueDate.getMonth()] + " " + defaultValueDate.getDate() +", "+ defaultValueDate.getFullYear());
                }

            }
            if(date_picker_ele.attr("data-disabled-dates")!= null && date_picker_ele.attr("data-disabled-dates")!= null){
               metlifeDatePicker.disableDates(date_picker_ele);
            }
            if(date_picker_ele.attr("data-enable-month-year")=="enabled"){
                metlifeDatePicker.setUpMonthsYearsSelection(date_picker_ele);
                months_ele.text(year);
                year_ele.text(parseInt(year-11) + " - " + year);
                months_ele_year = year;
                years_selection = year;
            }



       }

}

$(document).ready(function () {

        $(".date-picker-metlife").each(function(e){
            if($(".date-picker-metlife").length > 0){
                metlifeDatePicker.initDatePicker($(this));
            }
        });

        if($(".date-picker").hasClass("date-ranged-selected")){
            $(this).find("input").attr("readonly","readonly");
            $(this).find("label").addClass("clickable-label");
        }


        $(".guideFieldWidget.date-picker .date-picker-calendar, .date-ranged-selected input").click(function(e){
            e.stopPropagation();
            var parent = $(this).closest(".date-picker-metlife");
            var dates_ele  = parent.find(".dates-container");
            var days_ele = parent.find(".days-container");
            var month_ele = parent.find(".months-group .month-item");
            var date_picker_ele = parent.find(".date-picker-wrapper");
            var selected_date_ele = parent.find(".selected-date");
            if(!$(".date-picker-wrapper").hasClass("active")){
                $(this).closest("body").addClass("overlay-interaction");
                window.top.$(".aemFormFrame").css("min-height",window.top.$(".aemFormFrame").css("height"));
                parent.find(".date-picker-wrapper").addClass("active");
                parent.find(".date-picker-wrapper").addClass("bounceInDown");
                if(parent.find("input").val()==""){
                    var date = new Date();
                    var day = date.getDate();
                    var month = date.getMonth();
                    var year = date.getFullYear();

                    var months_ele_year = month;
                    var years_selection = year;

                    metlifeDatePicker.populateDates(dates_ele,month,year,day,days_ele,month_ele);
                    if(date_picker_ele.attr("data-disabled-dates")!= null && date_picker_ele.attr("data-disabled-dates")!= null){
                       metlifeDatePicker.disableDates(date_picker_ele);
                    }
                }
                if(!$(this).closest(".date-picker").hasClass("date-ranged-selected") && parent.find("input").val().length > 0){
                    var months = date_picker_ele.attr("data-months-name").split(",");
                    var days = date_picker_ele.attr("data-day-name").split(",");
                    var dateFormat = date_picker_ele.attr("data-date-format").trim();

                    if(parent.find("input").val().length == dateFormat.length && months != null && days != null){
                        var selectedDate = new Date(Number(parseInt(date_picker_ele.attr("data-month-current"))+1)+"/"+date_picker_ele.attr("data-date-current")+"/"+date_picker_ele.attr("data-year-current"));
                        parent.find(".day").removeClass("selected");
                        parent.find(".day[value='"+date_picker_ele.attr("data-date-current")+"']").addClass("selected");
                        date_picker_ele.addClass("selected-date-active");
                        selected_date_ele.text(days[selectedDate.getDay()]+", "+months[(date_picker_ele.attr("data-month-current") == 0 ? 0 : date_picker_ele.attr("data-month-current"))] + " " + date_picker_ele.attr("data-date-current") +", "+ date_picker_ele.attr("data-year-current"));

                    }
                }
                parent.find(".date-picker-calendar span").text(parent.find(".date-picker-calendar").attr("data-open-text"));
                $(".date-picker-calendar").attr("aria-expanded","true")
            }else{
                $(".date-picker-wrapper").removeClass('active');
                $(".date-picker-wrapper").removeClass('bounceInDown');
                parent.find(".date-picker-calendar span").text(parent.find(".date-picker-calendar").attr("data-close-text"));
                $(".date-picker-calendar").attr("aria-expanded","false")
            }

        }).on('keydown',function (e) {
                var key = e.keyCode;
                if ((key == 13) || (key  == 32)) {  // trigger click with the enter key or space ba
                    $(this).trigger("click");
                }

        });

        $(".guideFieldWidget.date-picker:not(.date-ranged-selected) input").on('keyup',function(e){
            var parent = $(this).closest(".date-picker-metlife");
            var date_picker_ele = parent.find(".date-picker-wrapper");
            var month_ele = parent.find(".months-group .month-item");
            var months_ele = parent.find(".months-group .months-items");
            var years_ele = parent.find(".months-group .year-items");
            var dates_ele  = parent.find(".dates-container");
            var days_ele = parent.find(".days-container");
            var dateFormat=$(this).attr("data-date-format");
            var date_picker_ele = $(this).closest(".date-picker-metlife").find(".date-picker-wrapper");
            var currentMonth = date_picker_ele.attr("data-month-current");
            var currentYear = date_picker_ele.attr("data-year-current");
            var currentDate = date_picker_ele.attr("data-date-current");
            var selected_date_ele = parent.find(".selected-date");
             var months = date_picker_ele.attr("data-months-name").split(",");
            var days = date_picker_ele.attr("data-day-name").split(",");

            if(e.which !== 13 && e.which !== 32){

                var regex="";
                switch (dateFormat) {
                    case "mm/yyyy":
                        regex = "^0?$|^(?:0?[1-9]|1[012]?)(?:[\\/](?:(?:0$|0?\\d{0,4})(?:-\\d{0,4})?)?)?$";
                        break;
                    case "mm-yyyy":
                        regex = "^0?$|^(?:0?[1-9]|1[012]?)(?:[-](?:(?:0$|0?\\d{0,4})(?:-\\d{0,4})?)?)?$";
                        break;
                    case "yyyy":
                        regex = "^\\d{0,4}$|^\\d{4}";
                        break;
                    case "yyyy-mm":
                        regex = "^\\d{0,4}$|^\\d{4}-0?$|^\\d{4}[-](?:0?[1]|1[012])?$";
                        break;
                    case "yyyy/mm":
                        regex = "^\\d{0,4}$|^\\d{4}-0?$|^\\d{4}[\\/-](?:0?[1]|1[012])?$";
                        break;
                    case "yyyy/mm/dd":
                        regex = "^\\d{0,4}$|^\\d{4}-0?$|^\\d{4}[\\/](?:0?[1-9]|1[012])(?:[\\/](?:0?[1-9]?|[12]\\d|3[01])?)?$";
                        break;
                    case "yyyy-mm-dd":
                        regex = "^\\d{0,4}$|^\\d{4}-0?$|^\\d{4}[-](?:0?[1-9]|1[012])(?:[-](?:0?[1-9]?|[12]\\d|3[01])?)?$";
                        break;
                    case "mm/dd/yyyy":
                        regex = '^0?$|^(?:0?[1-9]|1[012]?)(?:[\\/](?:(?:0$|0?[1-9]|[12]\\d|3[01])(?:[\\/]\\d{0,4})?)?)?$';
                        break;
                    case "mm-dd-yyyy":
                    default:
                        regex = '^0?$|^(?:0?[1-9]|1[012]?)(?:[-](?:(?:0$|0?[1-9]|[12]\\d|3[01])(?:[-]\\d{0,4})?)?)?$';
                        break;
                    case "dd/mm/yyyy":
                        regex = "^0?$|^(?:0?[1-9]|[12]\\d|3[01])(?:[\\/](?:(?:0$|0?[1-9]|1[012]?)(?:[\\/]\\d{0,4})?)?)?$";
                        break;
                    case "dd-mm-yyyy":
                        regex = "^0?$|^(?:0?[1-9]|[12]\\d|3[01])(?:[-](?:(?:0$|0?[1-9]|1[012]?)(?:[-]\\d{0,4})?)?)?$";
                        break;

                }
                var inputTest = new RegExp(regex);
                if($(this).val()!= ""){
                    if(!inputTest.test($(this).val())){
                        $(this).val($(this).val().slice(0, -1));
                    }else if($(this).val()!="" && $(this).val().length >=2){
                        switch (dateFormat) {
                            case "mm/yyyy":
                            case "mm-yyyy":
                                if($(this).val().length == 7){
                                    date_picker_ele.attr("data-month-current",Number(($(this).val().slice(0, 2))-1).toString());
                                    date_picker_ele.attr("data-year-current",Number($(this).val().slice(3, 7)).toString());
                                    metlifeDatePicker.populateDates(dates_ele,Number(($(this).val().slice(0, 2))-1).toString(),$(this).val().slice(3, 7),currentDate,days_ele,month_ele);

                                }else{
                                    date_picker_ele.attr("data-month-current",Number(($(this).val().slice(0, 2))-1).toString());
                                    metlifeDatePicker.populateDates(dates_ele,Number(($(this).val().slice(0, 2))-1).toString(),currentYear,currentDate,days_ele,month_ele);
                                }
                                 metlifeDatePicker.setUpMonthsYearsSelection(date_picker_ele);
                                months_ele.text(date_picker_ele.attr("data-year-current"));
                                break;

                            case "mm/dd/yyyy":
                            case "mm-dd-yyyy":
                            default:
                                if($(this).val().length == 10){
                                    date_picker_ele.attr("data-date-current",Number(($(this).val().slice(3,5))).toString());
                                    date_picker_ele.attr("data-month-current",Number(($(this).val().slice(0, 2))-1).toString());
                                    date_picker_ele.attr("data-year-current",Number($(this).val().slice(6, 10)).toString());
                                    metlifeDatePicker.populateDates(dates_ele,Number(($(this).val().slice(0, 2))-1).toString(),$(this).val().slice(6, 10),Number(($(this).val().slice(3,5))).toString(),days_ele,month_ele);
                                }else if($(this).val().length >= 5){
                                    date_picker_ele.attr("data-date-current",Number(($(this).val().slice(3,5))).toString());
                                    date_picker_ele.attr("data-month-current",Number(($(this).val().slice(0, 2))-1).toString());
                                    metlifeDatePicker.populateDates(dates_ele,Number(($(this).val().slice(0, 2))-1).toString(),currentYear,Number(($(this).val().slice(3,5))).toString(),days_ele,month_ele);
                                }else{
                                    date_picker_ele.attr("data-month-current",Number(($(this).val().slice(0, 2))-1).toString());
                                    metlifeDatePicker.populateDates(dates_ele,Number(($(this).val().slice(0, 2))-1).toString(),currentYear,currentDate,days_ele,month_ele);
                                }


                                  months_ele.text(date_picker_ele.attr("data-year-current"));
                                break;


                            case "yyyy":
                                if($(this).val().length == 4){
                                     date_picker_ele.attr("data-year-current",$(this).val());
                                     metlifeDatePicker.populateDates(dates_ele,currentMonth,$(this).val(),currentDate,days_ele,month_ele);
                                }else{
                                    metlifeDatePicker.populateDates(dates_ele,currentMonth,currentYear,currentDate,days_ele,month_ele);
                                }
                                 months_ele.text(date_picker_ele.attr("data-year-current"));
                                 metlifeDatePicker.setUpMonthsYearsSelection(date_picker_ele);

                                break;
                            case "yyyy-mm":
                            case "yyyy/mm":
                                if($(this).val().length == 7){
                                    date_picker_ele.attr("data-month-current",Number(($(this).val().slice(5,7))-1).toString());
                                    metlifeDatePicker.populateDates(dates_ele,Number(($(this).val().slice(5,7))-1).toString(),$(this).val().slice(0,4),currentDate,days_ele,month_ele);
                                }else if($(this).val().length >= 4){
                                    date_picker_ele.attr("data-year-current",Number($(this).val().slice(0,4)).toString());
                                    metlifeDatePicker.populateDates(dates_ele,currentMonth,$(this).val().slice(0,4),currentDate,days_ele,month_ele);
                                }else{
                                    metlifeDatePicker.populateDates(dates_ele,currentMonth,currentYear,currentDate,days_ele,month_ele);
                                }
                                 months_ele.text(date_picker_ele.attr("data-year-current"));
                                 metlifeDatePicker.setUpMonthsYearsSelection(date_picker_ele);

                                break;

                            case "yyyy/mm/dd":
                            case "yyyy-mm-dd":
                                if($(this).val().length == 10){
                                    date_picker_ele.attr("data-date-current",Number(($(this).val().slice(8,10))).toString());
                                    metlifeDatePicker.populateDates(dates_ele,Number(($(this).val().slice(5,7))-1).toString(),$(this).val().slice(0,4),Number(($(this).val().slice(8,10))).toString(),days_ele,month_ele);
                                }else if($(this).val().length >= 7){
                                    date_picker_ele.attr("data-month-current",Number(($(this).val().slice(5,7))-1).toString());
                                    date_picker_ele.attr("data-year-current",Number($(this).val().slice(0,4)).toString());
                                    metlifeDatePicker.populateDates(dates_ele,Number(($(this).val().slice(5,7))-1).toString(),$(this).val().slice(0,4),currentDate,days_ele,month_ele);
                                }
                                else if($(this).val().length >= 4){

                                    date_picker_ele.attr("data-year-current",Number($(this).val().slice(0,4)).toString());

                                    metlifeDatePicker.populateDates(dates_ele,currentMonth,$(this).val().slice(0,4),currentDate,days_ele,month_ele);
                                }else{
                                    metlifeDatePicker.populateDates(dates_ele,currentMonth,currentYear,currentDate,days_ele,month_ele);
                                }
                                 months_ele.text(date_picker_ele.attr("data-year-current"));
                                 metlifeDatePicker.setUpMonthsYearsSelection(date_picker_ele);


                                break;
                            case "dd/mm/yyyy":
                            case "dd-mm-yyyy":
                                if($(this).val().length == 10){
                                    date_picker_ele.attr("data-year-current",Number($(this).val().slice(6,10)).toString());
                                    date_picker_ele.attr("data-date-current",Number(($(this).val().slice(0,2))).toString());
                                    date_picker_ele.attr("data-month-current",Number(($(this).val().slice(3,5))-1).toString());
                                     metlifeDatePicker.populateDates(dates_ele,Number(($(this).val().slice(3,5))-1).toString(),$(this).val().slice(6, 10),Number(($(this).val().slice(0,2))).toString(),days_ele,month_ele);

                                }else if($(this).val().length >= 5){
                                   date_picker_ele.attr("data-date-current",Number(($(this).val().slice(0,2))).toString());
                                   date_picker_ele.attr("data-month-current",Number(($(this).val().slice(3,5))-1).toString());
                                   metlifeDatePicker.populateDates(dates_ele,Number(($(this).val().slice(3,5))-1).toString(),currentYear,Number(($(this).val().slice(0,2))).toString(),days_ele,month_ele);

                                }else{
                                    date_picker_ele.attr("data-date-current",Number(($(this).val().slice(0,2))).toString());
                                    metlifeDatePicker.populateDates(dates_ele,currentMonth,currentYear,currentDate,Number(($(this).val().slice(0,2))).toString(),month_ele);
                                }
                                 metlifeDatePicker.setUpMonthsYearsSelection(date_picker_ele);
                                  months_ele.text(date_picker_ele.attr("data-year-current"));

                                break;


                        }
                        var selectedDate = new Date(Number(parseInt(date_picker_ele.attr("data-month-current"))+1)+"/"+date_picker_ele.attr("data-date-current")+"/"+date_picker_ele.attr("data-year-current"));
                        parent.find(".day").removeClass("selected");
                        parent.find(".day[value='"+date_picker_ele.attr("data-date-current")+"']").addClass("selected");
                        date_picker_ele.addClass("selected-date-active");
                        metlifeDatePicker.setUpMonthsYearsSelection(date_picker_ele);
                        if(months != null && days != null){

                            selected_date_ele.text(days[selectedDate.getDay()]+", "+months[(date_picker_ele.attr("data-month-current") == 0 ? 0 : date_picker_ele.attr("data-month-current"))] + " " + date_picker_ele.attr("data-date-current") +", "+ date_picker_ele.attr("data-year-current"));

                        }
                        if(date_picker_ele.attr("data-disabled-dates")!= null && date_picker_ele.attr("data-disabled-dates")!= null){
                               metlifeDatePicker.disableDates(date_picker_ele);
                        }
                    }
                }

            }

        });

        $(document).click(function (event) {
            if($(event.target).closest(".date-picker-wrapper").length  == 0){
                $(".date-picker-wrapper").removeClass('active');
                $(".date-picker-wrapper").removeClass('bounceInDown');
                $(".date-picker-calendar span").text($(".date-picker-calendar").attr("data-close-text"));
                $(".date-picker-calendar").attr("aria-expanded","false")
            }
        }).on("keydown",function(e){
            if(e.keyCode == 27) {
                if($(".date-picker-wrapper").hasClass("active")){
                    $(".date-picker-wrapper").removeClass('active');
                    $(".date-picker-wrapper").removeClass('bounceInDown');
                    $(".date-picker-calendar span").text($(".date-picker-calendar").attr("data-close-text"));
                    $(".date-picker-calendar").attr("aria-expanded","false")
                }
            }
        });

        $(window.parent.document).click(function () {
            $(".date-picker-wrapper").removeClass('active');
            $(".date-picker-wrapper").removeClass('bounceInDown');
            $(".date-picker-calendar span").text($(".date-picker-calendar").attr("data-close-text"));
            $(".date-picker-calendar").attr("aria-expanded","false")
        });

        $(".date-picker-metlife .prev-month").click(function(e){
             e.stopPropagation();
            e.stopPropagation();
             var parent = $(this).closest(".date-picker-metlife");
             var date_picker_ele = parent.find(".date-picker-wrapper");
             var dates_ele  = parent.find(".dates-container");
            var days_ele = parent.find(".days-container");
            var days_range_ele = parent.find(".days-container-range");
              var month_ele = parent.find(".months-group .month-item");
              var month_ele_date_range = parent.find(".months-group .date-range-month-item");
              var months = date_picker_ele.attr("data-months-name").split(",");
                var months_ele = parent.find(".months-group .months-items");
                var years_ele = parent.find(".months-group .year-items");
               var month = parseInt(date_picker_ele.attr("data-month-current"));
               var year = parseInt(date_picker_ele.attr("data-year-current"));

               if($(this).attr("data-selection-type")=="day"){
                     var month = parseInt(date_picker_ele.attr("data-month-current"))-1;
                     var year = parseInt(date_picker_ele.attr("data-year-current"));
                     if(month <0){
                          month = 11;
                          year--;
                     }
                     month_ele.text(months[month] + " " + year);
                      date_picker_ele.attr("data-year-current",year);
                      date_picker_ele.attr("data-month-current",month);
                      metlifeDatePicker.populateDates(dates_ele,month,year,selectedDay,days_ele,month_ele);
                      if(days_range_ele.length > 0){
                           var yearRangeDate;
                           var monthRangeDate;
                           if(month == 11){
                                 monthRangeDate = 0;
                                 yearRangeDate = year+1;
                            }else{
                               monthRangeDate = month + 1;
                               yearRangeDate=year;
                           }
                           date_picker_ele.attr("data-month-range-current",monthRangeDate);
                           date_picker_ele.attr("data-year-range-current",yearRangeDate);
                           metlifeDatePicker.populateDates(dates_ele,monthRangeDate,yearRangeDate,selectedDay,days_range_ele,month_ele_date_range);
                     }
                      if(date_picker_ele.attr("data-disabled-dates")!= null && date_picker_ele.attr("data-disabled-dates")!= null){
                         metlifeDatePicker.disableDates(date_picker_ele);
                      }


              }
               if($(this).attr("data-selection-type")=="months"){
                    months_ele_year--;
                    months_ele.text(months_ele_year);
                    date_picker_ele.attr("data-year-current",months_ele_year);
                    years_selection=months_ele_year;
                    metlifeDatePicker.createYearsList(date_picker_ele, months_ele_year);
                    metlifeDatePicker.populateDates(dates_ele,month,months_ele_year,selectedDay,days_ele,month_ele);
                    if(date_picker_ele.attr("data-disabled-dates")!= null && date_picker_ele.attr("data-disabled-dates")!= null){
                       metlifeDatePicker.disableDates(date_picker_ele);
                    }
                }
                if($(this).attr("data-selection-type")=="years"){
                     years_selection = parseInt(years_selection-12);
                     metlifeDatePicker.createYearsList(date_picker_ele, parseInt(years_selection));
                     years_ele.text(years_selection-11 + " - " + years_selection);

                 }


        }).on('keydown',function (e) {
                var key = e.keyCode;
                if ((key == 32) || (key == 13)) {  // trigger click with the enter key or space bar
                    $(this).trigger("click");
                }
                if(e.keyCode == 27) {
                    if($(".date-picker-wrapper").hasClass("active")){
                        $(".date-picker-wrapper").removeClass('active');
                        $(".date-picker-wrapper").removeClass('bounceInDown');
                        $(".date-picker-calendar span").text($(".date-picker-calendar").attr("data-close-text"));
                        $(".date-picker-calendar span").attr($(".date-picker-calendar").attr("aria-expanded","false"));
                    }
                }

          });

        $(".date-picker-metlife .next-month").click(function(e){
             e.stopPropagation();
            var parent = $(this).closest(".date-picker-metlife");
             var date_picker_ele = parent.find(".date-picker-wrapper");
              var month_ele = parent.find(".months-group .month-item");
              var months_ele = parent.find(".months-group .months-items");
              var month_ele_date_range = parent.find(".months-group .date-range-month-item");
              var years_ele = parent.find(".months-group .year-items");
               var months = date_picker_ele.attr("data-months-name").split(",");
            var dates_ele  = parent.find(".dates-container");
             var days_ele = parent.find(".days-container");
             var days_range_ele = parent.find(".days-container-range");
             var month = parseInt(date_picker_ele.attr("data-month-current"))+1;
             var year = parseInt(date_picker_ele.attr("data-year-current"));

            if($(this).attr("data-selection-type")=="day"){
                 if(month > 11){
                    month = 0;
                    year++;
                 }
                 month_ele.text(months[month] + " " + year);
                 date_picker_ele.attr("data-year-current",year);
                 date_picker_ele.attr("data-month-current",month);
                 metlifeDatePicker.populateDates(dates_ele,month,year,selectedDay,days_ele,month_ele);
                 if(days_range_ele.length > 0){
                     var yearRangeDate;
                      var monthRangeDate;
                      if(month == 11){
                           monthRangeDate = 0;
                           yearRangeDate = year+1;
                      }else{
                         monthRangeDate = month + 1;
                         yearRangeDate=year;
                     }
                     date_picker_ele.attr("data-month-range-current",monthRangeDate);
                     date_picker_ele.attr("data-year-range-current",yearRangeDate);
                     metlifeDatePicker.populateDates(dates_ele,monthRangeDate,yearRangeDate,selectedDay,days_range_ele,month_ele_date_range);
                  }
                 if(date_picker_ele.attr("data-disabled-dates")!= null && date_picker_ele.attr("data-disabled-dates")!= null){
                    metlifeDatePicker.disableDates(date_picker_ele);
                 }

             }
             if($(this).attr("data-selection-type")=="months"){
                  months_ele_year++;
                  months_ele.text(months_ele_year);
                  date_picker_ele.attr("data-year-current",months_ele_year);
                  years_selection=months_ele_year;
                  metlifeDatePicker.createYearsList(date_picker_ele, months_ele_year);
                  metlifeDatePicker.populateDates(dates_ele,month,months_ele_year,selectedDay,days_ele,month_ele);
                  if(date_picker_ele.attr("data-disabled-dates")!= null && date_picker_ele.attr("data-disabled-dates")!= null){
                     metlifeDatePicker.disableDates(date_picker_ele);
                  }
              }
              if($(this).attr("data-selection-type")=="years"){
                   years_selection=years_selection +12;
                   metlifeDatePicker.createYearsList(date_picker_ele, years_selection);
                   years_ele.text(years_selection-11 + " - " + years_selection);

              }
        }).keyup(function (e) {
              var key = e.keyCode;
              if ((key == 32) || (key == 13)) {  // trigger click with the enter key or space bar
                  $(this).trigger("click");
              }
              if(e.keyCode == 27) {
                  if($(".date-picker-wrapper").hasClass("active")){
                      $(".date-picker-wrapper").removeClass('active');
                      $(".date-picker-wrapper").removeClass('bounceInDown');
                      $(".date-picker-calendar span").text($(".date-picker-calendar").attr("data-close-text"));
                      $(".date-picker-calendar span").attr($(".date-picker-calendar").attr("aria-expanded","false"));
                  }
              }

        });

        $(".month-item.clickable").click(function(e){

            var parent = $(this).closest(".date-picker-metlife");
            var date_picker_ele = parent.find(".date-picker-wrapper");
            var month_ele = parent.find(".months-group .month-item");
            var months_ele = parent.find(".months-group .months-items");
            $(this).addClass("hidden");
            parent.find(".abbrv-day-group").addClass("hidden");
            parent.find(".days-container").addClass("hidden");
            parent.find(".arrows.prev-month").attr("aria-label", parent.find(".arrows.prev-month").attr("data-prev-year-aria"));
            parent.find(".arrows.next-month").attr("aria-label", parent.find(".arrows.next-month").attr("data-next-year-aria"));
            $(".months-group .arrows").attr("data-selection-type","months");
            months_ele.removeClass("hidden");
            parent.find(".months-container").removeClass("hidden");

        }).keydown(function (e) {
              var key = e.keyCode;
              if ((key == 32) || (key == 13)) {  // trigger click with the enter key or space bar
                  $(this).trigger("click");
              }
              if(e.keyCode == 27) {
                  if($(".date-picker-wrapper").hasClass("active")){
                      $(".date-picker-wrapper").removeClass('active');
                      $(".date-picker-wrapper").removeClass('bounceInDown');
                      $(".date-picker-calendar span").text($(".date-picker-calendar").attr("data-close-text"));
                      $(".date-picker-calendar span").attr($(".date-picker-calendar").attr("aria-expanded","false"));
                  }
              }

        });

        $(".months-items.clickable").click(function(e){

            var parent = $(this).closest(".date-picker-metlife");
            var date_picker_ele = parent.find(".date-picker-wrapper");
            var months_ele = parent.find(".months-group .months-items");
            var currentSelectedYear = date_picker_ele.attr("data-year-current");
            var years_ele = parent.find(".months-group .year-items");
            metlifeDatePicker.createYearsList(date_picker_ele,currentSelectedYear);
            years_ele.text(currentSelectedYear-11 + " - " + currentSelectedYear);
            $(this).addClass("hidden");
            parent.attr("data-selection-type","years");
            parent.find(".arrows.prev-month").attr("aria-label", parent.find(".arrows.prev-month").attr("data-prev-year-group-aria"));
            parent.find(".arrows.next-month").attr("aria-label", parent.find(".arrows.next-month").attr("data-next-year-group-aria"));
            months_ele.addClass("hidden");
            years_ele.removeClass("hidden");
            parent.find(".months-container").addClass("hidden");
            parent.find(".years-container").removeClass("hidden");

        }).keydown(function (e) {
              var key = e.keyCode;
              if ((key == 32) || (key == 13)) {  // trigger click with the enter key or space bar
                  $(this).trigger("click");
              }
              if(e.keyCode == 27) {
                  if($(".date-picker-wrapper").hasClass("active")){
                      $(".date-picker-wrapper").removeClass('active');
                      $(".date-picker-wrapper").removeClass('bounceInDown');
                      $(".date-picker-calendar span").text($(".date-picker-calendar").attr("data-close-text"));
                      $(".date-picker-calendar span").attr($(".date-picker-calendar").attr("aria-expanded","false"));
                  }
              }

        });

        $(document).on('click','.months-container .month',function(e){

            var parent = $(this).closest(".date-picker-metlife");
            var date_picker_ele = parent.find(".date-picker-wrapper");
            var year_ele = parent.find(".months-group .year-items");
            parent.find(".months-container .month").removeClass("selected");
            $(this).addClass("selected");
            date_picker_ele.attr("data-month-current",$(this).attr("value"));

        }).on('keydown','.months-container .month',function(e) {
              var key = e.keyCode;
              if ((key == 32) || (key == 13)) {  // trigger click with the enter key or space bar
                  $(this).trigger("click");
              }
              if($(this).is(':last-child') && key == 9 && !e.shiftKey){
                e.preventDefault();
             }
             if(e.keyCode == 27) {
                 if($(".date-picker-wrapper").hasClass("active")){
                     $(".date-picker-wrapper").removeClass('active');
                     $(".date-picker-wrapper").removeClass('bounceInDown');
                     $(".date-picker-calendar span").text($(".date-picker-calendar").attr("data-close-text"));
                     $(".date-picker-calendar span").attr($(".date-picker-calendar").attr("aria-expanded","false"));
                 }
             }

        });

        $(".year-items.clickable").click(function(e){

            var parent = $(this).closest(".date-picker-metlife");
            var date_picker_ele = parent.find(".date-picker-wrapper");
            var month_ele = parent.find(".months-group .month-item");
            var dates_ele  = parent.find(".dates-container");
             var days_ele = parent.find(".days-container");
            var year_ele = parent.find(".months-group .year-items");
            var months = date_picker_ele.attr("data-months-name").split(",");
            parent.find(".abbrv-day-group").removeClass("hidden");
            parent.find(".days-container").removeClass("hidden");
            parent.find(".arrows.prev-month").attr("aria-label", parent.find(".arrows.prev-month").attr("data-prev-month-aria"));
            parent.find(".arrows.next-month").attr("aria-label", parent.find(".arrows.next-month").attr("data-next-month-aria"));
            parent.attr("data-selection-type","day");
            year_ele.addClass("hidden");
            month_ele.removeClass("hidden");
            parent.find(".years-container").addClass("hidden");
            metlifeDatePicker.populateDates(dates_ele,date_picker_ele.attr("data-month-current"),date_picker_ele.attr("data-year-current"),date_picker_ele.attr("data-day-current"),days_ele,month_ele);
            if(date_picker_ele.attr("data-disabled-dates")!= null && date_picker_ele.attr("data-disabled-dates")!= null){
               metlifeDatePicker.disableDates(date_picker_ele);
            }

        }).keyup(function (e) {
              var key = e.keyCode;
              if ((key == 32) || (key == 13)) {  // trigger click with the enter key or space bar
                  $(this).trigger("click");
              }
              if(e.keyCode == 27) {
                  if($(".date-picker-wrapper").hasClass("active")){
                      $(".date-picker-wrapper").removeClass('active');
                      $(".date-picker-wrapper").removeClass('bounceInDown');
                      $(".date-picker-calendar span").text($(".date-picker-calendar").attr("data-close-text"));
                      $(".date-picker-calendar span").attr($(".date-picker-calendar").attr("aria-expanded","false"));
                  }
              }

        });

        $(document).on('click','.years-container .year',function(e){

            var parent = $(this).closest(".date-picker-metlife");
            var date_picker_ele = parent.find(".date-picker-wrapper");
            var year_ele = parent.find(".months-group .year-items");
            parent.find(".years-container .year").removeClass("selected");
            $(this).addClass("selected");
            date_picker_ele.attr("data-year-current", $(this).attr("value"));

        }).on('keydown','.years-container .year',function(e){
              var key = e.keyCode;
              if ((key == 32) || (key == 13)) {  // trigger click with the enter key or space bar
                  $(this).trigger("click");
              }
              if($(this).is(':last-child') && key == 9 && !e.shiftKey){
                e.preventDefault();
             }
             if(e.keyCode == 27) {
                 if($(".date-picker-wrapper").hasClass("active")){
                     $(".date-picker-wrapper").removeClass('active');
                     $(".date-picker-wrapper").removeClass('bounceInDown');
                     $(".date-picker-calendar span").text($(".date-picker-calendar").attr("data-close-text"));
                     $(".date-picker-calendar span").attr($(".date-picker-calendar").attr("aria-expanded","false"));
                 }
             }
        });

        //need keyup to populate dates
        //need to handle the
        $(document).on("click",".date-picker-wrapper:not(.date-ranged-enable) .day",function(e){
            e.stopPropagation();
            metlifeDatePicker.daySelection($(this));
        });

         $(document).on("keydown",".date-picker-wrapper:not(.date-ranged-enable) .day",function(e){
            e.stopPropagation();
             var key = e.keyCode;
              if ((key == 32) || (key == 13)) {  // trigger click with the enter key or space bar
                  metlifeDatePicker.daySelection($(this));
              }
              if($(this).is(':last-child') && key == 9 && !e.shiftKey){
                e.preventDefault();
             }
             if(e.keyCode == 27) {
                 if($(".date-picker-wrapper").hasClass("active")){
                     $(".date-picker-wrapper").removeClass('active');
                     $(".date-picker-wrapper").removeClass('bounceInDown');
                     $(".date-picker-calendar span").text($(".date-picker-calendar").attr("data-close-text"));
                     $(".date-picker-calendar span").attr($(".date-picker-calendar").attr("aria-expanded","false"));
                 }
             }
        });


        $(document).on("click",".date-picker-wrapper.date-ranged-enable .day",function(e){
            e.stopPropagation();
            var date_picker_ele = $(this).closest(".date-picker-metlife").find(".date-picker-wrapper");
            var isSelected = false;
            if($(".date-picker-wrapper.date-ranged-enable .day.min-value").length==1 && date_picker_ele.attr("data-min-value")!="" && $(".date-picker-wrapper.date-ranged-enable .day.max-value").length<1){
                isSelected = true;
            }
            metlifeDatePicker.rangeDaySelection($(this),isSelected);
        });

         $(document).on("keydown",".date-picker-wrapper.date-ranged-enable .day",function(e){
            e.stopPropagation();
             var key = e.keyCode;
              if ((key == 32) || (key == 13)) {  // trigger click with the enter key or space bar
                  $(this).click();
              }
              if($(this).is(':last-child') && $(this).closest(".days-container-range").length == 1 && key == 9 && !e.shiftKey){
                e.preventDefault();
             }
             if(e.keyCode == 27) {
                 if($(".date-picker-wrapper").hasClass("active")){
                     $(".date-picker-wrapper").removeClass('active');
                     $(".date-picker-wrapper").removeClass('bounceInDown');
                     $(".date-picker-calendar span").text($(".date-picker-calendar").attr("data-close-text"));
                     $(".date-picker-calendar span").attr($(".date-picker-calendar").attr("aria-expanded","false"));
                 }
             }
        });

});

